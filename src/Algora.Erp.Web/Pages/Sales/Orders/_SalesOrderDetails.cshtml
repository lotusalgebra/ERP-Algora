@model Algora.Erp.Domain.Entities.Sales.SalesOrder
@using Algora.Erp.Domain.Entities.Sales

@{
    var statusColor = Model.Status switch
    {
        SalesOrderStatus.Draft => "secondary",
        SalesOrderStatus.Confirmed => "primary",
        SalesOrderStatus.PartiallyShipped => "info",
        SalesOrderStatus.Shipped => "info",
        SalesOrderStatus.Delivered => "success",
        SalesOrderStatus.Paid => "success",
        SalesOrderStatus.Cancelled => "danger",
        _ => "secondary"
    };
}

<div class="row g-4">
    <!-- Header -->
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-start">
            <div>
                <h4 class="mb-1">@Model.OrderNumber</h4>
                @if (!string.IsNullOrEmpty(Model.Reference))
                {
                    <p class="text-muted mb-0">Reference: @Model.Reference</p>
                }
            </div>
            <span class="badge bg-@statusColor fs-6">@Model.Status</span>
        </div>
    </div>

    <!-- Order Info -->
    <div class="col-md-6">
        <div class="card border-0 bg-light h-100">
            <div class="card-body">
                <h6 class="text-muted text-uppercase small mb-3">Order Information</h6>
                <div class="row g-2">
                    <div class="col-6">
                        <small class="text-muted d-block">Order Type</small>
                        <span>@Model.OrderType</span>
                    </div>
                    <div class="col-6">
                        <small class="text-muted d-block">Currency</small>
                        <span>@Model.Currency</span>
                    </div>
                    <div class="col-6">
                        <small class="text-muted d-block">Order Date</small>
                        <span>@Model.OrderDate.ToString("MMM dd, yyyy")</span>
                    </div>
                    <div class="col-6">
                        <small class="text-muted d-block">Due Date</small>
                        <span>@(Model.DueDate?.ToString("MMM dd, yyyy") ?? "-")</span>
                    </div>
                    <div class="col-6">
                        <small class="text-muted d-block">Expected Delivery</small>
                        <span>@(Model.ExpectedDeliveryDate?.ToString("MMM dd, yyyy") ?? "-")</span>
                    </div>
                    <div class="col-6">
                        <small class="text-muted d-block">Shipping Method</small>
                        <span>@(Model.ShippingMethod ?? "-")</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Customer Info -->
    <div class="col-md-6">
        <div class="card border-0 bg-light h-100">
            <div class="card-body">
                <h6 class="text-muted text-uppercase small mb-3">Customer</h6>
                @if (Model.Customer != null)
                {
                    <div class="fw-medium mb-2">@Model.Customer.Name</div>
                    <div class="row g-2">
                        <div class="col-12">
                            <small class="text-muted d-block">Contact</small>
                            <span>@(Model.Customer.ContactPerson ?? "-")</span>
                        </div>
                        @if (!string.IsNullOrEmpty(Model.Customer.Email))
                        {
                            <div class="col-12">
                                <small class="text-muted d-block">Email</small>
                                <a href="mailto:@Model.Customer.Email">@Model.Customer.Email</a>
                            </div>
                        }
                        @if (!string.IsNullOrEmpty(Model.Customer.Phone))
                        {
                            <div class="col-12">
                                <small class="text-muted d-block">Phone</small>
                                <span>@Model.Customer.Phone</span>
                            </div>
                        }
                    </div>
                }
            </div>
        </div>
    </div>

    <!-- Shipping Address -->
    @if (!string.IsNullOrEmpty(Model.ShippingAddress))
    {
        <div class="col-12">
            <div class="card border-0 bg-light">
                <div class="card-body">
                    <h6 class="text-muted text-uppercase small mb-3">Shipping Address</h6>
                    <p class="mb-0" style="white-space: pre-line">@Model.ShippingAddress</p>
                </div>
            </div>
        </div>
    }

    <!-- Order Lines -->
    <div class="col-12">
        <h6 class="text-muted text-uppercase small mb-3">Order Lines</h6>
        <div class="table-responsive">
            <table class="table table-sm table-bordered">
                <thead class="bg-light">
                    <tr>
                        <th style="width: 5%">#</th>
                        <th>Product</th>
                        <th class="text-center" style="width: 10%">Qty</th>
                        <th class="text-end" style="width: 12%">Unit Price</th>
                        <th class="text-center" style="width: 8%">Disc %</th>
                        <th class="text-center" style="width: 8%">Tax %</th>
                        <th class="text-end" style="width: 12%">Total</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var line in Model.Lines.OrderBy(l => l.LineNumber))
                    {
                        <tr>
                            <td class="text-center">@line.LineNumber</td>
                            <td>
                                <div class="fw-medium">@line.ProductName</div>
                                @if (!string.IsNullOrEmpty(line.ProductSku))
                                {
                                    <small class="text-muted">SKU: @line.ProductSku</small>
                                }
                            </td>
                            <td class="text-center">@line.Quantity @line.UnitOfMeasure</td>
                            <td class="text-end">@line.UnitPrice.ToString("C2")</td>
                            <td class="text-center">@line.DiscountPercent%</td>
                            <td class="text-center">@line.TaxPercent%</td>
                            <td class="text-end fw-medium">@line.LineTotal.ToString("C2")</td>
                        </tr>
                    }
                </tbody>
                <tfoot class="bg-light">
                    <tr>
                        <td colspan="6" class="text-end">Subtotal:</td>
                        <td class="text-end">@Model.SubTotal.ToString("C2")</td>
                    </tr>
                    <tr>
                        <td colspan="6" class="text-end">Tax:</td>
                        <td class="text-end">@Model.TaxAmount.ToString("C2")</td>
                    </tr>
                    @if (Model.ShippingAmount > 0)
                    {
                        <tr>
                            <td colspan="6" class="text-end">Shipping:</td>
                            <td class="text-end">@Model.ShippingAmount.ToString("C2")</td>
                        </tr>
                    }
                    @if (Model.DiscountAmount > 0)
                    {
                        <tr>
                            <td colspan="6" class="text-end">Discount:</td>
                            <td class="text-end text-danger">-@Model.DiscountAmount.ToString("C2")</td>
                        </tr>
                    }
                    <tr class="fw-bold">
                        <td colspan="6" class="text-end">Total:</td>
                        <td class="text-end">@Model.TotalAmount.ToString("C2")</td>
                    </tr>
                    @if (Model.AmountPaid > 0)
                    {
                        <tr>
                            <td colspan="6" class="text-end">Amount Paid:</td>
                            <td class="text-end text-success">@Model.AmountPaid.ToString("C2")</td>
                        </tr>
                        <tr class="fw-bold">
                            <td colspan="6" class="text-end">Amount Due:</td>
                            <td class="text-end @(Model.AmountDue > 0 ? "text-danger" : "text-success")">
                                @Model.AmountDue.ToString("C2")
                            </td>
                        </tr>
                    }
                </tfoot>
            </table>
        </div>
    </div>

    <!-- Notes -->
    @if (!string.IsNullOrEmpty(Model.Notes))
    {
        <div class="col-12">
            <div class="card border-0 bg-light">
                <div class="card-body">
                    <h6 class="text-muted text-uppercase small mb-3">Notes</h6>
                    <p class="mb-0" style="white-space: pre-line">@Model.Notes</p>
                </div>
            </div>
        </div>
    }

    <!-- Timestamps -->
    <div class="col-12">
        <div class="text-muted small">
            <span>Created: @Model.CreatedAt.ToString("MMM dd, yyyy HH:mm")</span>
            @if (Model.ModifiedAt.HasValue)
            {
                <span class="ms-3">Modified: @Model.ModifiedAt.Value.ToString("MMM dd, yyyy HH:mm")</span>
            }
        </div>
    </div>
</div>

<div class="modal-footer px-0 pb-0 mt-4">
    <button type="button" class="btn btn-secondary" data-modal-hide="detailsModal">Close</button>
    @if (Model.Status == SalesOrderStatus.Draft)
    {
        <button type="button" class="btn btn-primary"
                hx-get="?handler=EditForm&id=@Model.Id"
                hx-target="#formModalBody"
                data-modal-target="formModal" data-modal-toggle="formModal">
            <i class="bi bi-pencil me-2"></i>Edit Order
        </button>
    }
</div>
