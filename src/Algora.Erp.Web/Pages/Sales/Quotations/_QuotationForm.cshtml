@model Algora.Erp.Web.Pages.Sales.Quotations.QuotationFormViewModel

<form hx-post="?handler=" hx-target="#quotationsTableBody" hx-swap="innerHTML">
    @if (Model.IsEdit)
    {
        <input type="hidden" name="Id" value="@Model.Quotation?.Id" />
    }

    <div class="grid grid-cols-12 gap-3">
        <!-- Customer Selection -->
        <div class="col-span-12 md:col-span-6">
            <label class="block mb-2 text-sm font-medium text-gray-900">Customer <span class="text-red-600">*</span></label>
            <select class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5" name="CustomerId" required>
                <option value="">Select Customer</option>
                @foreach (var customer in Model.Customers)
                {
                    if (Model.Quotation?.CustomerId == customer.Id)
                    {
                        <option value="@customer.Id" selected>@customer.Name</option>
                    }
                    else
                    {
                        <option value="@customer.Id">@customer.Name</option>
                    }
                }
            </select>
        </div>

        <div class="col-span-12 md:col-span-3">
            <label class="block mb-2 text-sm font-medium text-gray-900">Quote Date <span class="text-red-600">*</span></label>
            <input type="date" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5" name="QuoteDate"
                   value="@(Model.Quotation?.OrderDate.ToString("yyyy-MM-dd") ?? DateTime.Today.ToString("yyyy-MM-dd"))" required />
        </div>

        <div class="col-span-12 md:col-span-3">
            <label class="block mb-2 text-sm font-medium text-gray-900">Valid Until</label>
            <input type="date" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5" name="ValidUntil"
                   value="@Model.Quotation?.DueDate?.ToString("yyyy-MM-dd")" />
        </div>

        <div class="col-span-12 md:col-span-4">
            <label class="block mb-2 text-sm font-medium text-gray-900">Reference</label>
            <input type="text" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5" name="Reference"
                   value="@Model.Quotation?.Reference" placeholder="e.g., RFQ-2024-001" />
        </div>

        <div class="col-span-12 md:col-span-4">
            <label class="block mb-2 text-sm font-medium text-gray-900">Currency</label>
            @{
                var currency = Model.Quotation?.Currency ?? "USD";
            }
            <select class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5" name="Currency">
                @if (currency == "USD") { <option value="USD" selected>USD - US Dollar</option> }
                else { <option value="USD">USD - US Dollar</option> }
                @if (currency == "EUR") { <option value="EUR" selected>EUR - Euro</option> }
                else { <option value="EUR">EUR - Euro</option> }
                @if (currency == "GBP") { <option value="GBP" selected>GBP - British Pound</option> }
                else { <option value="GBP">GBP - British Pound</option> }
            </select>
        </div>

        <div class="col-span-12 md:col-span-4">
            <label class="block mb-2 text-sm font-medium text-gray-900">Status</label>
            @{
                var isDraft = Model.Quotation?.Status == Algora.Erp.Domain.Entities.Sales.SalesOrderStatus.Draft || Model.Quotation == null;
                var isSent = Model.Quotation?.Status == Algora.Erp.Domain.Entities.Sales.SalesOrderStatus.Confirmed;
            }
            <select class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5" name="Status">
                @if (isDraft) { <option value="Draft" selected>Draft</option> }
                else { <option value="Draft">Draft</option> }
                @if (Model.IsEdit)
                {
                    @if (isSent) { <option value="Confirmed" selected>Sent</option> }
                    else { <option value="Confirmed">Sent</option> }
                }
            </select>
        </div>
    </div>

    <!-- Line Items -->
    <div class="mt-4">
        <h6 class="font-medium text-gray-900 mb-3">
            <i class="bi bi-list-ul mr-2"></i>Line Items
        </h6>
        <div class="overflow-x-auto">
            <table class="w-full text-sm text-left" id="quotationLinesTable">
                <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                    <tr>
                        <th style="width: 35%" class="px-4 py-3">Product</th>
                        <th style="width: 10%" class="px-4 py-3">Qty</th>
                        <th style="width: 15%" class="px-4 py-3">Unit Price</th>
                        <th style="width: 10%" class="px-4 py-3">Disc %</th>
                        <th style="width: 10%" class="px-4 py-3">Tax %</th>
                        <th style="width: 15%" class="px-4 py-3 text-right">Line Total</th>
                        <th style="width: 5%" class="px-4 py-3"></th>
                    </tr>
                </thead>
                <tbody id="quotationLinesBody">
                    @if (Model.Quotation?.Lines?.Any() == true)
                    {
                        var index = 0;
                        @foreach (var line in Model.Quotation.Lines.OrderBy(l => l.LineNumber))
                        {
                            <tr class="quote-line-row border-b border-gray-200">
                                <td class="px-4 py-2">
                                    <select class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2 product-select" name="Lines[@index].ProductId" onchange="updateLinePrice(this)">
                                        <option value="">Select Product</option>
                                        @foreach (var product in Model.Products)
                                        {
                                            if (line.ProductId == product.Id)
                                            {
                                                <option value="@product.Id" data-price="@product.SellingPrice" selected>@product.Name (@product.Sku)</option>
                                            }
                                            else
                                            {
                                                <option value="@product.Id" data-price="@product.SellingPrice">@product.Name (@product.Sku)</option>
                                            }
                                        }
                                    </select>
                                </td>
                                <td class="px-4 py-2">
                                    <input type="number" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2 qty-input" name="Lines[@index].Quantity"
                                           value="@line.Quantity" min="1" step="1" onchange="calculateLineTotal(this)" />
                                </td>
                                <td class="px-4 py-2">
                                    <input type="number" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2 price-input" name="Lines[@index].UnitPrice"
                                           value="@line.UnitPrice" min="0" step="0.01" onchange="calculateLineTotal(this)" />
                                </td>
                                <td class="px-4 py-2">
                                    <input type="number" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2 disc-input" name="Lines[@index].DiscountPercent"
                                           value="@line.DiscountPercent" min="0" max="100" step="0.1" onchange="calculateLineTotal(this)" />
                                </td>
                                <td class="px-4 py-2">
                                    <input type="number" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2 tax-input" name="Lines[@index].TaxPercent"
                                           value="@line.TaxPercent" min="0" max="100" step="0.1" onchange="calculateLineTotal(this)" />
                                </td>
                                <td class="px-4 py-2 text-right line-total font-medium">@line.LineTotal.ToString("C2")</td>
                                <td class="px-4 py-2">
                                    <button type="button" class="text-red-700 border border-red-700 hover:bg-red-700 hover:text-white focus:ring-4 focus:ring-red-300 font-medium rounded-lg text-xs px-3 py-2" onclick="removeLine(this)">
                                        <i class="bi bi-x"></i>
                                    </button>
                                </td>
                            </tr>
                            index++;
                        }
                    }
                    else
                    {
                        <tr class="quote-line-row border-b border-gray-200">
                            <td class="px-4 py-2">
                                <select class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2 product-select" name="Lines[0].ProductId" onchange="updateLinePrice(this)">
                                    <option value="">Select Product</option>
                                    @foreach (var product in Model.Products)
                                    {
                                        <option value="@product.Id" data-price="@product.SellingPrice">@product.Name (@product.Sku)</option>
                                    }
                                </select>
                            </td>
                            <td class="px-4 py-2">
                                <input type="number" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2 qty-input" name="Lines[0].Quantity" value="1" min="1" step="1" onchange="calculateLineTotal(this)" />
                            </td>
                            <td class="px-4 py-2">
                                <input type="number" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2 price-input" name="Lines[0].UnitPrice" value="0" min="0" step="0.01" onchange="calculateLineTotal(this)" />
                            </td>
                            <td class="px-4 py-2">
                                <input type="number" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2 disc-input" name="Lines[0].DiscountPercent" value="0" min="0" max="100" step="0.1" onchange="calculateLineTotal(this)" />
                            </td>
                            <td class="px-4 py-2">
                                <input type="number" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2 tax-input" name="Lines[0].TaxPercent" value="0" min="0" max="100" step="0.1" onchange="calculateLineTotal(this)" />
                            </td>
                            <td class="px-4 py-2 text-right line-total font-medium">$0.00</td>
                            <td class="px-4 py-2">
                                <button type="button" class="text-red-700 border border-red-700 hover:bg-red-700 hover:text-white focus:ring-4 focus:ring-red-300 font-medium rounded-lg text-xs px-3 py-2" onclick="removeLine(this)">
                                    <i class="bi bi-x"></i>
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
        <button type="button" class="text-primary-700 border border-primary-700 hover:bg-primary-700 hover:text-white focus:ring-4 focus:ring-primary-300 font-medium rounded-lg text-xs px-3 py-2 mt-3" onclick="addLine()">
            <i class="bi bi-plus-lg mr-1"></i>Add Line
        </button>
    </div>

    <!-- Totals -->
    <div class="grid grid-cols-12 gap-4 mt-4">
        <div class="col-span-12 md:col-span-6">
            <label class="block mb-2 text-sm font-medium text-gray-900">Notes</label>
            <textarea class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5" name="Notes" rows="3" placeholder="Additional notes or terms...">@Model.Quotation?.Notes</textarea>
        </div>
        <div class="col-span-12 md:col-span-6">
            <div class="bg-gray-50 rounded-lg shadow-md">
                <div class="p-6">
                    <div class="flex justify-between mb-2">
                        <span class="text-gray-700">Subtotal:</span>
                        <span class="font-medium" id="subtotalDisplay">$0.00</span>
                    </div>
                    <div class="flex justify-between mb-2">
                        <span class="text-gray-700">Tax:</span>
                        <span class="font-medium" id="taxDisplay">$0.00</span>
                    </div>
                    <div class="flex justify-between mb-2">
                        <div>
                            <label class="block mb-0 text-sm font-medium text-gray-900">Discount:</label>
                        </div>
                        <div style="width: 120px">
                            <input type="number" class="bg-white border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2 text-right" name="DiscountAmount"
                                   value="@(Model.Quotation?.DiscountAmount ?? 0)" min="0" step="0.01" onchange="calculateTotals()" id="discountInput" />
                        </div>
                    </div>
                    <hr class="my-2 border-gray-200" />
                    <div class="flex justify-between">
                        <span class="font-bold text-gray-900">Total:</span>
                        <span class="font-bold text-xl text-gray-900" id="totalDisplay">$0.00</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="flex items-center justify-end p-4 border-t border-gray-200 rounded-b gap-2 mt-4 -mx-4 -mb-4">
        <button type="button" class="text-gray-900 bg-white border border-gray-300 hover:bg-gray-100 focus:ring-4 focus:ring-gray-200 font-medium rounded-lg text-sm px-5 py-2.5" data-modal-hide="quotationModal">Cancel</button>
        <button type="submit" class="text-white bg-primary-600 hover:bg-primary-700 focus:ring-4 focus:ring-primary-300 font-medium rounded-lg text-sm px-5 py-2.5">
            <i class="bi bi-check-lg mr-1"></i>@(Model.IsEdit ? "Update" : "Create") Quotation
        </button>
    </div>
</form>

<script>
    let lineIndex = @(Model.Quotation?.Lines?.Count ?? 1);
    const productsData = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Products.Select(p => new { p.Id, p.Name, p.Sku, p.SellingPrice })));

    function addLine() {
        const tbody = document.getElementById('quotationLinesBody');
        const row = document.createElement('tr');
        row.className = 'quote-line-row border-b border-gray-200';
        row.innerHTML = `
            <td class="px-4 py-2">
                <select class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2 product-select" name="Lines[${lineIndex}].ProductId" onchange="updateLinePrice(this)">
                    <option value="">Select Product</option>
                    ${productsData.map(p => `<option value="${p.Id}" data-price="${p.SellingPrice}">${p.Name} (${p.Sku})</option>`).join('')}
                </select>
            </td>
            <td class="px-4 py-2">
                <input type="number" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2 qty-input" name="Lines[${lineIndex}].Quantity" value="1" min="1" step="1" onchange="calculateLineTotal(this)" />
            </td>
            <td class="px-4 py-2">
                <input type="number" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2 price-input" name="Lines[${lineIndex}].UnitPrice" value="0" min="0" step="0.01" onchange="calculateLineTotal(this)" />
            </td>
            <td class="px-4 py-2">
                <input type="number" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2 disc-input" name="Lines[${lineIndex}].DiscountPercent" value="0" min="0" max="100" step="0.1" onchange="calculateLineTotal(this)" />
            </td>
            <td class="px-4 py-2">
                <input type="number" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2 tax-input" name="Lines[${lineIndex}].TaxPercent" value="0" min="0" max="100" step="0.1" onchange="calculateLineTotal(this)" />
            </td>
            <td class="px-4 py-2 text-right line-total font-medium">$0.00</td>
            <td class="px-4 py-2">
                <button type="button" class="text-red-700 border border-red-700 hover:bg-red-700 hover:text-white focus:ring-4 focus:ring-red-300 font-medium rounded-lg text-xs px-3 py-2" onclick="removeLine(this)">
                    <i class="bi bi-x"></i>
                </button>
            </td>
        `;
        tbody.appendChild(row);
        lineIndex++;
    }

    function removeLine(btn) {
        const row = btn.closest('tr');
        row.remove();
        calculateTotals();
    }

    function updateLinePrice(select) {
        const row = select.closest('tr');
        const option = select.options[select.selectedIndex];
        const price = option.dataset.price || 0;
        row.querySelector('.price-input').value = parseFloat(price).toFixed(2);
        calculateLineTotal(select);
    }

    function calculateLineTotal(input) {
        const row = input.closest('tr');
        const qty = parseFloat(row.querySelector('.qty-input').value) || 0;
        const price = parseFloat(row.querySelector('.price-input').value) || 0;
        const disc = parseFloat(row.querySelector('.disc-input').value) || 0;
        const tax = parseFloat(row.querySelector('.tax-input').value) || 0;

        const subtotal = qty * price * (1 - disc / 100);
        const taxAmount = subtotal * tax / 100;
        const total = subtotal + taxAmount;

        row.querySelector('.line-total').textContent = '$' + total.toFixed(2);
        calculateTotals();
    }

    function calculateTotals() {
        let subtotal = 0;
        let taxTotal = 0;

        document.querySelectorAll('.quote-line-row').forEach(row => {
            const qty = parseFloat(row.querySelector('.qty-input').value) || 0;
            const price = parseFloat(row.querySelector('.price-input').value) || 0;
            const disc = parseFloat(row.querySelector('.disc-input').value) || 0;
            const tax = parseFloat(row.querySelector('.tax-input').value) || 0;

            const lineSubtotal = qty * price * (1 - disc / 100);
            const lineTax = lineSubtotal * tax / 100;

            subtotal += lineSubtotal;
            taxTotal += lineTax;
        });

        const discount = parseFloat(document.getElementById('discountInput').value) || 0;
        const total = subtotal + taxTotal - discount;

        document.getElementById('subtotalDisplay').textContent = '$' + subtotal.toFixed(2);
        document.getElementById('taxDisplay').textContent = '$' + taxTotal.toFixed(2);
        document.getElementById('totalDisplay').textContent = '$' + total.toFixed(2);
    }

    // Calculate on load
    calculateTotals();
</script>
