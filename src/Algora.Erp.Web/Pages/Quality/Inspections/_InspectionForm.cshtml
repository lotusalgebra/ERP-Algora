@model Algora.Erp.Web.Pages.Quality.Inspections.InspectionFormViewModel
@using Algora.Erp.Domain.Entities.Quality

<form hx-post="?handler=" hx-target="#inspectionsTableBody" hx-swap="innerHTML">
    @if (Model.IsEdit && Model.Inspection != null)
    {
        <input type="hidden" name="Id" value="@Model.Inspection.Id" />
    }

    <div class="row g-3">
        <!-- Left Column -->
        <div class="col-md-6">
            <div class="card mb-3">
                <div class="card-header bg-light">
                    <h6 class="mb-0">Inspection Information</h6>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">Inspection Date <span class="text-danger">*</span></label>
                        <input type="date" class="form-control" name="InspectionDate"
                               value="@(Model.Inspection?.InspectionDate.ToString("yyyy-MM-dd") ?? DateTime.Today.ToString("yyyy-MM-dd"))" required />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Inspection Type <span class="text-danger">*</span></label>
                        <select class="form-select" name="InspectionType" required>
                            @foreach (var type in Enum.GetValues<InspectionType>())
                            {
                                if (Model.Inspection?.InspectionType == type)
                                {
                                    <option value="@type" selected>@type</option>
                                }
                                else
                                {
                                    <option value="@type">@type</option>
                                }
                            }
                        </select>
                    </div>
                    @if (Model.PendingGrns?.Any() == true || Model.SelectedGrn != null)
                    {
                        <div class="mb-3">
                            <label class="form-label">Source: Goods Receipt Note</label>
                            <select class="form-select" name="SourceDocumentId" id="grnSelect" onchange="loadGrnDetails(this.value)">
                                <option value="">-- Select GRN --</option>
                                @foreach (var grn in Model.PendingGrns ?? new List<Algora.Erp.Domain.Entities.Procurement.GoodsReceiptNote>())
                                {
                                    var isSelected = Model.SelectedGrn?.Id == grn.Id || Model.Inspection?.SourceDocumentId == grn.Id;
                                    if (isSelected)
                                    {
                                        <option value="@grn.Id" data-number="@grn.GrnNumber" data-warehouse="@grn.WarehouseId" data-supplier="@grn.SupplierId" selected>
                                            @grn.GrnNumber - @grn.SupplierName (@grn.GrnDate.ToString("dd MMM"))
                                        </option>
                                    }
                                    else
                                    {
                                        <option value="@grn.Id" data-number="@grn.GrnNumber" data-warehouse="@grn.WarehouseId" data-supplier="@grn.SupplierId">
                                            @grn.GrnNumber - @grn.SupplierName (@grn.GrnDate.ToString("dd MMM"))
                                        </option>
                                    }
                                }
                            </select>
                            <input type="hidden" name="SourceDocumentType" value="GoodsReceipt" id="sourceDocumentType" />
                            <input type="hidden" name="SourceDocumentNumber" id="sourceDocumentNumber"
                                   value="@(Model.SelectedGrn?.GrnNumber ?? Model.Inspection?.SourceDocumentNumber)" />
                        </div>
                    }
                    else
                    {
                        <div class="mb-3">
                            <label class="form-label">Source Document Type</label>
                            <input type="text" class="form-control" name="SourceDocumentType"
                                   value="@Model.Inspection?.SourceDocumentType" />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Source Document Number</label>
                            <input type="text" class="form-control" name="SourceDocumentNumber"
                                   value="@Model.Inspection?.SourceDocumentNumber" />
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- Right Column -->
        <div class="col-md-6">
            <div class="card mb-3">
                <div class="card-header bg-light">
                    <h6 class="mb-0">Product & Location</h6>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">Product <span class="text-danger">*</span></label>
                        <select class="form-select" name="ProductId" id="productSelect" required>
                            <option value="">-- Select Product --</option>
                            @foreach (var product in Model.Products)
                            {
                                if (Model.Inspection?.ProductId == product.Id)
                                {
                                    <option value="@product.Id" selected>@product.Name (@product.Sku)</option>
                                }
                                else
                                {
                                    <option value="@product.Id">@product.Name (@product.Sku)</option>
                                }
                            }
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Warehouse <span class="text-danger">*</span></label>
                        <select class="form-select" name="WarehouseId" id="warehouseSelect" required>
                            <option value="">-- Select Warehouse --</option>
                            @foreach (var warehouse in Model.Warehouses)
                            {
                                var isSelected = Model.Inspection?.WarehouseId == warehouse.Id || Model.SelectedGrn?.WarehouseId == warehouse.Id;
                                if (isSelected)
                                {
                                    <option value="@warehouse.Id" selected>@warehouse.Name</option>
                                }
                                else
                                {
                                    <option value="@warehouse.Id">@warehouse.Name</option>
                                }
                            }
                        </select>
                    </div>
                    <input type="hidden" name="SupplierId" id="supplierId" value="@Model.SelectedGrn?.SupplierId" />
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Total Quantity</label>
                            <input type="number" class="form-control" name="TotalQuantity" step="0.01" min="0"
                                   value="@(Model.Inspection?.TotalQuantity ?? 0)" id="totalQuantity" />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Sample Size</label>
                            <input type="number" class="form-control" name="SampleSize" step="0.01" min="0"
                                   value="@(Model.Inspection?.SampleSize ?? 0)" />
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- QC Parameters -->
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">Quality Check Parameters</h6>
                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="addParameter()">
                        <i class="bi bi-plus-lg me-1"></i>Add Parameter
                    </button>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-sm align-middle mb-0" id="parametersTable">
                            <thead class="bg-light">
                                <tr>
                                    <th style="width: 20%;">Parameter Name</th>
                                    <th style="width: 15%;">Expected Value</th>
                                    <th style="width: 10%;">Min</th>
                                    <th style="width: 10%;">Max</th>
                                    <th style="width: 15%;">Actual Value</th>
                                    <th style="width: 12%;">Result</th>
                                    <th style="width: 13%;">Remarks</th>
                                    <th style="width: 5%;"></th>
                                </tr>
                            </thead>
                            <tbody id="parametersBody">
                                @if (Model.Inspection?.Parameters?.Any() == true)
                                {
                                    var idx = 0;
                                    foreach (var param in Model.Inspection.Parameters.OrderBy(p => p.SequenceNumber))
                                    {
                                        <tr class="param-row">
                                            <td>
                                                <input type="text" class="form-control form-control-sm" name="Parameters[@idx].ParameterName"
                                                       value="@param.ParameterName" required placeholder="e.g., Weight, Color" />
                                            </td>
                                            <td>
                                                <input type="text" class="form-control form-control-sm" name="Parameters[@idx].ExpectedValue"
                                                       value="@param.ExpectedValue" placeholder="Expected" />
                                            </td>
                                            <td>
                                                <input type="number" class="form-control form-control-sm" name="Parameters[@idx].MinValue"
                                                       value="@param.MinValue" step="0.001" placeholder="Min" />
                                            </td>
                                            <td>
                                                <input type="number" class="form-control form-control-sm" name="Parameters[@idx].MaxValue"
                                                       value="@param.MaxValue" step="0.001" placeholder="Max" />
                                            </td>
                                            <td>
                                                <input type="text" class="form-control form-control-sm" name="Parameters[@idx].ActualValue"
                                                       value="@param.ActualValue" placeholder="Actual" />
                                            </td>
                                            <td>
                                                <select class="form-select form-select-sm" name="Parameters[@idx].Result">
                                                    @foreach (var result in Enum.GetValues<QCParameterResult>())
                                                    {
                                                        if (param.Result == result)
                                                        {
                                                            <option value="@result" selected>@result</option>
                                                        }
                                                        else
                                                        {
                                                            <option value="@result">@result</option>
                                                        }
                                                    }
                                                </select>
                                            </td>
                                            <td>
                                                <input type="text" class="form-control form-control-sm" name="Parameters[@idx].Remarks"
                                                       value="@param.Remarks" placeholder="Notes" />
                                            </td>
                                            <td>
                                                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeParameter(this)">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </td>
                                        </tr>
                                        idx++;
                                    }
                                }
                                else
                                {
                                    <!-- Default parameters for new inspection -->
                                    <tr class="param-row">
                                        <td>
                                            <input type="text" class="form-control form-control-sm" name="Parameters[0].ParameterName"
                                                   value="Visual Inspection" required placeholder="e.g., Weight, Color" />
                                        </td>
                                        <td>
                                            <input type="text" class="form-control form-control-sm" name="Parameters[0].ExpectedValue"
                                                   value="No visible defects" placeholder="Expected" />
                                        </td>
                                        <td>
                                            <input type="number" class="form-control form-control-sm" name="Parameters[0].MinValue"
                                                   step="0.001" placeholder="Min" />
                                        </td>
                                        <td>
                                            <input type="number" class="form-control form-control-sm" name="Parameters[0].MaxValue"
                                                   step="0.001" placeholder="Max" />
                                        </td>
                                        <td>
                                            <input type="text" class="form-control form-control-sm" name="Parameters[0].ActualValue"
                                                   placeholder="Actual" />
                                        </td>
                                        <td>
                                            <select class="form-select form-select-sm" name="Parameters[0].Result">
                                                @foreach (var result in Enum.GetValues<QCParameterResult>())
                                                {
                                                    <option value="@result">@result</option>
                                                }
                                            </select>
                                        </td>
                                        <td>
                                            <input type="text" class="form-control form-control-sm" name="Parameters[0].Remarks"
                                                   placeholder="Notes" />
                                        </td>
                                        <td>
                                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeParameter(this)">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Notes -->
        <div class="col-12">
            <div class="mb-3">
                <label class="form-label">Notes</label>
                <textarea class="form-control" name="Notes" rows="2">@Model.Inspection?.Notes</textarea>
            </div>
        </div>
    </div>

    <div class="modal-footer px-0 pb-0">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" class="btn btn-primary">
            <i class="bi bi-check-lg me-2"></i>@(Model.IsEdit ? "Update" : "Create") Inspection
        </button>
    </div>
</form>

<script>
    let paramIndex = @(Model.Inspection?.Parameters?.Count ?? 1);

    function loadGrnDetails(grnId) {
        const select = document.getElementById('grnSelect');
        const option = select.options[select.selectedIndex];
        if (option && option.value) {
            document.getElementById('sourceDocumentNumber').value = option.dataset.number || '';
            document.getElementById('warehouseSelect').value = option.dataset.warehouse || '';
            document.getElementById('supplierId').value = option.dataset.supplier || '';
        }
    }

    function addParameter() {
        const html = `
            <tr class="param-row">
                <td>
                    <input type="text" class="form-control form-control-sm" name="Parameters[${paramIndex}].ParameterName"
                           required placeholder="e.g., Weight, Color" />
                </td>
                <td>
                    <input type="text" class="form-control form-control-sm" name="Parameters[${paramIndex}].ExpectedValue"
                           placeholder="Expected" />
                </td>
                <td>
                    <input type="number" class="form-control form-control-sm" name="Parameters[${paramIndex}].MinValue"
                           step="0.001" placeholder="Min" />
                </td>
                <td>
                    <input type="number" class="form-control form-control-sm" name="Parameters[${paramIndex}].MaxValue"
                           step="0.001" placeholder="Max" />
                </td>
                <td>
                    <input type="text" class="form-control form-control-sm" name="Parameters[${paramIndex}].ActualValue"
                           placeholder="Actual" />
                </td>
                <td>
                    <select class="form-select form-select-sm" name="Parameters[${paramIndex}].Result">
                        <option value="Pending">Pending</option>
                        <option value="Pass">Pass</option>
                        <option value="Fail">Fail</option>
                        <option value="Warning">Warning</option>
                        <option value="NotApplicable">N/A</option>
                    </select>
                </td>
                <td>
                    <input type="text" class="form-control form-control-sm" name="Parameters[${paramIndex}].Remarks"
                           placeholder="Notes" />
                </td>
                <td>
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeParameter(this)">
                        <i class="bi bi-trash"></i>
                    </button>
                </td>
            </tr>
        `;
        document.getElementById('parametersBody').insertAdjacentHTML('beforeend', html);
        paramIndex++;
    }

    function removeParameter(btn) {
        btn.closest('tr').remove();
        reindexParameters();
    }

    function reindexParameters() {
        const rows = document.querySelectorAll('#parametersBody .param-row');
        rows.forEach((row, idx) => {
            row.querySelectorAll('input[name], select[name]').forEach(input => {
                const name = input.name.replace(/\[\d+\]/, `[${idx}]`);
                input.name = name;
            });
        });
        paramIndex = rows.length;
    }

    // Handle form submission success
    document.querySelector('form').addEventListener('htmx:afterRequest', function(e) {
        if (e.detail.successful) {
            document.body.dispatchEvent(new CustomEvent('formSubmitSuccess'));
        }
    });

    // Auto-load GRN details if pre-selected
    @if (Model.SelectedGrn != null)
    {
        <text>loadGrnDetails('@Model.SelectedGrn.Id');</text>
    }
</script>
