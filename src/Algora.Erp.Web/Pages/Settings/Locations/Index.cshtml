@page
@model Algora.Erp.Web.Pages.Settings.Locations.IndexModel
@using Algora.Erp.Domain.Entities.Settings
@{
    ViewData["Title"] = "Office Locations";
}

<div class="container-fluid">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-1">Office Locations</h1>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-0">
                    <li class="breadcrumb-item"><a href="/">Dashboard</a></li>
                    <li class="breadcrumb-item"><a href="/Settings">Settings</a></li>
                    <li class="breadcrumb-item active">Locations</li>
                </ol>
            </nav>
        </div>
        <button class="btn btn-primary" data-modal-target="locationModal" data-modal-toggle="locationModal" onclick="openAddModal()">
            <i class="bi bi-plus-lg me-1"></i> Add Location
        </button>
    </div>

    <!-- Info Card -->
    <div class="alert alert-info d-flex align-items-center mb-4">
        <i class="bi bi-info-circle me-2"></i>
        <div>
            Configure your office locations with GST registration details. Each location can have its own default currency.
            GST type (CGST/SGST or IGST) is determined based on the source and destination states.
        </div>
    </div>

    <!-- Locations Cards -->
    <div class="row g-4" id="locationsContainer" hx-get="?handler=Table" hx-trigger="load">
        <div class="col-12 text-center py-5">
            <div class="spinner-border text-primary"></div>
        </div>
    </div>
</div>

<!-- Location Modal -->
<div class="modal fade" id="locationModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Add Office Location</h5>
                <button type="button" class="btn-close" data-modal-hide="locationModal"></button>
            </div>
            <form id="locationForm" hx-post="" hx-target="#locationsContainer">
                <div class="modal-body">
                    <input type="hidden" name="Id" id="locationId" />

                    <!-- Basic Info -->
                    <h6 class="text-muted mb-3"><i class="bi bi-building me-2"></i>Basic Information</h6>
                    <div class="row g-3 mb-4">
                        <div class="col-md-3">
                            <label class="form-label">Code <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" name="Code" id="code" required maxlength="20"
                                   placeholder="HO, BR01" style="text-transform: uppercase;" />
                        </div>
                        <div class="col-md-5">
                            <label class="form-label">Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" name="Name" id="name" required
                                   placeholder="Head Office, Mumbai Branch" />
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Type</label>
                            <select class="form-select" name="Type" id="type">
                                <option value="0">Head Office</option>
                                <option value="1" selected>Branch</option>
                                <option value="2">Warehouse</option>
                                <option value="3">Factory</option>
                                <option value="4">Registered Office</option>
                            </select>
                        </div>
                    </div>

                    <!-- Address -->
                    <h6 class="text-muted mb-3"><i class="bi bi-geo-alt me-2"></i>Address</h6>
                    <div class="row g-3 mb-4">
                        <div class="col-12">
                            <label class="form-label">Address Line 1 <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" name="AddressLine1" id="addressLine1" required />
                        </div>
                        <div class="col-12">
                            <label class="form-label">Address Line 2</label>
                            <input type="text" class="form-control" name="AddressLine2" id="addressLine2" />
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">City <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" name="City" id="city" required />
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">State <span class="text-danger">*</span></label>
                            <select class="form-select" name="StateId" id="stateId" required>
                                <option value="">Select State</option>
                                @foreach (var state in Model.States)
                                {
                                    <option value="@state.Value">@state.Text</option>
                                }
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">PIN Code</label>
                            <input type="text" class="form-control" name="PostalCode" id="postalCode" maxlength="10" />
                        </div>
                    </div>

                    <!-- GST Details -->
                    <h6 class="text-muted mb-3"><i class="bi bi-receipt me-2"></i>GST Registration</h6>
                    <div class="row g-3 mb-4">
                        <div class="col-md-6">
                            <label class="form-label">GST Number</label>
                            <input type="text" class="form-control" name="GstNumber" id="gstNumber" maxlength="20"
                                   placeholder="22AAAAA0000A1Z5" style="text-transform: uppercase;" />
                            <small class="text-muted">15-character GSTIN</small>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Registration Type</label>
                            <select class="form-select" name="GstRegistrationType" id="gstRegistrationType">
                                <option value="0">Regular</option>
                                <option value="1">Composition</option>
                                <option value="2">Unregistered</option>
                                <option value="3">Input Service Distributor</option>
                                <option value="8">SEZ</option>
                            </select>
                        </div>
                        <div class="col-12">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" name="IsGstRegistered" id="isGstRegistered" checked />
                                <label class="form-check-label" for="isGstRegistered">GST Registered</label>
                            </div>
                        </div>
                    </div>

                    <!-- Default Currency -->
                    <h6 class="text-muted mb-3"><i class="bi bi-currency-exchange me-2"></i>Currency & Contact</h6>
                    <div class="row g-3 mb-4">
                        <div class="col-md-6">
                            <label class="form-label">Default Currency</label>
                            <select class="form-select" name="DefaultCurrencyId" id="defaultCurrencyId">
                                <option value="">Use Base Currency</option>
                                @foreach (var currency in Model.Currencies)
                                {
                                    <option value="@currency.Value">@currency.Text</option>
                                }
                            </select>
                            <small class="text-muted">Currency for transactions at this location</small>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Contact Person</label>
                            <input type="text" class="form-control" name="ContactPerson" id="contactPerson" />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Phone</label>
                            <input type="tel" class="form-control" name="Phone" id="phone" />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" name="Email" id="email" />
                        </div>
                    </div>

                    <!-- Settings -->
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label">Display Order</label>
                            <input type="number" class="form-control" name="DisplayOrder" id="displayOrder" min="0" value="0" />
                        </div>
                        <div class="col-md-4 d-flex align-items-end">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" name="IsHeadOffice" id="isHeadOffice" />
                                <label class="form-check-label" for="isHeadOffice">Head Office</label>
                            </div>
                        </div>
                        <div class="col-md-4 d-flex align-items-end">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" name="IsActive" id="isActive" checked />
                                <label class="form-check-label" for="isActive">Active</label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-modal-hide="locationModal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Location</button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function getModal() {
            return FlowbiteInstances.getInstance('Modal', 'locationModal');
        }

        function openAddModal() {
            document.getElementById('modalTitle').textContent = 'Add Office Location';
            document.getElementById('locationForm').reset();
            document.getElementById('locationId').value = '';
            document.getElementById('isActive').checked = true;
            document.getElementById('isGstRegistered').checked = true;
            document.getElementById('isHeadOffice').checked = false;
        }

        function editLocation(location) {
            document.getElementById('modalTitle').textContent = 'Edit Office Location';
            document.getElementById('locationId').value = location.id;
            document.getElementById('code').value = location.code;
            document.getElementById('name').value = location.name;
            document.getElementById('type').value = location.type;
            document.getElementById('addressLine1').value = location.addressLine1;
            document.getElementById('addressLine2').value = location.addressLine2 || '';
            document.getElementById('city').value = location.city;
            document.getElementById('stateId').value = location.stateId || '';
            document.getElementById('postalCode').value = location.postalCode || '';
            document.getElementById('gstNumber').value = location.gstNumber || '';
            document.getElementById('gstRegistrationType').value = location.gstRegistrationType;
            document.getElementById('isGstRegistered').checked = location.isGstRegistered;
            document.getElementById('defaultCurrencyId').value = location.defaultCurrencyId || '';
            document.getElementById('contactPerson').value = location.contactPerson || '';
            document.getElementById('phone').value = location.phone || '';
            document.getElementById('email').value = location.email || '';
            document.getElementById('displayOrder').value = location.displayOrder;
            document.getElementById('isHeadOffice').checked = location.isHeadOffice;
            document.getElementById('isActive').checked = location.isActive;
            const modal = getModal();
            if (modal) modal.show();
        }

        document.getElementById('locationForm').addEventListener('htmx:afterRequest', function(evt) {
            if (evt.detail.successful) {
                const modal = getModal();
                if (modal) modal.hide();
            }
        });
    </script>
}
