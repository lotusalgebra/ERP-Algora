@model Algora.Erp.Web.Pages.Dispatch.DeliveryChallans.DeliveryChallanFormViewModel

<form hx-post="?handler=" hx-target="#challansTableBody" hx-swap="innerHTML">
    @if (Model.IsEdit && Model.DeliveryChallan != null)
    {
        <input type="hidden" name="Id" value="@Model.DeliveryChallan.Id" />
    }

    <div class="grid grid-cols-12 gap-3">
        <!-- Left Column -->
        <div class="md:col-span-6 col-span-12">
            <div class="bg-white rounded-lg shadow-md mb-3">
                <div class="px-6 py-4 border-b border-gray-200 bg-gray-50">
                    <h6 class="text-sm font-medium text-gray-900 mb-0">Challan Information</h6>
                </div>
                <div class="p-6">
                    <div class="mb-3">
                        <label class="block mb-2 text-sm font-medium text-gray-900">Challan Date <span class="text-red-500">*</span></label>
                        <input type="date" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5" name="ChallanDate"
                               value="@(Model.DeliveryChallan?.ChallanDate.ToString("yyyy-MM-dd") ?? DateTime.Today.ToString("yyyy-MM-dd"))" required />
                    </div>
                    @if (Model.SalesOrders?.Any() == true)
                    {
                        <div class="mb-3">
                            <label class="block mb-2 text-sm font-medium text-gray-900">Sales Order (Optional)</label>
                            <select class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5" name="SalesOrderId" id="salesOrderSelect" onchange="loadSalesOrderDetails(this.value)">
                                <option value="">-- Create Manual DC --</option>
                                @foreach (var so in Model.SalesOrders)
                                {
                                    var isSelected = Model.DeliveryChallan?.SalesOrderId == so.Id || Model.SelectedSalesOrder?.Id == so.Id;
                                    if (isSelected)
                                    {
                                        <option value="@so.Id" data-customer="@so.CustomerId" data-customer-name="@so.Customer?.Name" selected>
                                            @so.OrderNumber - @so.Customer?.Name (@so.OrderDate.ToString("dd MMM"))
                                        </option>
                                    }
                                    else
                                    {
                                        <option value="@so.Id" data-customer="@so.CustomerId" data-customer-name="@so.Customer?.Name">
                                            @so.OrderNumber - @so.Customer?.Name (@so.OrderDate.ToString("dd MMM"))
                                        </option>
                                    }
                                }
                            </select>
                        </div>
                    }
                    <div class="mb-3">
                        <label class="block mb-2 text-sm font-medium text-gray-900">Customer <span class="text-red-500">*</span></label>
                        <select class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5" name="CustomerId" id="customerSelect" required>
                            <option value="">-- Select Customer --</option>
                            @foreach (var customer in Model.Customers)
                            {
                                var isSelected = Model.DeliveryChallan?.CustomerId == customer.Id || Model.SelectedSalesOrder?.CustomerId == customer.Id;
                                if (isSelected)
                                {
                                    <option value="@customer.Id" selected>@customer.Name</option>
                                }
                                else
                                {
                                    <option value="@customer.Id">@customer.Name</option>
                                }
                            }
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="block mb-2 text-sm font-medium text-gray-900">Warehouse <span class="text-red-500">*</span></label>
                        <select class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5" name="WarehouseId" required>
                            <option value="">-- Select Warehouse --</option>
                            @foreach (var warehouse in Model.Warehouses)
                            {
                                var isSelected = Model.DeliveryChallan?.WarehouseId == warehouse.Id;
                                if (isSelected)
                                {
                                    <option value="@warehouse.Id" selected>@warehouse.Name</option>
                                }
                                else
                                {
                                    <option value="@warehouse.Id">@warehouse.Name</option>
                                }
                            }
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column -->
        <div class="md:col-span-6 col-span-12">
            <div class="bg-white rounded-lg shadow-md mb-3">
                <div class="px-6 py-4 border-b border-gray-200 bg-gray-50">
                    <h6 class="text-sm font-medium text-gray-900 mb-0">Transport Details</h6>
                </div>
                <div class="p-6">
                    <div class="grid grid-cols-12 gap-3">
                        <div class="md:col-span-6 col-span-12">
                            <label class="block mb-2 text-sm font-medium text-gray-900">Vehicle Number</label>
                            <input type="text" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5" name="VehicleNumber"
                                   value="@Model.DeliveryChallan?.VehicleNumber" />
                        </div>
                        <div class="md:col-span-6 col-span-12">
                            <label class="block mb-2 text-sm font-medium text-gray-900">Transport Mode</label>
                            @{
                                var transportMode = Model.DeliveryChallan?.TransportMode;
                            }
                            <select class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5" name="TransportMode">
                                <option value="">-- Select --</option>
                                @if (transportMode == "Road") { <option value="Road" selected>Road</option> } else { <option value="Road">Road</option> }
                                @if (transportMode == "Rail") { <option value="Rail" selected>Rail</option> } else { <option value="Rail">Rail</option> }
                                @if (transportMode == "Air") { <option value="Air" selected>Air</option> } else { <option value="Air">Air</option> }
                                @if (transportMode == "Sea") { <option value="Sea" selected>Sea</option> } else { <option value="Sea">Sea</option> }
                                @if (transportMode == "Courier") { <option value="Courier" selected>Courier</option> } else { <option value="Courier">Courier</option> }
                            </select>
                        </div>
                        <div class="md:col-span-6 col-span-12">
                            <label class="block mb-2 text-sm font-medium text-gray-900">Driver Name</label>
                            <input type="text" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5" name="DriverName"
                                   value="@Model.DeliveryChallan?.DriverName" />
                        </div>
                        <div class="md:col-span-6 col-span-12">
                            <label class="block mb-2 text-sm font-medium text-gray-900">Driver Phone</label>
                            <input type="text" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5" name="DriverPhone"
                                   value="@Model.DeliveryChallan?.DriverPhone" />
                        </div>
                        <div class="col-span-12">
                            <label class="block mb-2 text-sm font-medium text-gray-900">Transporter Name</label>
                            <input type="text" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5" name="TransporterName"
                                   value="@Model.DeliveryChallan?.TransporterName" />
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Shipping Address -->
        <div class="col-span-12">
            <div class="bg-white rounded-lg shadow-md mb-3">
                <div class="px-6 py-4 border-b border-gray-200 bg-gray-50">
                    <h6 class="text-sm font-medium text-gray-900 mb-0">Shipping Address</h6>
                </div>
                <div class="p-6">
                    <div class="grid grid-cols-12 gap-3">
                        <div class="md:col-span-6 col-span-12">
                            <label class="block mb-2 text-sm font-medium text-gray-900">Ship To Name</label>
                            <input type="text" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5" name="ShipToName"
                                   value="@Model.DeliveryChallan?.ShipToName" />
                        </div>
                        <div class="md:col-span-6 col-span-12">
                            <label class="block mb-2 text-sm font-medium text-gray-900">Phone</label>
                            <input type="text" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5" name="ShipToPhone"
                                   value="@Model.DeliveryChallan?.ShipToPhone" />
                        </div>
                        <div class="md:col-span-6 col-span-12">
                            <label class="block mb-2 text-sm font-medium text-gray-900">Address Line 1</label>
                            <input type="text" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5" name="ShipToAddress1"
                                   value="@Model.DeliveryChallan?.ShipToAddress1" />
                        </div>
                        <div class="md:col-span-6 col-span-12">
                            <label class="block mb-2 text-sm font-medium text-gray-900">Address Line 2</label>
                            <input type="text" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5" name="ShipToAddress2"
                                   value="@Model.DeliveryChallan?.ShipToAddress2" />
                        </div>
                        <div class="md:col-span-3 col-span-6">
                            <label class="block mb-2 text-sm font-medium text-gray-900">City</label>
                            <input type="text" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5" name="ShipToCity"
                                   value="@Model.DeliveryChallan?.ShipToCity" />
                        </div>
                        <div class="md:col-span-3 col-span-6">
                            <label class="block mb-2 text-sm font-medium text-gray-900">State</label>
                            <input type="text" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5" name="ShipToState"
                                   value="@Model.DeliveryChallan?.ShipToState" />
                        </div>
                        <div class="md:col-span-3 col-span-6">
                            <label class="block mb-2 text-sm font-medium text-gray-900">Postal Code</label>
                            <input type="text" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5" name="ShipToPostalCode"
                                   value="@Model.DeliveryChallan?.ShipToPostalCode" />
                        </div>
                        <div class="md:col-span-3 col-span-6">
                            <label class="block mb-2 text-sm font-medium text-gray-900">Country</label>
                            <input type="text" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5" name="ShipToCountry"
                                   value="@(Model.DeliveryChallan?.ShipToCountry ?? "India")" />
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Line Items -->
        <div class="col-span-12">
            <div class="bg-white rounded-lg shadow-md">
                <div class="px-6 py-4 border-b border-gray-200 bg-gray-50 flex justify-between items-center">
                    <h6 class="text-sm font-medium text-gray-900 mb-0">Line Items</h6>
                    <button type="button" class="text-primary-600 border border-primary-600 hover:bg-primary-50 focus:ring-4 focus:ring-primary-300 font-medium rounded-lg text-xs px-3 py-2" onclick="addLine()">
                        <i class="bi bi-plus-lg mr-1"></i>Add Line
                    </button>
                </div>
                <div class="p-0">
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left text-gray-500" id="linesTable">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-4 py-3" style="width: 40%;">Product</th>
                                    <th scope="col" class="px-4 py-3 text-right" style="width: 20%;">Quantity</th>
                                    <th scope="col" class="px-4 py-3" style="width: 15%;">UOM</th>
                                    <th scope="col" class="px-4 py-3" style="width: 20%;">Notes</th>
                                    <th scope="col" class="px-4 py-3" style="width: 5%;"></th>
                                </tr>
                            </thead>
                            <tbody id="linesBody">
                                @if (Model.DeliveryChallan?.Lines?.Any() == true)
                                {
                                    var idx = 0;
                                    foreach (var line in Model.DeliveryChallan.Lines.OrderBy(l => l.LineNumber))
                                    {
                                        <tr class="line-row bg-white border-b">
                                            <td class="px-4 py-3">
                                                <input type="hidden" name="Lines[@idx].SalesOrderLineId" value="@line.SalesOrderLineId" />
                                                <select class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2" name="Lines[@idx].ProductId" required>
                                                    @foreach (var product in Model.Products)
                                                    {
                                                        if (line.ProductId == product.Id)
                                                        {
                                                            <option value="@product.Id" selected>@product.Name (@product.Sku)</option>
                                                        }
                                                        else
                                                        {
                                                            <option value="@product.Id">@product.Name (@product.Sku)</option>
                                                        }
                                                    }
                                                </select>
                                            </td>
                                            <td class="px-4 py-3">
                                                <input type="number" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2 text-right" name="Lines[@idx].Quantity"
                                                       value="@line.Quantity" required step="0.01" min="0.01" />
                                            </td>
                                            <td class="px-4 py-3">
                                                <input type="text" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2" name="Lines[@idx].UnitOfMeasure"
                                                       value="@line.UnitOfMeasure" />
                                            </td>
                                            <td class="px-4 py-3">
                                                <input type="text" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2" name="Lines[@idx].Notes"
                                                       value="@line.Notes" />
                                            </td>
                                            <td class="px-4 py-3">
                                                <button type="button" class="text-red-600 border border-red-600 hover:bg-red-50 focus:ring-4 focus:ring-red-300 font-medium rounded-lg text-xs px-2 py-1.5" onclick="removeLine(this)">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </td>
                                        </tr>
                                        idx++;
                                    }
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Package Info -->
        <div class="md:col-span-4 col-span-12">
            <label class="block mb-2 text-sm font-medium text-gray-900">Total Packages</label>
            <input type="number" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5" name="TotalPackages" min="0"
                   value="@(Model.DeliveryChallan?.TotalPackages ?? 1)" />
        </div>
        <div class="md:col-span-4 col-span-12">
            <label class="block mb-2 text-sm font-medium text-gray-900">Total Weight</label>
            <input type="number" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5" name="TotalWeight" step="0.01" min="0"
                   value="@Model.DeliveryChallan?.TotalWeight" />
        </div>
        <div class="md:col-span-4 col-span-12">
            <label class="block mb-2 text-sm font-medium text-gray-900">Weight Unit</label>
            @{
                var weightUnit = Model.DeliveryChallan?.WeightUnit ?? "KG";
            }
            <select class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5" name="WeightUnit">
                @if (weightUnit == "KG") { <option value="KG" selected>KG</option> } else { <option value="KG">KG</option> }
                @if (weightUnit == "LB") { <option value="LB" selected>LB</option> } else { <option value="LB">LB</option> }
            </select>
        </div>

        <!-- Notes -->
        <div class="col-span-12">
            <label class="block mb-2 text-sm font-medium text-gray-900">Notes</label>
            <textarea class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5" name="Notes" rows="2">@Model.DeliveryChallan?.Notes</textarea>
        </div>
    </div>

    <div class="flex items-center p-4 border-t border-gray-200 rounded-b gap-2 mt-3 px-0 pb-0">
        <button type="button" class="text-gray-900 bg-white border border-gray-300 hover:bg-gray-100 focus:ring-4 focus:ring-gray-200 font-medium rounded-lg text-sm px-5 py-2.5" onclick="closeModal('formModal')">Cancel</button>
        <button type="submit" class="text-white bg-primary-600 hover:bg-primary-700 focus:ring-4 focus:ring-primary-300 font-medium rounded-lg text-sm px-5 py-2.5">
            <i class="bi bi-check-lg mr-2"></i>@(Model.IsEdit ? "Update" : "Create") Challan
        </button>
    </div>
</form>

<script>
    let lineIndex = @(Model.DeliveryChallan?.Lines?.Count ?? 0);

    const productsJson = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Products.Select(p => new { p.Id, p.Name, p.Sku })));

    function loadSalesOrderDetails(soId) {
        const select = document.getElementById('salesOrderSelect');
        const option = select.options[select.selectedIndex];
        if (option && option.value) {
            document.getElementById('customerSelect').value = option.dataset.customer || '';
        }
    }

    function addLine() {
        let optionsHtml = '';
        productsJson.forEach(p => {
            optionsHtml += `<option value="${p.Id}">${p.Name} (${p.Sku})</option>`;
        });

        const html = `
            <tr class="line-row bg-white border-b">
                <td class="px-4 py-3">
                    <select class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2" name="Lines[${lineIndex}].ProductId" required>
                        <option value="">-- Select Product --</option>
                        ${optionsHtml}
                    </select>
                </td>
                <td class="px-4 py-3">
                    <input type="number" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2 text-right" name="Lines[${lineIndex}].Quantity"
                           required step="0.01" min="0.01" value="1" />
                </td>
                <td class="px-4 py-3">
                    <input type="text" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2" name="Lines[${lineIndex}].UnitOfMeasure" value="EA" />
                </td>
                <td class="px-4 py-3">
                    <input type="text" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2" name="Lines[${lineIndex}].Notes" />
                </td>
                <td class="px-4 py-3">
                    <button type="button" class="text-red-600 border border-red-600 hover:bg-red-50 focus:ring-4 focus:ring-red-300 font-medium rounded-lg text-xs px-2 py-1.5" onclick="removeLine(this)">
                        <i class="bi bi-trash"></i>
                    </button>
                </td>
            </tr>
        `;
        document.getElementById('linesBody').insertAdjacentHTML('beforeend', html);
        lineIndex++;
    }

    function removeLine(btn) {
        btn.closest('tr').remove();
        reindexLines();
    }

    function reindexLines() {
        const rows = document.querySelectorAll('#linesBody .line-row');
        rows.forEach((row, idx) => {
            row.querySelectorAll('input[name], select[name]').forEach(input => {
                const name = input.name.replace(/\[\d+\]/, `[${idx}]`);
                input.name = name;
            });
        });
        lineIndex = rows.length;
    }

    // Handle form submission success
    document.querySelector('form').addEventListener('htmx:afterRequest', function(e) {
        if (e.detail.successful) {
            document.body.dispatchEvent(new CustomEvent('formSubmitSuccess'));
        }
    });
</script>
