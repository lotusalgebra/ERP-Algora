@page
@model Algora.Erp.Web.Pages.Finance.Reports.InvoicesModel
@using Algora.Erp.Domain.Entities.Finance
@{
    ViewData["Title"] = "Invoice Reports";
}

<div class="p-4">
    <!-- Page Header -->
    <div class="flex justify-between items-center mb-6">
        <div>
            <h4 class="text-xl font-semibold text-gray-900 dark:text-white mb-1">Invoice Reports</h4>
            <nav class="flex" aria-label="Breadcrumb">
                <ol class="inline-flex items-center space-x-1 md:space-x-3 text-sm text-gray-500 dark:text-gray-400">
                    <li><a href="/" class="hover:text-primary-600">Dashboard</a></li>
                    <li class="flex items-center"><i class="bi bi-chevron-right mx-2 text-xs"></i><a href="/Finance" class="hover:text-primary-600">Finance</a></li>
                    <li class="flex items-center"><i class="bi bi-chevron-right mx-2 text-xs"></i><a href="/Finance/Reports" class="hover:text-primary-600">Reports</a></li>
                    <li class="flex items-center"><i class="bi bi-chevron-right mx-2 text-xs"></i><span class="text-gray-700 dark:text-gray-300">Invoices</span></li>
                </ol>
            </nav>
        </div>
        <div class="flex gap-2">
            <a href="?handler=ExportPdf&StartDate=@Model.StartDate?.ToString("yyyy-MM-dd")&EndDate=@Model.EndDate?.ToString("yyyy-MM-dd")" class="text-red-700 border border-red-700 hover:bg-red-700 hover:text-white focus:ring-4 focus:ring-red-300 font-medium rounded-lg text-sm px-4 py-2 dark:border-red-500 dark:text-red-500 dark:hover:bg-red-600 dark:hover:text-white">
                <i class="bi bi-file-pdf mr-1"></i>Export PDF
            </a>
            <a href="?handler=ExportCsv&StartDate=@Model.StartDate?.ToString("yyyy-MM-dd")&EndDate=@Model.EndDate?.ToString("yyyy-MM-dd")" class="text-emerald-700 border border-emerald-700 hover:bg-emerald-700 hover:text-white focus:ring-4 focus:ring-emerald-300 font-medium rounded-lg text-sm px-4 py-2 dark:border-emerald-500 dark:text-emerald-500 dark:hover:bg-emerald-600 dark:hover:text-white">
                <i class="bi bi-file-earmark-excel mr-1"></i>Export CSV
            </a>
        </div>
    </div>

    <!-- Date Filter -->
    <div class="bg-white rounded-lg shadow-md dark:bg-gray-800 mb-6">
        <div class="p-6">
            <form method="get" class="grid grid-cols-12 gap-4 items-end">
                <div class="col-span-12 md:col-span-3">
                    <label class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Start Date</label>
                    <input type="date" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white" name="StartDate" value="@Model.StartDate?.ToString("yyyy-MM-dd")">
                </div>
                <div class="col-span-12 md:col-span-3">
                    <label class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">End Date</label>
                    <input type="date" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white" name="EndDate" value="@Model.EndDate?.ToString("yyyy-MM-dd")">
                </div>
                <div class="col-span-12 md:col-span-3">
                    <button type="submit" class="text-white bg-primary-700 hover:bg-primary-800 focus:ring-4 focus:ring-primary-300 font-medium rounded-lg text-sm px-5 py-2.5 dark:bg-primary-600 dark:hover:bg-primary-700">
                        <i class="bi bi-funnel mr-1"></i>Apply Filter
                    </button>
                    <a href="/Finance/Reports/Invoices" class="text-gray-700 border border-gray-300 hover:bg-gray-100 focus:ring-4 focus:ring-gray-200 font-medium rounded-lg text-sm px-5 py-2.5 dark:text-gray-400 dark:border-gray-600 dark:hover:bg-gray-700 ml-2">Reset</a>
                </div>
                <div class="col-span-12 md:col-span-3 text-right">
                    <span class="text-gray-500 dark:text-gray-400">
                        <i class="bi bi-calendar mr-1"></i>
                        @Model.DateRange.StartDate.ToString("MMM dd, yyyy") - @Model.DateRange.EndDate.ToString("MMM dd, yyyy")
                    </span>
                </div>
            </form>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="grid grid-cols-2 md:grid-cols-4 xl:grid-cols-6 gap-4 mb-6">
        <div class="bg-white rounded-lg shadow-md dark:bg-gray-800 h-full">
            <div class="p-5 text-center">
                <h3 class="text-2xl font-semibold text-gray-900 dark:text-white mb-1">@Model.Report.TotalInvoices</h3>
                <small class="text-gray-500 dark:text-gray-400">Total Invoices</small>
            </div>
        </div>
        <div class="bg-white rounded-lg shadow-md dark:bg-gray-800 h-full">
            <div class="p-5 text-center">
                <h3 class="text-2xl font-semibold text-primary-600 dark:text-primary-400 mb-1">@Model.Report.TotalInvoiced.ToString("C0")</h3>
                <small class="text-gray-500 dark:text-gray-400">Total Invoiced</small>
            </div>
        </div>
        <div class="bg-white rounded-lg shadow-md dark:bg-gray-800 h-full">
            <div class="p-5 text-center">
                <h3 class="text-2xl font-semibold text-emerald-600 dark:text-emerald-400 mb-1">@Model.Report.TotalPaid.ToString("C0")</h3>
                <small class="text-gray-500 dark:text-gray-400">Total Paid</small>
            </div>
        </div>
        <div class="bg-white rounded-lg shadow-md dark:bg-gray-800 h-full">
            <div class="p-5 text-center">
                <h3 class="text-2xl font-semibold text-amber-600 dark:text-amber-400 mb-1">@Model.Report.TotalOutstanding.ToString("C0")</h3>
                <small class="text-gray-500 dark:text-gray-400">Outstanding</small>
            </div>
        </div>
        <div class="bg-white rounded-lg shadow-md dark:bg-gray-800 h-full">
            <div class="p-5 text-center">
                <h3 class="text-2xl font-semibold text-red-600 dark:text-red-400 mb-1">@Model.Report.TotalOverdue.ToString("C0")</h3>
                <small class="text-gray-500 dark:text-gray-400">Overdue</small>
            </div>
        </div>
        <div class="bg-white rounded-lg shadow-md dark:bg-gray-800 h-full">
            <div class="p-5 text-center">
                <h3 class="text-2xl font-semibold text-gray-900 dark:text-white mb-1">@Model.Report.AverageInvoiceAmount.ToString("C0")</h3>
                <small class="text-gray-500 dark:text-gray-400">Average Amount</small>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-12 gap-6">
        <!-- Invoice Count by Status -->
        <div class="col-span-12 lg:col-span-6">
            <div class="bg-white rounded-lg shadow-md dark:bg-gray-800 h-full">
                <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                    <h5 class="text-lg font-medium text-gray-900 dark:text-white"><i class="bi bi-bar-chart mr-2"></i>Invoice Count by Status</h5>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left text-gray-500 dark:text-gray-400">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
                            <tr>
                                <th scope="col" class="px-6 py-3">Status</th>
                                <th scope="col" class="px-6 py-3 text-center">Count</th>
                                <th scope="col" class="px-6 py-3 text-right">Amount</th>
                                <th scope="col" class="px-6 py-3 text-right">%</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var status in Model.Report.ByStatus)
                            {
                                var badgeClass = status.Status switch
                                {
                                    InvoiceStatus.Draft => "bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300",
                                    InvoiceStatus.Pending => "bg-amber-100 text-amber-800 dark:bg-amber-900/30 dark:text-amber-400",
                                    InvoiceStatus.Sent => "bg-sky-100 text-sky-800 dark:bg-sky-900/30 dark:text-sky-400",
                                    InvoiceStatus.PartiallyPaid => "bg-primary-100 text-primary-800 dark:bg-primary-900/30 dark:text-primary-400",
                                    InvoiceStatus.Paid => "bg-emerald-100 text-emerald-800 dark:bg-emerald-900/30 dark:text-emerald-400",
                                    InvoiceStatus.Overdue => "bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-400",
                                    InvoiceStatus.Void => "bg-gray-800 text-white dark:bg-gray-900 dark:text-gray-200",
                                    _ => "bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300"
                                };

                                <tr class="bg-white border-b dark:bg-gray-800 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600">
                                    <td class="px-6 py-4">
                                        <span class="text-xs font-medium px-2.5 py-0.5 rounded-full @badgeClass">@status.Status</span>
                                    </td>
                                    <td class="px-6 py-4 text-center font-medium">@status.Count</td>
                                    <td class="px-6 py-4 text-right">@status.Amount.ToString("C0")</td>
                                    <td class="px-6 py-4 text-right">@status.Percentage.ToString("F1")%</td>
                                </tr>
                            }
                        </tbody>
                        <tfoot class="bg-gray-50 dark:bg-gray-700">
                            <tr class="font-bold">
                                <td class="px-6 py-4">Total</td>
                                <td class="px-6 py-4 text-center">@Model.Report.TotalInvoices</td>
                                <td class="px-6 py-4 text-right">@Model.Report.TotalInvoiced.ToString("C0")</td>
                                <td class="px-6 py-4 text-right">100%</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>

        <!-- Collection Efficiency -->
        <div class="col-span-12 lg:col-span-6">
            <div class="bg-white rounded-lg shadow-md dark:bg-gray-800 h-full">
                <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                    <h5 class="text-lg font-medium text-gray-900 dark:text-white"><i class="bi bi-speedometer2 mr-2"></i>Collection Efficiency</h5>
                </div>
                <div class="p-6">
                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <div class="text-center p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
                            <h3 class="text-2xl font-semibold mb-1 @(Model.CollectionReport.CollectionRate >= 80 ? "text-emerald-600 dark:text-emerald-400" : Model.CollectionReport.CollectionRate >= 50 ? "text-amber-600 dark:text-amber-400" : "text-red-600 dark:text-red-400")">
                                @Model.CollectionReport.CollectionRate.ToString("F1")%
                            </h3>
                            <small class="text-gray-500 dark:text-gray-400">Collection Rate</small>
                        </div>
                        <div class="text-center p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
                            <h3 class="text-2xl font-semibold text-gray-900 dark:text-white mb-1">@Model.CollectionReport.AverageDaysToPayment.ToString("F1")</h3>
                            <small class="text-gray-500 dark:text-gray-400">Avg Days to Payment</small>
                        </div>
                        <div class="text-center p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
                            <h3 class="text-2xl font-semibold text-emerald-600 dark:text-emerald-400 mb-1">@Model.CollectionReport.InvoicesPaidOnTime</h3>
                            <small class="text-gray-500 dark:text-gray-400">Paid On Time</small>
                        </div>
                        <div class="text-center p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
                            <h3 class="text-2xl font-semibold text-red-600 dark:text-red-400 mb-1">@Model.CollectionReport.InvoicesPaidLate</h3>
                            <small class="text-gray-500 dark:text-gray-400">Paid Late</small>
                        </div>
                    </div>

                    <div>
                        <h6 class="text-gray-500 dark:text-gray-400 mb-3 text-sm font-medium">On-Time Payment Rate</h6>
                        <div class="w-full bg-gray-200 rounded-full h-6 dark:bg-gray-700 flex overflow-hidden">
                            <div class="bg-emerald-600 h-6 flex items-center justify-center text-xs font-medium text-white" style="width: @Model.CollectionReport.OnTimePaymentRate%">
                                @Model.CollectionReport.OnTimePaymentRate.ToString("F1")% On Time
                            </div>
                            <div class="bg-red-600 h-6 flex items-center justify-center text-xs font-medium text-white" style="width: @(100 - Model.CollectionReport.OnTimePaymentRate)%">
                                @((100 - Model.CollectionReport.OnTimePaymentRate).ToString("F1"))% Late
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Daily Trend Chart -->
        <div class="col-span-12">
            <div class="bg-white rounded-lg shadow-md dark:bg-gray-800">
                <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                    <h5 class="text-lg font-medium text-gray-900 dark:text-white"><i class="bi bi-graph-up mr-2"></i>Daily Invoice Trend</h5>
                </div>
                <div class="p-6">
                    <canvas id="dailyTrendChart" height="100"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        const ctx = document.getElementById('dailyTrendChart').getContext('2d');
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: [@Html.Raw(string.Join(",", Model.Report.DailyTrend.Select(d => $"'{d.Date:MMM dd}'")))],
                datasets: [{
                    label: 'Invoice Amount',
                    data: [@string.Join(",", Model.Report.DailyTrend.Select(d => d.Amount.ToString("F2", System.Globalization.CultureInfo.InvariantCulture)))],
                    backgroundColor: 'rgba(59, 130, 246, 0.7)',
                    borderColor: 'rgb(59, 130, 246)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) { return '$' + value.toLocaleString(); }
                        }
                    }
                }
            }
        });
    </script>
}
