@page
@model Algora.Erp.Web.Pages.Finance.Reports.PaymentsModel
@using Algora.Erp.Domain.Entities.Finance
@{
    ViewData["Title"] = "Payment Reports";

    var currentWeek = Model.Report.WeeklyTrend.FirstOrDefault();
    var lastWeek = Model.Report.WeeklyTrend.Skip(1).FirstOrDefault();
    var thisWeekAmount = currentWeek?.Amount ?? 0;
    var lastWeekAmount = lastWeek?.Amount ?? 0;
    var weekChange = lastWeekAmount > 0
        ? ((thisWeekAmount - lastWeekAmount) / lastWeekAmount * 100)
        : 0;
}

<div class="p-4">
    <!-- Page Header -->
    <div class="flex justify-between items-center mb-6">
        <div>
            <h4 class="text-xl font-semibold text-gray-900 dark:text-white mb-1">Payment Reports</h4>
            <nav class="flex" aria-label="Breadcrumb">
                <ol class="inline-flex items-center space-x-1 md:space-x-3 text-sm text-gray-500 dark:text-gray-400">
                    <li><a href="/" class="hover:text-primary-600">Dashboard</a></li>
                    <li class="flex items-center"><i class="bi bi-chevron-right mx-2 text-xs"></i><a href="/Finance" class="hover:text-primary-600">Finance</a></li>
                    <li class="flex items-center"><i class="bi bi-chevron-right mx-2 text-xs"></i><a href="/Finance/Reports" class="hover:text-primary-600">Reports</a></li>
                    <li class="flex items-center"><i class="bi bi-chevron-right mx-2 text-xs"></i><span class="text-gray-700 dark:text-gray-300">Payments</span></li>
                </ol>
            </nav>
        </div>
        <div class="flex gap-2">
            <a href="?handler=ExportPdf&StartDate=@Model.StartDate?.ToString("yyyy-MM-dd")&EndDate=@Model.EndDate?.ToString("yyyy-MM-dd")" class="text-red-700 border border-red-700 hover:bg-red-700 hover:text-white focus:ring-4 focus:ring-red-300 font-medium rounded-lg text-sm px-4 py-2 dark:border-red-500 dark:text-red-500 dark:hover:bg-red-600 dark:hover:text-white">
                <i class="bi bi-file-pdf mr-1"></i>Export PDF
            </a>
            <a href="?handler=ExportCsv&StartDate=@Model.StartDate?.ToString("yyyy-MM-dd")&EndDate=@Model.EndDate?.ToString("yyyy-MM-dd")" class="text-emerald-700 border border-emerald-700 hover:bg-emerald-700 hover:text-white focus:ring-4 focus:ring-emerald-300 font-medium rounded-lg text-sm px-4 py-2 dark:border-emerald-500 dark:text-emerald-500 dark:hover:bg-emerald-600 dark:hover:text-white">
                <i class="bi bi-file-earmark-excel mr-1"></i>Export CSV
            </a>
        </div>
    </div>

    <!-- Date Filter -->
    <div class="bg-white rounded-lg shadow-md dark:bg-gray-800 mb-6">
        <div class="p-6">
            <form method="get" class="grid grid-cols-12 gap-4 items-end">
                <div class="col-span-12 md:col-span-3">
                    <label class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Start Date</label>
                    <input type="date" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white" name="StartDate" value="@Model.StartDate?.ToString("yyyy-MM-dd")">
                </div>
                <div class="col-span-12 md:col-span-3">
                    <label class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">End Date</label>
                    <input type="date" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white" name="EndDate" value="@Model.EndDate?.ToString("yyyy-MM-dd")">
                </div>
                <div class="col-span-12 md:col-span-3">
                    <button type="submit" class="text-white bg-primary-700 hover:bg-primary-800 focus:ring-4 focus:ring-primary-300 font-medium rounded-lg text-sm px-5 py-2.5 dark:bg-primary-600 dark:hover:bg-primary-700">
                        <i class="bi bi-funnel mr-1"></i>Apply Filter
                    </button>
                    <a href="/Finance/Reports/Payments" class="text-gray-700 border border-gray-300 hover:bg-gray-100 focus:ring-4 focus:ring-gray-200 font-medium rounded-lg text-sm px-5 py-2.5 dark:text-gray-400 dark:border-gray-600 dark:hover:bg-gray-700 ml-2">Reset</a>
                </div>
                <div class="col-span-12 md:col-span-3 text-right">
                    <span class="text-gray-500 dark:text-gray-400">
                        <i class="bi bi-calendar mr-1"></i>
                        @Model.DateRange.StartDate.ToString("MMM dd, yyyy") - @Model.DateRange.EndDate.ToString("MMM dd, yyyy")
                    </span>
                </div>
            </form>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="grid grid-cols-2 md:grid-cols-4 xl:grid-cols-6 gap-4 mb-6">
        <div class="bg-white rounded-lg shadow-md dark:bg-gray-800 h-full">
            <div class="p-5 text-center">
                <h3 class="text-2xl font-semibold text-gray-900 dark:text-white mb-1">@Model.Report.TotalPayments</h3>
                <small class="text-gray-500 dark:text-gray-400">Total Payments</small>
            </div>
        </div>
        <div class="bg-white rounded-lg shadow-md dark:bg-gray-800 h-full">
            <div class="p-5 text-center">
                <h3 class="text-2xl font-semibold text-emerald-600 dark:text-emerald-400 mb-1">@Model.Report.TotalReceived.ToString("C0")</h3>
                <small class="text-gray-500 dark:text-gray-400">Total Received</small>
            </div>
        </div>
        <div class="bg-white rounded-lg shadow-md dark:bg-gray-800 h-full">
            <div class="p-5 text-center">
                <h3 class="text-2xl font-semibold text-gray-900 dark:text-white mb-1">@Model.Report.AveragePayment.ToString("C0")</h3>
                <small class="text-gray-500 dark:text-gray-400">Average Payment</small>
            </div>
        </div>
        <div class="bg-white rounded-lg shadow-md dark:bg-gray-800 h-full">
            <div class="p-5 text-center">
                <h3 class="text-2xl font-semibold text-primary-600 dark:text-primary-400 mb-1">@Model.Report.LargestPayment.ToString("C0")</h3>
                <small class="text-gray-500 dark:text-gray-400">Largest Payment</small>
            </div>
        </div>
        <div class="bg-white rounded-lg shadow-md dark:bg-gray-800 h-full">
            <div class="p-5 text-center">
                <h3 class="text-2xl font-semibold text-gray-900 dark:text-white mb-1">@Model.Report.SmallestPayment.ToString("C0")</h3>
                <small class="text-gray-500 dark:text-gray-400">Smallest Payment</small>
            </div>
        </div>
        <div class="bg-white rounded-lg shadow-md dark:bg-gray-800 h-full">
            <div class="p-5 text-center">
                @{
                    var changeClass = weekChange >= 0 ? "text-emerald-600 dark:text-emerald-400" : "text-red-600 dark:text-red-400";
                    var changeIcon = weekChange >= 0 ? "bi-arrow-up" : "bi-arrow-down";
                }
                <h3 class="text-2xl font-semibold @changeClass mb-1">
                    <i class="bi @changeIcon"></i> @Math.Abs(weekChange).ToString("F1")%
                </h3>
                <small class="text-gray-500 dark:text-gray-400">Week over Week</small>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-12 gap-6">
        <!-- Payment by Method -->
        <div class="col-span-12 lg:col-span-6">
            <div class="bg-white rounded-lg shadow-md dark:bg-gray-800 h-full">
                <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                    <h5 class="text-lg font-medium text-gray-900 dark:text-white"><i class="bi bi-credit-card mr-2"></i>Payment by Method</h5>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left text-gray-500 dark:text-gray-400">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
                            <tr>
                                <th scope="col" class="px-6 py-3">Method</th>
                                <th scope="col" class="px-6 py-3 text-center">Count</th>
                                <th scope="col" class="px-6 py-3 text-right">Amount</th>
                                <th scope="col" class="px-6 py-3 text-right">%</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var method in Model.Report.ByMethod)
                            {
                                var iconClass = method.Method switch
                                {
                                    PaymentMethod.Cash => "bi-cash-coin text-emerald-600 dark:text-emerald-400",
                                    PaymentMethod.Check => "bi-file-text text-gray-500 dark:text-gray-400",
                                    PaymentMethod.BankTransfer => "bi-bank text-primary-600 dark:text-primary-400",
                                    PaymentMethod.CreditCard => "bi-credit-card text-sky-600 dark:text-sky-400",
                                    PaymentMethod.DebitCard => "bi-credit-card-2-front text-amber-600 dark:text-amber-400",
                                    PaymentMethod.PayPal => "bi-paypal text-primary-600 dark:text-primary-400",
                                    _ => "bi-question-circle text-gray-400"
                                };

                                <tr class="bg-white border-b dark:bg-gray-800 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600">
                                    <td class="px-6 py-4">
                                        <i class="bi @iconClass mr-2"></i>@method.Method
                                    </td>
                                    <td class="px-6 py-4 text-center font-medium">@method.Count</td>
                                    <td class="px-6 py-4 text-right">@method.Amount.ToString("C0")</td>
                                    <td class="px-6 py-4 text-right">@method.Percentage.ToString("F1")%</td>
                                </tr>
                            }
                        </tbody>
                        <tfoot class="bg-gray-50 dark:bg-gray-700">
                            <tr class="font-bold">
                                <td class="px-6 py-4">Total</td>
                                <td class="px-6 py-4 text-center">@Model.Report.TotalPayments</td>
                                <td class="px-6 py-4 text-right">@Model.Report.TotalReceived.ToString("C0")</td>
                                <td class="px-6 py-4 text-right">100%</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>

        <!-- Cash Flow Summary -->
        <div class="col-span-12 lg:col-span-6">
            <div class="bg-white rounded-lg shadow-md dark:bg-gray-800 h-full">
                <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                    <h5 class="text-lg font-medium text-gray-900 dark:text-white"><i class="bi bi-arrow-left-right mr-2"></i>Cash Flow Insights</h5>
                </div>
                <div class="p-6">
                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <div class="text-center p-4 bg-emerald-50 dark:bg-emerald-900/20 rounded-lg">
                            <h3 class="text-2xl font-semibold text-emerald-600 dark:text-emerald-400 mb-1">@Model.CashFlow.TotalInflow.ToString("C0")</h3>
                            <small class="text-gray-500 dark:text-gray-400">Actual Inflow</small>
                        </div>
                        <div class="text-center p-4 bg-primary-50 dark:bg-primary-900/20 rounded-lg">
                            <h3 class="text-2xl font-semibold text-primary-600 dark:text-primary-400 mb-1">@Model.CashFlow.ProjectedInflow.ToString("C0")</h3>
                            <small class="text-gray-500 dark:text-gray-400">Projected Inflow</small>
                        </div>
                    </div>

                    @{
                        var collectionRate = Model.CashFlow.ProjectedInflow > 0
                            ? (Model.CashFlow.TotalInflow / Model.CashFlow.ProjectedInflow * 100)
                            : 100;
                    }
                    <div class="mb-6">
                        <div class="flex justify-between mb-2">
                            <span class="text-gray-500 dark:text-gray-400">Collection Rate</span>
                            <span class="font-medium @(collectionRate >= 80 ? "text-emerald-600 dark:text-emerald-400" : collectionRate >= 50 ? "text-amber-600 dark:text-amber-400" : "text-red-600 dark:text-red-400")">
                                @collectionRate.ToString("F1")%
                            </span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2.5 dark:bg-gray-700">
                            <div class="bg-emerald-600 h-2.5 rounded-full" style="width: @Math.Min(collectionRate, 100)%"></div>
                        </div>
                    </div>

                    <div class="text-center p-4 bg-red-50 dark:bg-red-900/20 rounded-lg">
                        <h3 class="text-2xl font-semibold text-red-600 dark:text-red-400 mb-1">@Model.CashFlow.OverdueReceivables.ToString("C0")</h3>
                        <small class="text-gray-500 dark:text-gray-400">Overdue Receivables</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Daily Trend Chart -->
        <div class="col-span-12">
            <div class="bg-white rounded-lg shadow-md dark:bg-gray-800">
                <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                    <h5 class="text-lg font-medium text-gray-900 dark:text-white"><i class="bi bi-graph-up mr-2"></i>Daily Payment Trend</h5>
                </div>
                <div class="p-6">
                    <canvas id="dailyTrendChart" height="100"></canvas>
                </div>
            </div>
        </div>

        <!-- Weekly Trend Chart -->
        <div class="col-span-12">
            <div class="bg-white rounded-lg shadow-md dark:bg-gray-800">
                <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                    <h5 class="text-lg font-medium text-gray-900 dark:text-white"><i class="bi bi-bar-chart mr-2"></i>Weekly Payment Trend</h5>
                </div>
                <div class="p-6">
                    <canvas id="weeklyTrendChart" height="100"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Daily Trend Chart
        const dailyCtx = document.getElementById('dailyTrendChart').getContext('2d');
        new Chart(dailyCtx, {
            type: 'line',
            data: {
                labels: [@Html.Raw(string.Join(",", Model.Report.DailyTrend.Select(d => $"'{d.Date:MMM dd}'")))],
                datasets: [{
                    label: 'Payment Amount',
                    data: [@string.Join(",", Model.Report.DailyTrend.Select(d => d.Amount.ToString("F2", System.Globalization.CultureInfo.InvariantCulture)))],
                    backgroundColor: 'rgba(34, 197, 94, 0.2)',
                    borderColor: 'rgb(34, 197, 94)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.3
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) { return '$' + value.toLocaleString(); }
                        }
                    }
                }
            }
        });

        // Weekly Trend Chart
        const weeklyCtx = document.getElementById('weeklyTrendChart').getContext('2d');
        new Chart(weeklyCtx, {
            type: 'bar',
            data: {
                labels: [@Html.Raw(string.Join(",", Model.Report.WeeklyTrend.Select(w => $"'Week of {w.WeekStart:MMM dd}'")))],
                datasets: [{
                    label: 'Weekly Payments',
                    data: [@string.Join(",", Model.Report.WeeklyTrend.Select(w => w.Amount.ToString("F2", System.Globalization.CultureInfo.InvariantCulture)))],
                    backgroundColor: 'rgba(59, 130, 246, 0.7)',
                    borderColor: 'rgb(59, 130, 246)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) { return '$' + value.toLocaleString(); }
                        }
                    }
                }
            }
        });
    </script>
}
