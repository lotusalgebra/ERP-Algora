@page "{id:guid}"
@model Algora.Erp.Web.Pages.Finance.Invoices.Recurring.EditModel
@using Algora.Erp.Domain.Entities.Finance
@{
    ViewData["Title"] = $"Edit - {Model.Input.Name}";
}

<div class="p-4">
    <!-- Page Header -->
    <div class="flex justify-between items-center mb-6">
        <div>
            <h1 class="text-2xl font-semibold text-gray-900 dark:text-white mb-1">Edit Recurring Invoice</h1>
            <nav class="flex" aria-label="Breadcrumb">
                <ol class="inline-flex items-center space-x-1 text-sm text-gray-500">
                    <li><a href="/" class="hover:text-primary-600">Dashboard</a></li>
                    <li><span class="mx-2">/</span></li>
                    <li><a href="/Finance" class="hover:text-primary-600">Finance</a></li>
                    <li><span class="mx-2">/</span></li>
                    <li><a href="/Finance/Invoices/Recurring" class="hover:text-primary-600">Recurring Invoices</a></li>
                    <li><span class="mx-2">/</span></li>
                    <li class="text-gray-700 dark:text-gray-300">Edit</li>
                </ol>
            </nav>
        </div>
    </div>

    <form method="post" id="recurringForm">
        <input type="hidden" asp-for="Input.Id" />

        <div class="grid grid-cols-12 gap-6">
            <!-- Main Content -->
            <div class="col-span-12 lg:col-span-8">
                <!-- Basic Info -->
                <div class="bg-white rounded-lg shadow-md dark:bg-gray-800 mb-6">
                    <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                        <h5 class="text-lg font-medium text-gray-900 dark:text-white"><i class="bi bi-info-circle mr-2"></i>Basic Information</h5>
                    </div>
                    <div class="p-6">
                        <div class="grid grid-cols-12 gap-4">
                            <div class="col-span-12 md:col-span-6">
                                <label class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Name <span class="text-red-500">*</span></label>
                                <input type="text" asp-for="Input.Name" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="e.g., Monthly Hosting Fee" required />
                            </div>
                            <div class="col-span-12 md:col-span-6">
                                <label class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Customer <span class="text-red-500">*</span></label>
                                <select asp-for="Input.CustomerId" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white" id="customerId" required>
                                    <option value="">Select customer...</option>
                                    @foreach (var customer in Model.Customers)
                                    {
                                        <option value="@customer.Id">@customer.Name</option>
                                    }
                                </select>
                            </div>
                            <div class="col-span-12">
                                <label class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Description</label>
                                <textarea asp-for="Input.Description" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white" rows="2"></textarea>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Schedule -->
                <div class="bg-white rounded-lg shadow-md dark:bg-gray-800 mb-6">
                    <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                        <h5 class="text-lg font-medium text-gray-900 dark:text-white"><i class="bi bi-calendar-check mr-2"></i>Schedule</h5>
                    </div>
                    <div class="p-6">
                        <div class="grid grid-cols-12 gap-4">
                            <div class="col-span-12 md:col-span-4">
                                <label class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Frequency <span class="text-red-500">*</span></label>
                                <select asp-for="Input.Frequency" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white" id="frequency">
                                    @foreach (RecurrenceFrequency freq in Enum.GetValues(typeof(RecurrenceFrequency)))
                                    {
                                        <option value="@((int)freq)">@freq</option>
                                    }
                                </select>
                            </div>
                            <div class="col-span-12 md:col-span-4">
                                <label class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Every</label>
                                <div class="flex">
                                    <input type="number" asp-for="Input.FrequencyInterval" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-l-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white" min="1" max="12" />
                                    <span class="inline-flex items-center px-3 text-sm text-gray-900 bg-gray-200 border border-l-0 border-gray-300 rounded-r-lg dark:bg-gray-600 dark:text-gray-400 dark:border-gray-600" id="intervalSuffix">month(s)</span>
                                </div>
                            </div>
                            <div class="col-span-12 md:col-span-4" id="dayOfMonthContainer">
                                <label class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Day of Month</label>
                                <select asp-for="Input.DayOfMonth" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                    <option value="">Same as start date</option>
                                    @for (int i = 1; i <= 31; i++)
                                    {
                                        <option value="@i">@i</option>
                                    }
                                </select>
                            </div>
                            <div class="col-span-12 md:col-span-4 hidden" id="dayOfWeekContainer">
                                <label class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Day of Week</label>
                                <select asp-for="Input.DayOfWeek" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                    @foreach (DayOfWeek day in Enum.GetValues(typeof(DayOfWeek)))
                                    {
                                        <option value="@((int)day)">@day</option>
                                    }
                                </select>
                            </div>
                            <div class="col-span-12 md:col-span-4">
                                <label class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Start Date <span class="text-red-500">*</span></label>
                                <input type="date" asp-for="Input.StartDate" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white" required />
                            </div>
                            <div class="col-span-12 md:col-span-4">
                                <label class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">End Date</label>
                                <input type="date" asp-for="Input.EndDate" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white" />
                                <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Leave empty for indefinite</p>
                            </div>
                            <div class="col-span-12 md:col-span-4">
                                <label class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Max Occurrences</label>
                                <input type="number" asp-for="Input.MaxOccurrences" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white" min="1" placeholder="Unlimited" />
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Line Items -->
                <div class="bg-white rounded-lg shadow-md dark:bg-gray-800 mb-6">
                    <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
                        <h5 class="text-lg font-medium text-gray-900 dark:text-white"><i class="bi bi-list-ol mr-2"></i>Line Items</h5>
                        <button type="button" class="text-primary-700 border border-primary-700 hover:bg-primary-700 hover:text-white focus:ring-4 focus:ring-primary-300 font-medium rounded-lg text-sm px-3 py-1.5 dark:border-primary-500 dark:text-primary-500 dark:hover:bg-primary-600 dark:hover:text-white" id="addLineBtn">
                            <i class="bi bi-plus-lg mr-1"></i>Add Line
                        </button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left text-gray-500 dark:text-gray-400" id="linesTable">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
                                <tr>
                                    <th scope="col" class="px-4 py-3" style="width: 30%;">Product/Description</th>
                                    <th scope="col" class="px-4 py-3" style="width: 10%;">Qty</th>
                                    <th scope="col" class="px-4 py-3" style="width: 15%;">Unit Price</th>
                                    <th scope="col" class="px-4 py-3" style="width: 10%;">Disc %</th>
                                    <th scope="col" class="px-4 py-3" style="width: 10%;">Tax %</th>
                                    <th scope="col" class="px-4 py-3 text-right" style="width: 15%;">Total</th>
                                    <th scope="col" class="px-4 py-3" style="width: 5%;"></th>
                                </tr>
                            </thead>
                            <tbody id="linesBody">
                                <!-- Lines will be added here -->
                            </tbody>
                            <tfoot class="bg-gray-50 dark:bg-gray-700">
                                <tr>
                                    <td colspan="5" class="px-4 py-3 text-right font-medium">Subtotal:</td>
                                    <td class="px-4 py-3 text-right font-medium" id="subtotalDisplay">$0.00</td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td colspan="5" class="px-4 py-3 text-right">Discount:</td>
                                    <td class="px-4 py-3 text-right" id="discountDisplay">-$0.00</td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td colspan="5" class="px-4 py-3 text-right">Tax:</td>
                                    <td class="px-4 py-3 text-right" id="taxDisplay">$0.00</td>
                                    <td></td>
                                </tr>
                                <tr class="font-bold">
                                    <td colspan="5" class="px-4 py-3 text-right">Total:</td>
                                    <td class="px-4 py-3 text-right" id="totalDisplay">$0.00</td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>

                <!-- Notes -->
                <div class="bg-white rounded-lg shadow-md dark:bg-gray-800 mb-6">
                    <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                        <h5 class="text-lg font-medium text-gray-900 dark:text-white"><i class="bi bi-sticky mr-2"></i>Notes</h5>
                    </div>
                    <div class="p-6">
                        <div class="grid grid-cols-12 gap-4">
                            <div class="col-span-12 md:col-span-6">
                                <label class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Invoice Notes</label>
                                <textarea asp-for="Input.Notes" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white" rows="3" placeholder="Notes visible on invoice..."></textarea>
                            </div>
                            <div class="col-span-12 md:col-span-6">
                                <label class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Internal Notes</label>
                                <textarea asp-for="Input.InternalNotes" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white" rows="3" placeholder="Internal notes only..."></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="col-span-12 lg:col-span-4">
                <!-- Invoice Settings -->
                <div class="bg-white rounded-lg shadow-md dark:bg-gray-800 mb-6">
                    <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                        <h5 class="text-lg font-medium text-gray-900 dark:text-white"><i class="bi bi-gear mr-2"></i>Invoice Settings</h5>
                    </div>
                    <div class="p-6">
                        <div class="mb-4">
                            <label class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Invoice Type</label>
                            <select asp-for="Input.InvoiceType" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                @foreach (InvoiceType type in Enum.GetValues(typeof(InvoiceType)))
                                {
                                    <option value="@((int)type)">@type</option>
                                }
                            </select>
                        </div>
                        <div class="mb-4">
                            <label class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Payment Terms</label>
                            <select asp-for="Input.PaymentTermDays" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white" id="paymentTermDays">
                                <option value="0">Due on Receipt</option>
                                <option value="7">Net 7</option>
                                <option value="15">Net 15</option>
                                <option value="30">Net 30</option>
                                <option value="45">Net 45</option>
                                <option value="60">Net 60</option>
                                <option value="90">Net 90</option>
                            </select>
                        </div>
                        <div class="mb-4">
                            <label class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Currency</label>
                            <select asp-for="Input.Currency" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                <option value="USD">USD - US Dollar</option>
                                <option value="EUR">EUR - Euro</option>
                                <option value="GBP">GBP - British Pound</option>
                                <option value="CAD">CAD - Canadian Dollar</option>
                                <option value="AUD">AUD - Australian Dollar</option>
                            </select>
                        </div>
                        <div>
                            <label class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Reference</label>
                            <input type="text" asp-for="Input.Reference" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="PO number, contract, etc." />
                        </div>
                    </div>
                </div>

                <!-- Billing Address -->
                <div class="bg-white rounded-lg shadow-md dark:bg-gray-800 mb-6">
                    <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                        <h5 class="text-lg font-medium text-gray-900 dark:text-white"><i class="bi bi-geo-alt mr-2"></i>Billing Address</h5>
                    </div>
                    <div class="p-6">
                        <div class="mb-4">
                            <label class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Name</label>
                            <input type="text" asp-for="Input.BillingName" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white" id="billingName" />
                        </div>
                        <div class="mb-4">
                            <label class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Address</label>
                            <input type="text" asp-for="Input.BillingAddress" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white" id="billingAddress" />
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">City</label>
                                <input type="text" asp-for="Input.BillingCity" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white" id="billingCity" />
                            </div>
                            <div>
                                <label class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">State</label>
                                <input type="text" asp-for="Input.BillingState" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white" id="billingState" />
                            </div>
                            <div>
                                <label class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Postal Code</label>
                                <input type="text" asp-for="Input.BillingPostalCode" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white" id="billingPostalCode" />
                            </div>
                            <div>
                                <label class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Country</label>
                                <input type="text" asp-for="Input.BillingCountry" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white" id="billingCountry" />
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Auto-Send Options -->
                <div class="bg-white rounded-lg shadow-md dark:bg-gray-800 mb-6">
                    <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                        <h5 class="text-lg font-medium text-gray-900 dark:text-white"><i class="bi bi-envelope mr-2"></i>Auto-Send Options</h5>
                    </div>
                    <div class="p-6">
                        <div class="flex items-center mb-4">
                            <input type="checkbox" asp-for="Input.AutoSend" class="w-4 h-4 text-primary-600 bg-gray-100 border-gray-300 rounded focus:ring-primary-500 dark:focus:ring-primary-600 dark:ring-offset-gray-800 dark:bg-gray-700 dark:border-gray-600" id="autoSend" />
                            <label class="ml-2 text-sm font-medium text-gray-900 dark:text-gray-300" for="autoSend">
                                Auto-mark as sent when generated
                            </label>
                        </div>
                        <div class="flex items-center mb-4">
                            <input type="checkbox" asp-for="Input.AutoSendEmail" class="w-4 h-4 text-primary-600 bg-gray-100 border-gray-300 rounded focus:ring-primary-500 dark:focus:ring-primary-600 dark:ring-offset-gray-800 dark:bg-gray-700 dark:border-gray-600" id="autoSendEmail" />
                            <label class="ml-2 text-sm font-medium text-gray-900 dark:text-gray-300" for="autoSendEmail">
                                Email invoice automatically
                            </label>
                        </div>
                        <div id="emailRecipientsDiv" style="@(Model.Input.AutoSendEmail ? "" : "display: none;")">
                            <label class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Email Recipients</label>
                            <input type="text" asp-for="Input.EmailRecipients" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white" id="emailRecipients" placeholder="email@example.com" />
                            <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Comma-separated for multiple</p>
                        </div>
                    </div>
                </div>

                <!-- Actions -->
                <div class="flex flex-col gap-2">
                    <button type="submit" class="w-full text-white bg-primary-700 hover:bg-primary-800 focus:ring-4 focus:ring-primary-300 font-medium rounded-lg text-base px-5 py-3 dark:bg-primary-600 dark:hover:bg-primary-700">
                        <i class="bi bi-check-lg mr-1"></i>Update Recurring Invoice
                    </button>
                    <a href="/Finance/Invoices/Recurring/Details/@Model.Input.Id" class="w-full text-center text-gray-700 bg-white border border-gray-300 hover:bg-gray-100 focus:ring-4 focus:ring-gray-200 font-medium rounded-lg text-base px-5 py-3 dark:bg-gray-800 dark:text-gray-400 dark:border-gray-600 dark:hover:bg-gray-700">
                        Cancel
                    </a>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- Line Template -->
<template id="lineTemplate">
    <tr class="line-row bg-white border-b dark:bg-gray-800 dark:border-gray-700">
        <td class="px-4 py-3">
            <select class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2 dark:bg-gray-700 dark:border-gray-600 dark:text-white product-select" onchange="productChanged(this)">
                <option value="">Select product or type description...</option>
                @foreach (var product in Model.Products)
                {
                    <option value="@product.Id" data-sku="@product.Sku" data-price="@product.SellingPrice" data-tax="@product.TaxRate">
                        @product.Name
                    </option>
                }
            </select>
            <input type="hidden" class="line-product-id" name="" />
            <input type="hidden" class="line-product-code" name="" />
            <input type="text" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2 mt-1 dark:bg-gray-700 dark:border-gray-600 dark:text-white line-description" placeholder="Description" name="" />
        </td>
        <td class="px-4 py-3">
            <input type="number" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2 dark:bg-gray-700 dark:border-gray-600 dark:text-white line-qty" value="1" min="0.01" step="0.01" name="" onchange="calculateLine(this)" />
        </td>
        <td class="px-4 py-3">
            <input type="number" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2 dark:bg-gray-700 dark:border-gray-600 dark:text-white line-price" value="0" min="0" step="0.01" name="" onchange="calculateLine(this)" />
        </td>
        <td class="px-4 py-3">
            <input type="number" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2 dark:bg-gray-700 dark:border-gray-600 dark:text-white line-discount" value="0" min="0" max="100" step="0.01" name="" onchange="calculateLine(this)" />
        </td>
        <td class="px-4 py-3">
            <input type="number" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2 dark:bg-gray-700 dark:border-gray-600 dark:text-white line-tax" value="0" min="0" max="100" step="0.01" name="" onchange="calculateLine(this)" />
        </td>
        <td class="px-4 py-3 text-right">
            <span class="line-total font-medium">$0.00</span>
        </td>
        <td class="px-4 py-3">
            <button type="button" class="text-red-700 border border-red-700 hover:bg-red-700 hover:text-white focus:ring-4 focus:ring-red-300 font-medium rounded-lg text-sm p-2 dark:border-red-500 dark:text-red-500 dark:hover:bg-red-600 dark:hover:text-white" onclick="removeLine(this)">
                <i class="bi bi-trash"></i>
            </button>
        </td>
    </tr>
</template>

@section Scripts {
    <script>
        let lineIndex = 0;
        const existingLines = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Input.Lines));

        document.addEventListener('DOMContentLoaded', function() {
            updateFrequencyUI();

            if (existingLines && existingLines.length > 0) {
                existingLines.forEach(line => addLineWithData(line));
            } else {
                addLine();
            }

            document.getElementById('frequency').addEventListener('change', updateFrequencyUI);

            document.getElementById('customerId').addEventListener('change', async function() {
                if (this.value) {
                    const response = await fetch(`/Finance/Invoices/Recurring/Edit/@Model.Input.Id?handler=CustomerDetails&customerId=${this.value}`);
                    const data = await response.json();

                    document.getElementById('billingName').value = data.billingName || '';
                    document.getElementById('billingAddress').value = data.billingAddress || '';
                    document.getElementById('billingCity').value = data.billingCity || '';
                    document.getElementById('billingState').value = data.billingState || '';
                    document.getElementById('billingPostalCode').value = data.billingPostalCode || '';
                    document.getElementById('billingCountry').value = data.billingCountry || '';
                    document.getElementById('emailRecipients').value = data.email || '';
                }
            });

            document.getElementById('autoSendEmail').addEventListener('change', function() {
                document.getElementById('emailRecipientsDiv').style.display = this.checked ? 'block' : 'none';
            });
        });

        function updateFrequencyUI() {
            const freq = parseInt(document.getElementById('frequency').value);
            const dayOfMonthContainer = document.getElementById('dayOfMonthContainer');
            const dayOfWeekContainer = document.getElementById('dayOfWeekContainer');
            const intervalSuffix = document.getElementById('intervalSuffix');

            const suffixes = { 0: 'day(s)', 1: 'week(s)', 2: 'month(s)', 3: 'quarter(s)', 4: 'year(s)' };
            intervalSuffix.textContent = suffixes[freq] || 'period(s)';

            if (freq === 1) {
                dayOfMonthContainer.classList.add('hidden');
                dayOfWeekContainer.classList.remove('hidden');
            } else if (freq === 2 || freq === 3) {
                dayOfMonthContainer.classList.remove('hidden');
                dayOfWeekContainer.classList.add('hidden');
            } else {
                dayOfMonthContainer.classList.add('hidden');
                dayOfWeekContainer.classList.add('hidden');
            }
        }

        document.getElementById('addLineBtn').addEventListener('click', addLine);

        function addLine() { addLineWithData({}); }

        function addLineWithData(lineData) {
            const template = document.getElementById('lineTemplate');
            const clone = template.content.cloneNode(true);
            const row = clone.querySelector('tr');

            row.querySelector('.line-product-id').name = `Input.Lines[${lineIndex}].ProductId`;
            row.querySelector('.line-product-code').name = `Input.Lines[${lineIndex}].ProductCode`;
            row.querySelector('.line-description').name = `Input.Lines[${lineIndex}].Description`;
            row.querySelector('.line-qty').name = `Input.Lines[${lineIndex}].Quantity`;
            row.querySelector('.line-price').name = `Input.Lines[${lineIndex}].UnitPrice`;
            row.querySelector('.line-discount').name = `Input.Lines[${lineIndex}].DiscountPercent`;
            row.querySelector('.line-tax').name = `Input.Lines[${lineIndex}].TaxPercent`;

            if (lineData.productId) {
                row.querySelector('.product-select').value = lineData.productId;
                row.querySelector('.line-product-id').value = lineData.productId;
            }
            if (lineData.productCode) row.querySelector('.line-product-code').value = lineData.productCode;
            if (lineData.description) row.querySelector('.line-description').value = lineData.description;
            if (lineData.quantity) row.querySelector('.line-qty').value = lineData.quantity;
            if (lineData.unitPrice) row.querySelector('.line-price').value = lineData.unitPrice;
            if (lineData.discountPercent) row.querySelector('.line-discount').value = lineData.discountPercent;
            if (lineData.taxPercent) row.querySelector('.line-tax').value = lineData.taxPercent;

            document.getElementById('linesBody').appendChild(clone);
            lineIndex++;
            calculateTotals();
        }

        function productChanged(select) {
            const row = select.closest('tr');
            const option = select.options[select.selectedIndex];

            if (option.value) {
                row.querySelector('.line-product-id').value = option.value;
                row.querySelector('.line-product-code').value = option.dataset.sku || '';
                row.querySelector('.line-description').value = option.text;
                row.querySelector('.line-price').value = parseFloat(option.dataset.price) || 0;
                row.querySelector('.line-tax').value = parseFloat(option.dataset.tax) || 0;
            } else {
                row.querySelector('.line-product-id').value = '';
                row.querySelector('.line-product-code').value = '';
            }
            calculateLine(select);
        }

        function calculateLine(element) {
            const row = element.closest('tr');
            const qty = parseFloat(row.querySelector('.line-qty').value) || 0;
            const price = parseFloat(row.querySelector('.line-price').value) || 0;
            const discount = parseFloat(row.querySelector('.line-discount').value) || 0;
            const tax = parseFloat(row.querySelector('.line-tax').value) || 0;

            const subtotal = qty * price;
            const discountAmt = subtotal * (discount / 100);
            const afterDiscount = subtotal - discountAmt;
            const taxAmt = afterDiscount * (tax / 100);
            const total = afterDiscount + taxAmt;

            row.querySelector('.line-total').textContent = formatCurrency(total);
            calculateTotals();
        }

        function calculateTotals() {
            let subtotal = 0, totalDiscount = 0, totalTax = 0;

            document.querySelectorAll('#linesBody .line-row').forEach(row => {
                const qty = parseFloat(row.querySelector('.line-qty').value) || 0;
                const price = parseFloat(row.querySelector('.line-price').value) || 0;
                const discount = parseFloat(row.querySelector('.line-discount').value) || 0;
                const tax = parseFloat(row.querySelector('.line-tax').value) || 0;

                const lineSubtotal = qty * price;
                const discountAmt = lineSubtotal * (discount / 100);
                const afterDiscount = lineSubtotal - discountAmt;
                const taxAmt = afterDiscount * (tax / 100);

                subtotal += lineSubtotal;
                totalDiscount += discountAmt;
                totalTax += taxAmt;

                const total = afterDiscount + taxAmt;
                row.querySelector('.line-total').textContent = formatCurrency(total);
            });

            document.getElementById('subtotalDisplay').textContent = formatCurrency(subtotal);
            document.getElementById('discountDisplay').textContent = '-' + formatCurrency(totalDiscount);
            document.getElementById('taxDisplay').textContent = formatCurrency(totalTax);
            document.getElementById('totalDisplay').textContent = formatCurrency(subtotal - totalDiscount + totalTax);
        }

        function removeLine(button) {
            button.closest('tr').remove();
            calculateTotals();
            if (document.querySelectorAll('#linesBody .line-row').length === 0) addLine();
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(amount);
        }
    </script>
}
