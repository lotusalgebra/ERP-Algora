@model Algora.Erp.Web.Pages.Finance.Invoices.InvoicesTableViewModel
@using Algora.Erp.Domain.Entities.Finance

@if (Model.Invoices.Count == 0)
{
    <tr>
        <td colspan="8" class="text-center py-5 text-muted">
            <i class="bi bi-inbox fs-1 d-block mb-3"></i>
            No invoices found
        </td>
    </tr>
}
else
{
    foreach (var invoice in Model.Invoices)
    {
        var statusBadgeClass = invoice.Status switch
        {
            InvoiceStatus.Draft => "bg-secondary",
            InvoiceStatus.Pending => "bg-warning text-dark",
            InvoiceStatus.Sent => "bg-info",
            InvoiceStatus.PartiallyPaid => "bg-primary",
            InvoiceStatus.Paid => "bg-success",
            InvoiceStatus.Overdue => "bg-danger",
            InvoiceStatus.Void => "bg-dark",
            InvoiceStatus.Cancelled => "bg-secondary",
            _ => "bg-secondary"
        };

        var isOverdue = invoice.DueDate < DateTime.UtcNow &&
            invoice.Status != InvoiceStatus.Paid &&
            invoice.Status != InvoiceStatus.Void &&
            invoice.Status != InvoiceStatus.Cancelled;

        <tr>
            <td class="ps-4">
                <a href="/Finance/Invoices/Details/@invoice.Id" class="text-decoration-none fw-medium">
                    @invoice.InvoiceNumber
                </a>
            </td>
            <td>@invoice.InvoiceDate.ToString("MMM dd, yyyy")</td>
            <td>
                @if (invoice.Customer != null)
                {
                    <span>@invoice.Customer.Name</span>
                }
                else
                {
                    <span class="text-muted">-</span>
                }
            </td>
            <td>
                <span class="@(isOverdue ? "text-danger fw-medium" : "")">
                    @invoice.DueDate.ToString("MMM dd, yyyy")
                    @if (isOverdue && invoice.Status != InvoiceStatus.Overdue)
                    {
                        <i class="bi bi-exclamation-circle text-danger ms-1" title="Overdue"></i>
                    }
                </span>
            </td>
            <td class="text-end">@invoice.TotalAmount.ToString("C2")</td>
            <td class="text-end">
                @if (invoice.BalanceDue > 0)
                {
                    <span class="fw-medium">@invoice.BalanceDue.ToString("C2")</span>
                }
                else
                {
                    <span class="text-muted">$0.00</span>
                }
            </td>
            <td>
                <span class="badge @statusBadgeClass">@invoice.Status</span>
            </td>
            <td class="text-end pe-4">
                <div class="dropdown">
                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button"
                            id="dropdownInv@(invoice.Id)" data-dropdown-toggle="dropdownMenuInv@(invoice.Id)" aria-expanded="false">
                        <i class="bi bi-three-dots"></i>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end" id="dropdownMenuInv@(invoice.Id)">
                        <li>
                            <a class="dropdown-item" href="/Finance/Invoices/Details/@invoice.Id">
                                <i class="bi bi-eye me-2"></i> View
                            </a>
                        </li>
                        @if (invoice.Status == InvoiceStatus.Draft)
                        {
                            <li>
                                <a class="dropdown-item" href="/Finance/Invoices/Edit/@invoice.Id">
                                    <i class="bi bi-pencil me-2"></i> Edit
                                </a>
                            </li>
                            <li>
                                <button class="dropdown-item"
                                        hx-post="/Finance/Invoices?handler=Send&id=@invoice.Id"
                                        hx-target="#tableContent"
                                        hx-confirm="Are you sure you want to send this invoice?">
                                    <i class="bi bi-send me-2"></i> Send
                                </button>
                            </li>
                        }
                        @if (invoice.Status != InvoiceStatus.Paid && invoice.Status != InvoiceStatus.Void)
                        {
                            <li>
                                <a class="dropdown-item" href="/Finance/Invoices/Payment/@invoice.Id">
                                    <i class="bi bi-cash me-2"></i> Record Payment
                                </a>
                            </li>
                            <li>
                                <button class="dropdown-item"
                                        hx-post="/Finance/Invoices?handler=MarkPaid&id=@invoice.Id"
                                        hx-target="#tableContent"
                                        hx-confirm="Mark this invoice as fully paid?">
                                    <i class="bi bi-check-circle me-2"></i> Mark as Paid
                                </button>
                            </li>
                        }
                        <li><hr class="dropdown-divider"></li>
                        <li>
                            <a class="dropdown-item" href="/Finance/Invoices/Print/@invoice.Id" target="_blank">
                                <i class="bi bi-printer me-2"></i> Print
                            </a>
                        </li>
                        @if (invoice.Status != InvoiceStatus.Paid)
                        {
                            <li>
                                <button class="dropdown-item text-danger"
                                        hx-delete="/Finance/Invoices?id=@invoice.Id"
                                        hx-target="#tableContent"
                                        hx-confirm="Are you sure you want to delete this invoice?">
                                    <i class="bi bi-trash me-2"></i> Delete
                                </button>
                            </li>
                        }
                        else
                        {
                            <li>
                                <button class="dropdown-item text-warning"
                                        hx-post="/Finance/Invoices?handler=Void&id=@invoice.Id"
                                        hx-target="#tableContent"
                                        hx-confirm="Are you sure you want to void this invoice?">
                                    <i class="bi bi-x-circle me-2"></i> Void
                                </button>
                            </li>
                        }
                    </ul>
                </div>
            </td>
        </tr>
    }
}

<script>
    // Update pagination info
    document.getElementById('paginationInfo').innerHTML =
        'Showing @((Model.Page - 1) * Model.PageSize + 1) to @(Math.Min(Model.Page * Model.PageSize, Model.TotalRecords)) of @Model.TotalRecords entries';

    // Update pagination nav
    var paginationHtml = '';
    if (@Model.TotalPages > 1) {
        paginationHtml += '<li class="page-item @(Model.Page <= 1 ? "disabled" : "")"><a class="page-link" href="#" hx-get="/Finance/Invoices?handler=Table&page=@(Model.Page - 1)" hx-target="#tableContent" hx-include="#searchInput,#statusFilter,#typeFilter,#dateFrom,#dateTo">&laquo;</a></li>';

        for (var i = 1; i <= @Model.TotalPages; i++) {
            if (i === @Model.Page) {
                paginationHtml += '<li class="page-item active"><span class="page-link">' + i + '</span></li>';
            } else if (i <= 3 || i > @Model.TotalPages - 2 || Math.abs(i - @Model.Page) <= 1) {
                paginationHtml += '<li class="page-item"><a class="page-link" href="#" hx-get="/Finance/Invoices?handler=Table&page=' + i + '" hx-target="#tableContent" hx-include="#searchInput,#statusFilter,#typeFilter,#dateFrom,#dateTo">' + i + '</a></li>';
            } else if (Math.abs(i - @Model.Page) === 2) {
                paginationHtml += '<li class="page-item disabled"><span class="page-link">...</span></li>';
            }
        }

        paginationHtml += '<li class="page-item @(Model.Page >= Model.TotalPages ? "disabled" : "")"><a class="page-link" href="#" hx-get="/Finance/Invoices?handler=Table&page=@(Model.Page + 1)" hx-target="#tableContent" hx-include="#searchInput,#statusFilter,#typeFilter,#dateFrom,#dateTo">&raquo;</a></li>';
    }
    document.querySelector('#paginationNav ul').innerHTML = paginationHtml;
    htmx.process(document.getElementById('paginationNav'));
</script>
