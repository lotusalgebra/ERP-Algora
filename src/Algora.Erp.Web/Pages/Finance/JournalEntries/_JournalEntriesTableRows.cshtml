@model Algora.Erp.Web.Pages.Finance.JournalEntries.JournalEntriesTableViewModel
@using Algora.Erp.Domain.Entities.Finance

@foreach (var entry in Model.Entries)
{
    var statusColor = entry.Status switch
    {
        JournalEntryStatus.Draft => "secondary",
        JournalEntryStatus.Pending => "warning",
        JournalEntryStatus.Posted => "success",
        JournalEntryStatus.Reversed => "info",
        JournalEntryStatus.Void => "danger",
        _ => "secondary"
    };

    var typeColor = entry.EntryType switch
    {
        JournalEntryType.General => "primary",
        JournalEntryType.Sales => "success",
        JournalEntryType.Purchase => "info",
        JournalEntryType.CashReceipt => "success",
        JournalEntryType.CashPayment => "danger",
        JournalEntryType.Payroll => "warning",
        JournalEntryType.Adjustment => "secondary",
        JournalEntryType.Closing => "dark",
        JournalEntryType.Opening => "primary",
        _ => "secondary"
    };

    <tr>
        <td class="ps-4">
            <a href="/Finance/JournalEntries/Edit/@entry.Id" class="text-decoration-none fw-semibold">
                @entry.EntryNumber
            </a>
            @if (!string.IsNullOrEmpty(entry.Reference))
            {
                <br><small class="text-muted">Ref: @entry.Reference</small>
            }
        </td>
        <td>@entry.EntryDate.ToString("MMM dd, yyyy")</td>
        <td>
            <span title="@entry.Description">
                @(entry.Description.Length > 40 ? entry.Description.Substring(0, 40) + "..." : entry.Description)
            </span>
            <br>
            <small class="text-muted">@entry.Lines.Count line(s)</small>
        </td>
        <td>
            <span class="badge bg-@typeColor bg-opacity-10 text-@typeColor">@entry.EntryType</span>
        </td>
        <td class="text-end fw-semibold">@entry.TotalDebit.ToString("C2")</td>
        <td class="text-end fw-semibold">@entry.TotalCredit.ToString("C2")</td>
        <td>
            <span class="badge bg-@statusColor">@entry.Status</span>
            @if (entry.TotalDebit != entry.TotalCredit)
            {
                <span class="badge bg-danger ms-1">Unbalanced</span>
            }
        </td>
        <td class="text-end pe-4">
            <div class="dropdown">
                <button class="btn btn-sm btn-light" id="dropdownJE@(entry.Id)" data-dropdown-toggle="dropdownMenuJE@(entry.Id)">
                    <i class="bi bi-three-dots-vertical"></i>
                </button>
                <ul class="dropdown-menu dropdown-menu-end" id="dropdownMenuJE@(entry.Id)">
                    <li>
                        <a class="dropdown-item" href="/Finance/JournalEntries/Edit/@entry.Id">
                            <i class="bi bi-eye me-2"></i> View / Edit
                        </a>
                    </li>
                    @if (entry.Status == JournalEntryStatus.Draft || entry.Status == JournalEntryStatus.Pending)
                    {
                        @if (entry.TotalDebit == entry.TotalCredit && entry.TotalDebit > 0)
                        {
                            <li>
                                <a class="dropdown-item text-success" href="#"
                                   hx-post="/Finance/JournalEntries?handler=Post&id=@entry.Id"
                                   hx-target="#tableContent"
                                   hx-confirm="Post this journal entry? This will update account balances.">
                                    <i class="bi bi-check-circle me-2"></i> Post
                                </a>
                            </li>
                        }
                        <li><hr class="dropdown-divider"></li>
                        <li>
                            <a class="dropdown-item text-danger" href="#"
                               hx-delete="/Finance/JournalEntries?handler=&id=@entry.Id"
                               hx-target="#tableContent"
                               hx-confirm="Are you sure you want to delete this entry?">
                                <i class="bi bi-trash me-2"></i> Delete
                            </a>
                        </li>
                    }
                    @if (entry.Status == JournalEntryStatus.Posted)
                    {
                        <li>
                            <a class="dropdown-item" href="/Finance/JournalEntries/Create?reverseId=@entry.Id">
                                <i class="bi bi-arrow-counterclockwise me-2"></i> Create Reversal
                            </a>
                        </li>
                    }
                </ul>
            </div>
        </td>
    </tr>
}

@if (!Model.Entries.Any())
{
    <tr>
        <td colspan="8" class="text-center py-5">
            <div class="text-muted">
                <i class="bi bi-journal-text fs-1 d-block mb-2"></i>
                <p class="mb-0">No journal entries found</p>
            </div>
        </td>
    </tr>
}

<script>
    document.getElementById('paginationInfo').textContent =
        'Showing @((Model.Page - 1) * Model.PageSize + 1) to @(Math.Min(Model.Page * Model.PageSize, Model.TotalRecords)) of @Model.TotalRecords entries';

    var paginationHtml = '';
    @if (Model.TotalPages > 1)
    {
        @for (int i = 1; i <= Model.TotalPages; i++)
        {
            var activeClass = i == Model.Page ? "active" : "";
            <text>
            paginationHtml += '<li class="page-item @activeClass"><a class="page-link" href="#" hx-get="/Finance/JournalEntries?handler=Table&page=@i" hx-target="#tableContent" hx-include="#searchInput,#statusFilter,#typeFilter,#dateFrom,#dateTo">@i</a></li>';
            </text>
        }
    }
    document.querySelector('#paginationNav .pagination').innerHTML = paginationHtml;
</script>
