@using Algora.Erp.Domain.Entities.Projects
@using ProjectTaskStatus = Algora.Erp.Domain.Entities.Projects.TaskStatus
@model Algora.Erp.Domain.Entities.Projects.Project

@{
    var statusClass = Model.Status switch
    {
        ProjectStatus.Planning => "bg-secondary",
        ProjectStatus.Active => "bg-primary",
        ProjectStatus.OnHold => "bg-warning",
        ProjectStatus.Completed => "bg-success",
        ProjectStatus.Cancelled => "bg-danger",
        _ => "bg-secondary"
    };

    var priorityClass = Model.Priority switch
    {
        ProjectPriority.Low => "bg-light text-dark",
        ProjectPriority.Normal => "bg-info",
        ProjectPriority.High => "bg-warning",
        ProjectPriority.Critical => "bg-danger",
        _ => "bg-info"
    };

    var progressPercent = (int)Model.Progress;
    var totalHours = Model.TimeEntries.Sum(t => t.Hours);
    var completedTasks = Model.Tasks.Count(t => t.Status == ProjectTaskStatus.Completed);
    var totalTasks = Model.Tasks.Count;
}

<div class="modal-header">
    <h5 class="modal-title">
        <i class="bi bi-kanban me-2"></i>@Model.ProjectCode
    </h5>
    <button type="button" class="btn-close" data-modal-hide="detailsModal" aria-label="Close"></button>
</div>
<div class="modal-body">
    <!-- Header Info -->
    <div class="row mb-4">
        <div class="col-md-8">
            <h4 class="mb-1">@Model.Name</h4>
            @if (!string.IsNullOrEmpty(Model.Description))
            {
                <p class="text-muted mb-0">@Model.Description</p>
            }
        </div>
        <div class="col-md-4 text-end">
            <span class="badge @statusClass fs-6 me-2">@Model.Status</span>
            <span class="badge @priorityClass">@Model.Priority</span>
        </div>
    </div>

    <!-- Progress -->
    <div class="card border mb-4">
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <h6 class="text-muted mb-3">Overall Progress</h6>
                    <div class="d-flex align-items-center mb-2">
                        <div class="progress flex-grow-1" style="height: 20px;">
                            <div class="progress-bar @(progressPercent >= 100 ? "bg-success" : "bg-primary")"
                                 style="width: @progressPercent%">
                                @progressPercent%
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <h6 class="text-muted mb-3">Statistics</h6>
                    <div class="row text-center">
                        <div class="col-4">
                            <div class="fs-4 fw-bold text-primary">@totalTasks</div>
                            <small class="text-muted">Tasks</small>
                        </div>
                        <div class="col-4">
                            <div class="fs-4 fw-bold text-success">@completedTasks</div>
                            <small class="text-muted">Completed</small>
                        </div>
                        <div class="col-4">
                            <div class="fs-4 fw-bold text-info">@totalHours.ToString("N1")</div>
                            <small class="text-muted">Hours</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Details -->
    <div class="row g-3 mb-4">
        <div class="col-md-6">
            <div class="card border h-100">
                <div class="card-body">
                    <h6 class="text-muted mb-3">Project Details</h6>
                    <dl class="row mb-0">
                        <dt class="col-sm-5">Customer</dt>
                        <dd class="col-sm-7">@(Model.Customer?.Name ?? "-")</dd>
                        <dt class="col-sm-5">Manager</dt>
                        <dd class="col-sm-7">
                            @if (Model.ProjectManager != null)
                            {
                                @($"{Model.ProjectManager.FirstName} {Model.ProjectManager.LastName}")
                            }
                            else
                            {
                                <span>-</span>
                            }
                        </dd>
                        <dt class="col-sm-5">Budget</dt>
                        <dd class="col-sm-7 fw-bold text-primary">@Model.BudgetAmount.ToString("C")</dd>
                        <dt class="col-sm-5">Actual Cost</dt>
                        <dd class="col-sm-7">@Model.ActualCost.ToString("C")</dd>
                    </dl>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card border h-100">
                <div class="card-body">
                    <h6 class="text-muted mb-3">Schedule</h6>
                    <dl class="row mb-0">
                        <dt class="col-sm-5">Planned Start</dt>
                        <dd class="col-sm-7">@Model.StartDate.ToString("MMM dd, yyyy")</dd>
                        <dt class="col-sm-5">Planned End</dt>
                        <dd class="col-sm-7">@(Model.EndDate?.ToString("MMM dd, yyyy") ?? "-")</dd>
                        <dt class="col-sm-5">Actual Start</dt>
                        <dd class="col-sm-7">@(Model.ActualStartDate?.ToString("MMM dd, yyyy") ?? "-")</dd>
                        <dt class="col-sm-5">Actual End</dt>
                        <dd class="col-sm-7">@(Model.ActualEndDate?.ToString("MMM dd, yyyy") ?? "-")</dd>
                    </dl>
                </div>
            </div>
        </div>
    </div>

    <!-- Team Members -->
    @if (Model.Members.Any())
    {
        <div class="card border mb-4">
            <div class="card-header bg-light">
                <h6 class="mb-0">
                    <i class="bi bi-people me-2"></i>Team Members
                    <span class="badge bg-primary ms-2">@Model.Members.Count</span>
                </h6>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-sm table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th class="ps-3">Name</th>
                                <th>Role</th>
                                <th>Hourly Rate</th>
                                <th>Joined</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var member in Model.Members.Where(m => m.IsActive))
                            {
                                var roleClass = member.Role switch
                                {
                                    ProjectRole.Manager => "bg-primary",
                                    ProjectRole.Lead => "bg-info",
                                    ProjectRole.Member => "bg-secondary",
                                    ProjectRole.Stakeholder => "bg-warning",
                                    _ => "bg-secondary"
                                };

                                <tr>
                                    <td class="ps-3">@member.Employee?.FirstName @member.Employee?.LastName</td>
                                    <td><span class="badge @roleClass">@member.Role</span></td>
                                    <td>@member.HourlyRate.ToString("C")/hr</td>
                                    <td>@member.JoinedAt.ToString("MMM dd, yyyy")</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    }

    <!-- Tasks -->
    @if (Model.Tasks.Any())
    {
        <div class="card border mb-4">
            <div class="card-header bg-light">
                <h6 class="mb-0">
                    <i class="bi bi-list-task me-2"></i>Tasks
                    <span class="badge bg-primary ms-2">@Model.Tasks.Count</span>
                </h6>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-sm table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th class="ps-3">#</th>
                                <th>Title</th>
                                <th>Assignee</th>
                                <th>Priority</th>
                                <th>Status</th>
                                <th>Due Date</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var task in Model.Tasks.OrderBy(t => t.SortOrder).Take(10))
                            {
                                var taskStatusClass = task.Status switch
                                {
                                    ProjectTaskStatus.Todo => "bg-secondary",
                                    ProjectTaskStatus.InProgress => "bg-primary",
                                    ProjectTaskStatus.InReview => "bg-info",
                                    ProjectTaskStatus.Completed => "bg-success",
                                    ProjectTaskStatus.Cancelled => "bg-danger",
                                    _ => "bg-secondary"
                                };

                                var taskPriorityClass = task.Priority switch
                                {
                                    TaskPriority.Low => "text-muted",
                                    TaskPriority.Normal => "text-dark",
                                    TaskPriority.High => "text-warning",
                                    TaskPriority.Urgent => "text-danger",
                                    _ => "text-dark"
                                };

                                <tr>
                                    <td class="ps-3 text-muted small">@task.TaskNumber</td>
                                    <td>@task.Title</td>
                                    <td>
                                        @if (task.Assignee != null)
                                        {
                                            @($"{task.Assignee.FirstName} {task.Assignee.LastName.Substring(0, 1)}.")
                                        }
                                        else
                                        {
                                            <span class="text-muted">-</span>
                                        }
                                    </td>
                                    <td class="@taskPriorityClass">@task.Priority</td>
                                    <td><span class="badge @taskStatusClass">@task.Status</span></td>
                                    <td>@(task.DueDate?.ToString("MMM dd") ?? "-")</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
                @if (Model.Tasks.Count > 10)
                {
                    <div class="text-center py-2 bg-light">
                        <small class="text-muted">Showing 10 of @Model.Tasks.Count tasks</small>
                    </div>
                }
            </div>
        </div>
    }

    <!-- Milestones -->
    @if (Model.Milestones.Any())
    {
        <div class="card border">
            <div class="card-header bg-light">
                <h6 class="mb-0">
                    <i class="bi bi-flag me-2"></i>Milestones
                    <span class="badge bg-primary ms-2">@Model.Milestones.Count</span>
                </h6>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-sm table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th class="ps-3">Milestone</th>
                                <th>Due Date</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var milestone in Model.Milestones.OrderBy(m => m.DueDate))
                            {
                                var msStatusClass = milestone.Status switch
                                {
                                    MilestoneStatus.Pending => "bg-secondary",
                                    MilestoneStatus.InProgress => "bg-primary",
                                    MilestoneStatus.Completed => "bg-success",
                                    MilestoneStatus.Missed => "bg-danger",
                                    _ => "bg-secondary"
                                };

                                <tr class="@(milestone.IsOverdue ? "table-danger" : "")">
                                    <td class="ps-3">
                                        @milestone.Name
                                        @if (milestone.IsOverdue)
                                        {
                                            <i class="bi bi-exclamation-triangle text-danger ms-1"></i>
                                        }
                                    </td>
                                    <td>@milestone.DueDate.ToString("MMM dd, yyyy")</td>
                                    <td><span class="badge @msStatusClass">@milestone.Status</span></td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    }

    @if (!string.IsNullOrEmpty(Model.Notes))
    {
        <div class="card border mt-4">
            <div class="card-header bg-light">
                <h6 class="mb-0"><i class="bi bi-journal-text me-2"></i>Notes</h6>
            </div>
            <div class="card-body">
                <p class="mb-0">@Model.Notes</p>
            </div>
        </div>
    }

    <!-- Timestamps -->
    <div class="row mt-4">
        <div class="col-12">
            <small class="text-muted">
                Created: @Model.CreatedAt.ToString("MMM dd, yyyy HH:mm")
                @if (Model.ModifiedAt.HasValue)
                {
                    <span class="ms-3">Modified: @Model.ModifiedAt.Value.ToString("MMM dd, yyyy HH:mm")</span>
                }
            </small>
        </div>
    </div>
</div>
<div class="modal-footer">
    <button type="button" class="btn btn-secondary" data-modal-hide="detailsModal">Close</button>
    @if (Model.Status == ProjectStatus.Planning || Model.Status == ProjectStatus.OnHold)
    {
        <button type="button"
                class="px-4 py-2 text-sm font-medium text-white bg-primary-600 rounded-lg hover:bg-primary-700"
                hx-get="/Projects?handler=EditForm&id=@Model.Id"
                hx-target="#formModalContent"
                data-modal-hide="detailsModal"
                onclick="setTimeout(() => { const modal = FlowbiteInstances.getInstance('Modal', 'formModal'); if(modal) modal.show(); }, 300)">
            <i class="bi bi-pencil me-1"></i> Edit
        </button>
    }
</div>
