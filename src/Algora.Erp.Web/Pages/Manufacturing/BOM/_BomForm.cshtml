@using Algora.Erp.Domain.Entities.Manufacturing
@model Algora.Erp.Web.Pages.Manufacturing.BOM.BomFormViewModel

@{
    var title = Model.IsEdit ? "Edit Bill of Material" : "New Bill of Material";
    var bom = Model.Bom;
}

<div class="modal-header">
    <h5 class="modal-title">@title</h5>
    <button type="button" class="btn-close" data-modal-hide="formModal" aria-label="Close"></button>
</div>
<form hx-post="/Manufacturing/BOM"
      hx-target="#bomTableContainer"
      hx-swap="innerHTML">
    <div class="modal-body">
        @if (Model.IsEdit && bom != null)
        {
            <input type="hidden" name="Id" value="@bom.Id" />
        }

        <div class="row g-3 mb-4">
            <div class="col-md-6">
                <label class="form-label">Name <span class="text-danger">*</span></label>
                <input type="text"
                       name="Name"
                       class="form-control"
                       value="@bom?.Name"
                       required />
            </div>
            <div class="col-md-6">
                <label class="form-label">Product <span class="text-danger">*</span></label>
                <select name="ProductId" class="form-select" required>
                    <option value="">Select Product...</option>
                    @foreach (var product in Model.Products)
                    {
                        <option value="@product.Id" selected="@(bom?.ProductId == product.Id)">@product.Name (@product.Sku)</option>
                    }
                </select>
            </div>
        </div>

        <div class="row g-3 mb-4">
            <div class="col-md-12">
                <label class="form-label">Description</label>
                <textarea name="Description"
                          class="form-control"
                          rows="2">@bom?.Description</textarea>
            </div>
        </div>

        <div class="row g-3 mb-4">
            <div class="col-md-3">
                <label class="form-label">Quantity <span class="text-danger">*</span></label>
                <input type="number"
                       name="Quantity"
                       class="form-control"
                       value="@(bom?.Quantity ?? 1)"
                       step="0.0001"
                       min="0.0001"
                       required />
            </div>
            <div class="col-md-3">
                <label class="form-label">Unit of Measure</label>
                <input type="text"
                       name="UnitOfMeasure"
                       class="form-control"
                       value="@bom?.UnitOfMeasure"
                       placeholder="e.g., EA, PCS" />
            </div>
            <div class="col-md-3">
                <label class="form-label">Status</label>
                <select name="Status" class="form-select">
                    @foreach (BomStatus status in Enum.GetValues(typeof(BomStatus)))
                    {
                        <option value="@status" selected="@(bom?.Status == status)">@status</option>
                    }
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Active</label>
                <div class="form-check form-switch mt-2">
                    <input type="checkbox"
                           name="IsActive"
                           class="form-check-input"
                           value="true"
                           @(bom?.IsActive != false ? "checked" : "") />
                    <label class="form-check-label">Active</label>
                </div>
            </div>
        </div>

        <div class="row g-3 mb-4">
            <div class="col-md-6">
                <label class="form-label">Effective From</label>
                <input type="date"
                       name="EffectiveFrom"
                       class="form-control"
                       value="@bom?.EffectiveFrom?.ToString("yyyy-MM-dd")" />
            </div>
            <div class="col-md-6">
                <label class="form-label">Effective To</label>
                <input type="date"
                       name="EffectiveTo"
                       class="form-control"
                       value="@bom?.EffectiveTo?.ToString("yyyy-MM-dd")" />
            </div>
        </div>

        <div class="mb-4">
            <label class="form-label">Notes</label>
            <textarea name="Notes"
                      class="form-control"
                      rows="2">@bom?.Notes</textarea>
        </div>

        <!-- Materials/Components Section -->
        <div class="border rounded p-3 bg-light">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h6 class="mb-0"><i class="bi bi-box-seam me-2"></i>Materials / Components</h6>
                <button type="button" class="btn btn-sm btn-outline-primary" onclick="addBomLine()">
                    <i class="bi bi-plus-lg me-1"></i> Add Material
                </button>
            </div>

            <div class="table-responsive">
                <table class="table table-sm table-bordered mb-0" id="bomLinesTable">
                    <thead class="table-light">
                        <tr>
                            <th style="width: 30%">Product</th>
                            <th style="width: 15%">Quantity</th>
                            <th style="width: 15%">Wastage %</th>
                            <th style="width: 10%">Optional</th>
                            <th style="width: 25%">Notes</th>
                            <th style="width: 5%"></th>
                        </tr>
                    </thead>
                    <tbody id="bomLinesBody">
                        @if (bom?.Lines != null && bom.Lines.Any())
                        {
                            var index = 0;
                            @foreach (var line in bom.Lines.OrderBy(l => l.LineNumber))
                            {
                                <tr class="bom-line-row">
                                    <td>
                                        <select name="Lines[@index].ProductId" class="form-select form-select-sm" required>
                                            <option value="">Select...</option>
                                            @foreach (var product in Model.Products)
                                            {
                                                <option value="@product.Id" selected="@(line.ProductId == product.Id)">@product.Name</option>
                                            }
                                        </select>
                                    </td>
                                    <td>
                                        <input type="number" name="Lines[@index].Quantity" class="form-control form-control-sm"
                                               value="@line.Quantity" step="0.0001" min="0.0001" required />
                                    </td>
                                    <td>
                                        <input type="number" name="Lines[@index].WastagePercent" class="form-control form-control-sm"
                                               value="@line.WastagePercent" step="0.01" min="0" max="100" />
                                    </td>
                                    <td class="text-center">
                                        <input type="checkbox" name="Lines[@index].IsOptional" class="form-check-input"
                                               value="true" @(line.IsOptional ? "checked" : "") />
                                    </td>
                                    <td>
                                        <input type="text" name="Lines[@index].Notes" class="form-control form-control-sm"
                                               value="@line.Notes" />
                                    </td>
                                    <td class="text-center">
                                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeBomLine(this)">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                                index++;
                            }
                        }
                    </tbody>
                </table>
            </div>
            <div id="noLinesMessage" class="text-center text-muted py-3" style="@(bom?.Lines?.Any() == true ? "display:none;" : "")">
                <i class="bi bi-inbox fs-4 d-block mb-2"></i>
                No materials added. Click "Add Material" to add components.
            </div>
        </div>
    </div>
    <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-modal-hide="formModal">Cancel</button>
        <button type="submit" class="btn btn-primary">
            <i class="bi bi-check-lg me-1"></i> @(Model.IsEdit ? "Update" : "Create") BOM
        </button>
    </div>
</form>

<script>
    var lineIndex = @(bom?.Lines?.Count ?? 0);
    var productsJson = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Products.Select(p => new { p.Id, p.Name })));

    function addBomLine() {
        var tbody = document.getElementById('bomLinesBody');
        var noLinesMessage = document.getElementById('noLinesMessage');
        noLinesMessage.style.display = 'none';

        var productOptions = '<option value="">Select...</option>';
        productsJson.forEach(function(p) {
            productOptions += '<option value="' + p.id + '">' + p.name + '</option>';
        });

        var row = document.createElement('tr');
        row.className = 'bom-line-row';
        row.innerHTML = `
            <td>
                <select name="Lines[${lineIndex}].ProductId" class="form-select form-select-sm" required>
                    ${productOptions}
                </select>
            </td>
            <td>
                <input type="number" name="Lines[${lineIndex}].Quantity" class="form-control form-control-sm"
                       value="1" step="0.0001" min="0.0001" required />
            </td>
            <td>
                <input type="number" name="Lines[${lineIndex}].WastagePercent" class="form-control form-control-sm"
                       value="0" step="0.01" min="0" max="100" />
            </td>
            <td class="text-center">
                <input type="checkbox" name="Lines[${lineIndex}].IsOptional" class="form-check-input" value="true" />
            </td>
            <td>
                <input type="text" name="Lines[${lineIndex}].Notes" class="form-control form-control-sm" />
            </td>
            <td class="text-center">
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeBomLine(this)">
                    <i class="bi bi-trash"></i>
                </button>
            </td>
        `;
        tbody.appendChild(row);
        lineIndex++;
    }

    function removeBomLine(button) {
        var row = button.closest('tr');
        row.remove();

        // Show no lines message if no rows left
        var tbody = document.getElementById('bomLinesBody');
        if (tbody.children.length === 0) {
            document.getElementById('noLinesMessage').style.display = 'block';
        }
    }
</script>
