@using Algora.Erp.Domain.Entities.Manufacturing
@model Algora.Erp.Web.Pages.Manufacturing.WorkOrders.WorkOrderFormViewModel

@{
    var title = Model.IsEdit ? "Edit Work Order" : "New Work Order";
    var wo = Model.WorkOrder;
}

<div class="flex items-center justify-between p-4 border-b rounded-t">
    <h3 class="text-xl font-semibold text-gray-900">@title</h3>
    <button type="button" class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm w-8 h-8 inline-flex justify-center items-center" data-modal-hide="formModal" aria-label="Close">
        <i class="bi bi-x-lg"></i>
    </button>
</div>
<form hx-post="/Manufacturing/WorkOrders"
      hx-target="#workOrdersTableContainer"
      hx-swap="innerHTML">
    <div class="p-6">
        @if (Model.IsEdit && wo != null)
        {
            <input type="hidden" name="Id" value="@wo.Id" />
        }

        <div class="grid grid-cols-12 gap-3 mb-4">
            <div class="md:col-span-6 col-span-12">
                <label class="block mb-2 text-sm font-medium text-gray-900">Name <span class="text-red-500">*</span></label>
                <input type="text"
                       name="Name"
                       class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5"
                       value="@wo?.Name"
                       required />
            </div>
            <div class="md:col-span-6 col-span-12">
                <label class="block mb-2 text-sm font-medium text-gray-900">Bill of Material</label>
                <select name="BillOfMaterialId" id="bomSelect" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5" onchange="loadBomMaterials()">
                    <option value="">No BOM (Manual)</option>
                    @foreach (var bom in Model.BillOfMaterials)
                    {
                        <option value="@bom.Id" data-product-id="@bom.ProductId" selected="@(wo?.BillOfMaterialId == bom.Id)">
                            @bom.BomNumber - @bom.Name (@bom.Product?.Name)
                        </option>
                    }
                </select>
            </div>
        </div>

        <div class="grid grid-cols-12 gap-3 mb-4">
            <div class="md:col-span-6 col-span-12">
                <label class="block mb-2 text-sm font-medium text-gray-900">Product <span class="text-red-500">*</span></label>
                <select name="ProductId" id="productSelect" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5" required>
                    <option value="">Select Product...</option>
                    @foreach (var product in Model.Products)
                    {
                        <option value="@product.Id" selected="@(wo?.ProductId == product.Id)">@product.Name (@product.Sku)</option>
                    }
                </select>
            </div>
            <div class="md:col-span-6 col-span-12">
                <label class="block mb-2 text-sm font-medium text-gray-900">Warehouse</label>
                <select name="WarehouseId" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5">
                    <option value="">Select Warehouse...</option>
                    @foreach (var wh in Model.Warehouses)
                    {
                        <option value="@wh.Id" selected="@(wo?.WarehouseId == wh.Id)">@wh.Name (@wh.Code)</option>
                    }
                </select>
            </div>
        </div>

        <div class="grid grid-cols-12 gap-3 mb-4">
            <div class="md:col-span-3 col-span-6">
                <label class="block mb-2 text-sm font-medium text-gray-900">Planned Quantity <span class="text-red-500">*</span></label>
                <input type="number"
                       name="PlannedQuantity"
                       class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5"
                       value="@(wo?.PlannedQuantity ?? 1)"
                       step="0.0001"
                       min="0.0001"
                       required />
            </div>
            <div class="md:col-span-3 col-span-6">
                <label class="block mb-2 text-sm font-medium text-gray-900">Unit of Measure</label>
                <input type="text"
                       name="UnitOfMeasure"
                       class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5"
                       value="@wo?.UnitOfMeasure"
                       placeholder="e.g., EA, PCS" />
            </div>
            <div class="md:col-span-3 col-span-6">
                <label class="block mb-2 text-sm font-medium text-gray-900">Status</label>
                <select name="Status" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5">
                    @foreach (WorkOrderStatus status in Enum.GetValues(typeof(WorkOrderStatus)))
                    {
                        if (status == WorkOrderStatus.InProgress || status == WorkOrderStatus.Completed || status == WorkOrderStatus.Cancelled)
                            continue; // These are set via workflow actions
                        <option value="@status" selected="@(wo?.Status == status)">@status</option>
                    }
                </select>
            </div>
            <div class="md:col-span-3 col-span-6">
                <label class="block mb-2 text-sm font-medium text-gray-900">Priority</label>
                <select name="Priority" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5">
                    @foreach (WorkOrderPriority priority in Enum.GetValues(typeof(WorkOrderPriority)))
                    {
                        <option value="@priority" selected="@(wo?.Priority == priority)">@priority</option>
                    }
                </select>
            </div>
        </div>

        <div class="grid grid-cols-12 gap-3 mb-4">
            <div class="md:col-span-4 col-span-12">
                <label class="block mb-2 text-sm font-medium text-gray-900">Planned Start Date <span class="text-red-500">*</span></label>
                <input type="date"
                       name="PlannedStartDate"
                       class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5"
                       value="@(wo?.PlannedStartDate.ToString("yyyy-MM-dd") ?? DateTime.Today.ToString("yyyy-MM-dd"))"
                       required />
            </div>
            <div class="md:col-span-4 col-span-12">
                <label class="block mb-2 text-sm font-medium text-gray-900">Planned End Date <span class="text-red-500">*</span></label>
                <input type="date"
                       name="PlannedEndDate"
                       class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5"
                       value="@(wo?.PlannedEndDate.ToString("yyyy-MM-dd") ?? DateTime.Today.AddDays(7).ToString("yyyy-MM-dd"))"
                       required />
            </div>
            <div class="md:col-span-4 col-span-12">
                <label class="block mb-2 text-sm font-medium text-gray-900">Estimated Cost</label>
                <input type="number"
                       name="EstimatedCost"
                       class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5"
                       value="@wo?.EstimatedCost"
                       step="0.01"
                       min="0" />
            </div>
        </div>

        <div class="mb-4">
            <label class="block mb-2 text-sm font-medium text-gray-900">Notes</label>
            <textarea name="Notes"
                      class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5"
                      rows="2">@wo?.Notes</textarea>
        </div>

        <!-- Operations Section -->
        <div class="border border-gray-200 rounded-lg p-4 bg-gray-50 mb-4">
            <div class="flex justify-between items-center mb-3">
                <h6 class="text-sm font-medium text-gray-900"><i class="bi bi-gear mr-2"></i>Operations</h6>
                <button type="button" class="text-primary-600 border border-primary-600 hover:bg-primary-50 focus:ring-4 focus:ring-primary-300 font-medium rounded-lg text-xs px-3 py-2" onclick="addOperation()">
                    <i class="bi bi-plus-lg mr-1"></i> Add Operation
                </button>
            </div>

            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left text-gray-500" id="operationsTable">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-100">
                        <tr>
                            <th scope="col" class="px-3 py-2" style="width: 5%">#</th>
                            <th scope="col" class="px-3 py-2" style="width: 25%">Name</th>
                            <th scope="col" class="px-3 py-2" style="width: 20%">Workstation</th>
                            <th scope="col" class="px-3 py-2" style="width: 15%">Planned Hours</th>
                            <th scope="col" class="px-3 py-2" style="width: 30%">Description</th>
                            <th scope="col" class="px-3 py-2" style="width: 5%"></th>
                        </tr>
                    </thead>
                    <tbody id="operationsBody" class="bg-white">
                        @if (wo?.Operations != null && wo.Operations.Any())
                        {
                            var opIndex = 0;
                            @foreach (var op in wo.Operations.OrderBy(o => o.OperationNumber))
                            {
                                <tr class="operation-row border-b border-gray-200">
                                    <td class="px-3 py-2 text-center align-middle op-number">@(opIndex + 1)</td>
                                    <td class="px-3 py-2">
                                        <input type="text" name="Operations[@opIndex].Name" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2"
                                               value="@op.Name" required />
                                    </td>
                                    <td class="px-3 py-2">
                                        <input type="text" name="Operations[@opIndex].Workstation" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2"
                                               value="@op.Workstation" />
                                    </td>
                                    <td class="px-3 py-2">
                                        <input type="number" name="Operations[@opIndex].PlannedHours" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2"
                                               value="@op.PlannedHours" step="0.01" min="0" />
                                    </td>
                                    <td class="px-3 py-2">
                                        <input type="text" name="Operations[@opIndex].Description" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2"
                                               value="@op.Description" />
                                    </td>
                                    <td class="px-3 py-2 text-center">
                                        <button type="button" class="text-red-600 border border-red-600 hover:bg-red-50 focus:ring-4 focus:ring-red-300 font-medium rounded-lg text-xs px-2 py-1.5" onclick="removeOperation(this)">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                                opIndex++;
                            }
                        }
                    </tbody>
                </table>
            </div>
            <div id="noOperationsMessage" class="text-center text-gray-500 py-4" style="@(wo?.Operations?.Any() == true ? "display:none;" : "")">
                <i class="bi bi-gear text-2xl block mb-2"></i>
                No operations defined. Click "Add Operation" to add production steps.
            </div>
        </div>

        <!-- Materials Section -->
        <div class="border border-gray-200 rounded-lg p-4 bg-gray-50">
            <div class="flex justify-between items-center mb-3">
                <h6 class="text-sm font-medium text-gray-900"><i class="bi bi-box-seam mr-2"></i>Materials Required</h6>
                <button type="button" class="text-primary-600 border border-primary-600 hover:bg-primary-50 focus:ring-4 focus:ring-primary-300 font-medium rounded-lg text-xs px-3 py-2" onclick="addMaterial()">
                    <i class="bi bi-plus-lg mr-1"></i> Add Material
                </button>
            </div>

            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left text-gray-500" id="materialsTable">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-100">
                        <tr>
                            <th scope="col" class="px-3 py-2" style="width: 60%">Product</th>
                            <th scope="col" class="px-3 py-2" style="width: 30%">Required Quantity</th>
                            <th scope="col" class="px-3 py-2" style="width: 10%"></th>
                        </tr>
                    </thead>
                    <tbody id="materialsBody" class="bg-white">
                        @if (wo?.Materials != null && wo.Materials.Any())
                        {
                            var matIndex = 0;
                            @foreach (var mat in wo.Materials.OrderBy(m => m.LineNumber))
                            {
                                <tr class="material-row border-b border-gray-200">
                                    <td class="px-3 py-2">
                                        <select name="Materials[@matIndex].ProductId" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2" required>
                                            <option value="">Select...</option>
                                            @foreach (var product in Model.Products)
                                            {
                                                <option value="@product.Id" selected="@(mat.ProductId == product.Id)">@product.Name</option>
                                            }
                                        </select>
                                    </td>
                                    <td class="px-3 py-2">
                                        <input type="number" name="Materials[@matIndex].RequiredQuantity" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2"
                                               value="@mat.RequiredQuantity" step="0.0001" min="0.0001" required />
                                    </td>
                                    <td class="px-3 py-2 text-center">
                                        <button type="button" class="text-red-600 border border-red-600 hover:bg-red-50 focus:ring-4 focus:ring-red-300 font-medium rounded-lg text-xs px-2 py-1.5" onclick="removeMaterial(this)">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                                matIndex++;
                            }
                        }
                    </tbody>
                </table>
            </div>
            <div id="noMaterialsMessage" class="text-center text-gray-500 py-4" style="@(wo?.Materials?.Any() == true ? "display:none;" : "")">
                <i class="bi bi-box-seam text-2xl block mb-2"></i>
                No materials added. Select a BOM or click "Add Material" to add materials.
            </div>
        </div>
    </div>
    <div class="flex items-center p-4 border-t border-gray-200 rounded-b gap-2">
        <button type="button" class="text-gray-900 bg-white border border-gray-300 hover:bg-gray-100 focus:ring-4 focus:ring-gray-200 font-medium rounded-lg text-sm px-5 py-2.5" data-modal-hide="formModal">Cancel</button>
        <button type="submit" class="text-white bg-primary-600 hover:bg-primary-700 focus:ring-4 focus:ring-primary-300 font-medium rounded-lg text-sm px-5 py-2.5">
            <i class="bi bi-check-lg mr-1"></i> @(Model.IsEdit ? "Update" : "Create") Work Order
        </button>
    </div>
</form>

<script>
    var operationIndex = @(wo?.Operations?.Count ?? 0);
    var materialIndex = @(wo?.Materials?.Count ?? 0);
    var productsJson = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Products.Select(p => new { p.Id, p.Name })));

    // When BOM is selected, load its materials and set product
    function loadBomMaterials() {
        var bomSelect = document.getElementById('bomSelect');
        var bomId = bomSelect.value;
        var productSelect = document.getElementById('productSelect');

        if (bomId) {
            // Set product from BOM
            var selectedOption = bomSelect.options[bomSelect.selectedIndex];
            var productId = selectedOption.getAttribute('data-product-id');
            if (productId) {
                productSelect.value = productId;
            }

            // Load materials from BOM
            fetch('/Manufacturing/WorkOrders?handler=BomMaterials&bomId=' + bomId)
                .then(response => response.json())
                .then(data => {
                    // Clear existing materials
                    var tbody = document.getElementById('materialsBody');
                    tbody.innerHTML = '';
                    materialIndex = 0;

                    if (data.lines && data.lines.length > 0) {
                        document.getElementById('noMaterialsMessage').style.display = 'none';
                        data.lines.forEach(function(line) {
                            addMaterialWithData(line.productId, line.quantity);
                        });
                    } else {
                        document.getElementById('noMaterialsMessage').style.display = 'block';
                    }
                });
        }
    }

    function addOperation() {
        var tbody = document.getElementById('operationsBody');
        var noMessage = document.getElementById('noOperationsMessage');
        noMessage.style.display = 'none';

        var rowCount = tbody.children.length + 1;
        var row = document.createElement('tr');
        row.className = 'operation-row border-b border-gray-200';
        row.innerHTML = `
            <td class="px-3 py-2 text-center align-middle op-number">${rowCount}</td>
            <td class="px-3 py-2">
                <input type="text" name="Operations[${operationIndex}].Name" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2" required />
            </td>
            <td class="px-3 py-2">
                <input type="text" name="Operations[${operationIndex}].Workstation" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2" />
            </td>
            <td class="px-3 py-2">
                <input type="number" name="Operations[${operationIndex}].PlannedHours" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2"
                       value="1" step="0.01" min="0" />
            </td>
            <td class="px-3 py-2">
                <input type="text" name="Operations[${operationIndex}].Description" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2" />
            </td>
            <td class="px-3 py-2 text-center">
                <button type="button" class="text-red-600 border border-red-600 hover:bg-red-50 focus:ring-4 focus:ring-red-300 font-medium rounded-lg text-xs px-2 py-1.5" onclick="removeOperation(this)">
                    <i class="bi bi-trash"></i>
                </button>
            </td>
        `;
        tbody.appendChild(row);
        operationIndex++;
    }

    function removeOperation(button) {
        var row = button.closest('tr');
        row.remove();
        renumberOperations();

        var tbody = document.getElementById('operationsBody');
        if (tbody.children.length === 0) {
            document.getElementById('noOperationsMessage').style.display = 'block';
        }
    }

    function renumberOperations() {
        var rows = document.querySelectorAll('#operationsBody .operation-row');
        rows.forEach(function(row, index) {
            row.querySelector('.op-number').textContent = index + 1;
        });
    }

    function addMaterial() {
        addMaterialWithData('', 1);
    }

    function addMaterialWithData(productId, quantity) {
        var tbody = document.getElementById('materialsBody');
        var noMessage = document.getElementById('noMaterialsMessage');
        noMessage.style.display = 'none';

        var productOptions = '<option value="">Select...</option>';
        productsJson.forEach(function(p) {
            var selected = p.id === productId ? 'selected' : '';
            productOptions += '<option value="' + p.id + '" ' + selected + '>' + p.name + '</option>';
        });

        var row = document.createElement('tr');
        row.className = 'material-row border-b border-gray-200';
        row.innerHTML = `
            <td class="px-3 py-2">
                <select name="Materials[${materialIndex}].ProductId" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2" required>
                    ${productOptions}
                </select>
            </td>
            <td class="px-3 py-2">
                <input type="number" name="Materials[${materialIndex}].RequiredQuantity" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2"
                       value="${quantity}" step="0.0001" min="0.0001" required />
            </td>
            <td class="px-3 py-2 text-center">
                <button type="button" class="text-red-600 border border-red-600 hover:bg-red-50 focus:ring-4 focus:ring-red-300 font-medium rounded-lg text-xs px-2 py-1.5" onclick="removeMaterial(this)">
                    <i class="bi bi-trash"></i>
                </button>
            </td>
        `;
        tbody.appendChild(row);
        materialIndex++;
    }

    function removeMaterial(button) {
        var row = button.closest('tr');
        row.remove();

        var tbody = document.getElementById('materialsBody');
        if (tbody.children.length === 0) {
            document.getElementById('noMaterialsMessage').style.display = 'block';
        }
    }
</script>
