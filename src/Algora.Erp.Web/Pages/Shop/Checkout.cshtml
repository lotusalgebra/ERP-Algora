@page
@model Algora.Erp.Web.Pages.Shop.CheckoutModel
@{
    ViewData["Title"] = "Checkout";
    Layout = "_LayoutShop";
}

<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
    <h1 class="text-2xl font-bold text-gray-900 mb-6">Checkout</h1>

    <form id="checkoutForm" method="post">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Checkout Form -->
            <div class="lg:col-span-2">
                <!-- Contact Information -->
                <div class="bg-white rounded-lg border border-gray-200 mb-4">
                    <div class="px-6 py-4 border-b border-gray-200 bg-white">
                        <h5 class="font-semibold text-gray-900"><i class="bi bi-person mr-2"></i>Contact Information</h5>
                    </div>
                    <div class="p-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block mb-2 text-sm font-medium text-gray-900">Email Address <span class="text-red-500">*</span></label>
                                <input type="email" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5" name="Email" required>
                            </div>
                            <div>
                                <label class="block mb-2 text-sm font-medium text-gray-900">Phone Number</label>
                                <input type="tel" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5" name="Phone">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Shipping Address -->
                <div class="bg-white rounded-lg border border-gray-200 mb-4">
                    <div class="px-6 py-4 border-b border-gray-200 bg-white">
                        <h5 class="font-semibold text-gray-900"><i class="bi bi-truck mr-2"></i>Shipping Address</h5>
                    </div>
                    <div class="p-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block mb-2 text-sm font-medium text-gray-900">First Name <span class="text-red-500">*</span></label>
                                <input type="text" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5" name="FirstName" required>
                            </div>
                            <div>
                                <label class="block mb-2 text-sm font-medium text-gray-900">Last Name <span class="text-red-500">*</span></label>
                                <input type="text" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5" name="LastName" required>
                            </div>
                            <div class="md:col-span-2">
                                <label class="block mb-2 text-sm font-medium text-gray-900">Address <span class="text-red-500">*</span></label>
                                <input type="text" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5" name="Address" required placeholder="Street address">
                            </div>
                            <div class="md:col-span-2">
                                <label class="block mb-2 text-sm font-medium text-gray-900">Apartment, suite, etc. (optional)</label>
                                <input type="text" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5" name="Address2">
                            </div>
                            <div>
                                <label class="block mb-2 text-sm font-medium text-gray-900">City <span class="text-red-500">*</span></label>
                                <input type="text" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5" name="City" required>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block mb-2 text-sm font-medium text-gray-900">State/Province <span class="text-red-500">*</span></label>
                                    <input type="text" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5" name="State" required>
                                </div>
                                <div>
                                    <label class="block mb-2 text-sm font-medium text-gray-900">ZIP/Postal Code <span class="text-red-500">*</span></label>
                                    <input type="text" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5" name="PostalCode" required>
                                </div>
                            </div>
                            <div class="md:col-span-2">
                                <label class="block mb-2 text-sm font-medium text-gray-900">Country <span class="text-red-500">*</span></label>
                                <select class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5" name="Country" required>
                                    <option value="">Select country</option>
                                    <option value="US" selected>United States</option>
                                    <option value="CA">Canada</option>
                                    <option value="GB">United Kingdom</option>
                                    <option value="AU">Australia</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Shipping Method -->
                <div class="bg-white rounded-lg border border-gray-200 mb-4">
                    <div class="px-6 py-4 border-b border-gray-200 bg-white">
                        <h5 class="font-semibold text-gray-900"><i class="bi bi-box-seam mr-2"></i>Shipping Method</h5>
                    </div>
                    <div class="p-6">
                        @if (Model.ShippingMethods.Any())
                        {
                            @foreach (var method in Model.ShippingMethods)
                            {
                                <div class="flex items-center border border-gray-200 rounded-lg p-4 mb-2 hover:border-primary-500 cursor-pointer">
                                    <input class="w-4 h-4 text-primary-600 bg-gray-100 border-gray-300 focus:ring-primary-500 focus:ring-2" type="radio" name="ShippingMethodId" id="shipping_@method.Id"
                                           value="@method.Id" data-rate="@method.Rate" onchange="updateShipping(@method.Rate)"
                                           @(Model.ShippingMethods.First().Id == method.Id ? "checked" : "")>
                                    <label class="flex-1 ml-3 cursor-pointer" for="shipping_@method.Id">
                                        <div class="flex justify-between items-center">
                                            <div>
                                                <span class="font-semibold text-gray-900">@method.Name</span>
                                                @if (method.MinDeliveryDays.HasValue || method.MaxDeliveryDays.HasValue)
                                                {
                                                    <small class="text-gray-500 block">
                                                        @if (method.MinDeliveryDays.HasValue && method.MaxDeliveryDays.HasValue)
                                                        {
                                                            <text>@method.MinDeliveryDays - @method.MaxDeliveryDays business days</text>
                                                        }
                                                        else if (method.MaxDeliveryDays.HasValue)
                                                        {
                                                            <text>Up to @method.MaxDeliveryDays business days</text>
                                                        }
                                                    </small>
                                                }
                                            </div>
                                            <span class="font-semibold text-gray-900">@method.Rate.ToString("C")</span>
                                        </div>
                                    </label>
                                </div>
                            }
                        }
                        else
                        {
                            <div class="flex items-center border border-gray-200 rounded-lg p-4">
                                <input class="w-4 h-4 text-primary-600 bg-gray-100 border-gray-300 focus:ring-primary-500 focus:ring-2" type="radio" name="ShippingMethodId" id="shipping_standard"
                                       value="" checked data-rate="0" onchange="updateShipping(0)">
                                <label class="flex-1 ml-3 cursor-pointer" for="shipping_standard">
                                    <div class="flex justify-between items-center">
                                        <span class="font-semibold text-gray-900">Standard Shipping</span>
                                        <span class="font-semibold text-gray-900">FREE</span>
                                    </div>
                                </label>
                            </div>
                        }
                    </div>
                </div>

                <!-- Payment -->
                <div class="bg-white rounded-lg border border-gray-200 mb-4">
                    <div class="px-6 py-4 border-b border-gray-200 bg-white">
                        <h5 class="font-semibold text-gray-900"><i class="bi bi-credit-card mr-2"></i>Payment</h5>
                    </div>
                    <div class="p-6">
                        @if (Model.PaymentMethods.Any())
                        {
                            @foreach (var method in Model.PaymentMethods)
                            {
                                <div class="flex items-center border border-gray-200 rounded-lg p-4 mb-2 hover:border-primary-500 cursor-pointer">
                                    <input class="w-4 h-4 text-primary-600 bg-gray-100 border-gray-300 focus:ring-primary-500 focus:ring-2" type="radio" name="PaymentMethodId" id="payment_@method.Id"
                                           value="@method.Id" @(Model.PaymentMethods.First().Id == method.Id ? "checked" : "")>
                                    <label class="ml-3 font-semibold text-gray-900 cursor-pointer" for="payment_@method.Id">
                                        @method.Name
                                    </label>
                                </div>
                            }
                        }
                        else
                        {
                            <div class="flex items-center border border-gray-200 rounded-lg p-4">
                                <input class="w-4 h-4 text-primary-600 bg-gray-100 border-gray-300 focus:ring-primary-500 focus:ring-2" type="radio" name="PaymentMethodId" id="payment_cod"
                                       value="" checked>
                                <label class="ml-3 font-semibold text-gray-900 cursor-pointer" for="payment_cod">
                                    Cash on Delivery
                                </label>
                            </div>
                        }

                        <div id="cardPaymentFields" class="mt-4 hidden">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="md:col-span-2">
                                    <label class="block mb-2 text-sm font-medium text-gray-900">Card Number</label>
                                    <input type="text" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5" placeholder="1234 5678 9012 3456">
                                </div>
                                <div>
                                    <label class="block mb-2 text-sm font-medium text-gray-900">Expiry Date</label>
                                    <input type="text" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5" placeholder="MM/YY">
                                </div>
                                <div>
                                    <label class="block mb-2 text-sm font-medium text-gray-900">CVV</label>
                                    <input type="text" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5" placeholder="123">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Order Notes -->
                <div class="bg-white rounded-lg border border-gray-200 mb-4">
                    <div class="px-6 py-4 border-b border-gray-200 bg-white">
                        <h5 class="font-semibold text-gray-900"><i class="bi bi-chat-text mr-2"></i>Order Notes (Optional)</h5>
                    </div>
                    <div class="p-6">
                        <textarea class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5" name="Notes" rows="3" placeholder="Special instructions for your order..."></textarea>
                    </div>
                </div>
            </div>

            <!-- Order Summary -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-lg border border-gray-200 sticky top-24">
                    <div class="px-6 py-4 border-b border-gray-200 bg-white">
                        <h5 class="font-semibold text-gray-900">Order Summary</h5>
                    </div>
                    <div class="p-0">
                        <div id="orderItems" class="p-4">
                            <!-- Items rendered by JS -->
                        </div>
                        <div class="border-t border-gray-200 p-4">
                            <div class="flex justify-between mb-2">
                                <span class="text-gray-600">Subtotal</span>
                                <span class="text-gray-900" id="checkout_subtotal">$0.00</span>
                            </div>
                            <div class="flex justify-between mb-2">
                                <span class="text-gray-600">Shipping</span>
                                <span class="text-gray-900" id="checkout_shipping">$0.00</span>
                            </div>
                            <div class="flex justify-between mb-2 hidden" id="discountRow">
                                <span class="text-emerald-600">Discount</span>
                                <span class="text-emerald-600" id="checkout_discount">-$0.00</span>
                            </div>
                            <hr class="my-4 border-gray-200">
                            <div class="flex justify-between items-center font-bold">
                                <span class="text-gray-900">Total</span>
                                <span class="text-xl text-gray-900" id="checkout_total">$0.00</span>
                            </div>
                        </div>
                    </div>
                    <div class="px-6 py-4 border-t border-gray-200 bg-white">
                        <input type="hidden" name="CartData" id="cartDataInput">
                        <button type="submit" class="w-full inline-flex items-center justify-center px-6 py-3 text-white bg-primary-600 hover:bg-primary-700 focus:ring-4 focus:ring-primary-300 font-medium rounded-lg text-base" id="placeOrderBtn">
                            <i class="bi bi-lock mr-2"></i>Place Order
                        </button>
                        <p class="text-gray-500 text-sm text-center mt-3">
                            By placing your order, you agree to our Terms of Service and Privacy Policy
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

@section Scripts {
    <script>
        let shippingRate = @(Model.ShippingMethods.FirstOrDefault()?.Rate ?? 0);

        function renderOrderSummary() {
            const cart = JSON.parse(localStorage.getItem('cart') || '[]');
            const orderItemsDiv = document.getElementById('orderItems');

            if (cart.length === 0) {
                window.location.href = '/Shop/Cart';
                return;
            }

            let html = '';
            let subtotal = 0;

            cart.forEach(item => {
                const itemTotal = item.price * item.quantity;
                subtotal += itemTotal;

                html += `
                    <div class="flex mb-3">
                        <div class="relative mr-3" style="width: 60px;">
                            ${item.image
                                ? `<img src="${item.image}" alt="${item.name}" class="w-14 h-14 object-cover rounded-lg">`
                                : `<div class="w-14 h-14 bg-gray-100 rounded-lg flex items-center justify-center"><i class="bi bi-image text-gray-400"></i></div>`
                            }
                            <span class="absolute -top-2 -right-2 px-2 py-0.5 text-xs font-medium text-white bg-gray-500 rounded-full">${item.quantity}</span>
                        </div>
                        <div class="flex-1">
                            <div class="font-semibold text-sm text-gray-900">${item.name}</div>
                            <small class="text-gray-500">$${item.price.toFixed(2)} x ${item.quantity}</small>
                        </div>
                        <div class="font-semibold text-gray-900">$${itemTotal.toFixed(2)}</div>
                    </div>`;
            });

            orderItemsDiv.innerHTML = html;

            // Store cart data for form submission
            document.getElementById('cartDataInput').value = JSON.stringify(cart);

            updateTotals(subtotal);
        }

        function updateShipping(rate) {
            shippingRate = parseFloat(rate);
            const cart = JSON.parse(localStorage.getItem('cart') || '[]');
            const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            updateTotals(subtotal);
        }

        function updateTotals(subtotal) {
            const total = subtotal + shippingRate;

            document.getElementById('checkout_subtotal').textContent = '$' + subtotal.toFixed(2);
            document.getElementById('checkout_shipping').textContent = '$' + shippingRate.toFixed(2);
            document.getElementById('checkout_total').textContent = '$' + total.toFixed(2);
        }

        // Form submission
        document.getElementById('checkoutForm').addEventListener('submit', function(e) {
            const cart = JSON.parse(localStorage.getItem('cart') || '[]');
            if (cart.length === 0) {
                e.preventDefault();
                alert('Your cart is empty');
                return;
            }
        });

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', renderOrderSummary);
    </script>
}
