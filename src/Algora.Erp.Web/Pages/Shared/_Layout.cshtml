@using Microsoft.AspNetCore.Http
@inject IHttpContextAccessor HttpContextAccessor
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - Algora ERP</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#eef2ff',
                            100: '#e0e7ff',
                            200: '#c7d2fe',
                            300: '#a5b4fc',
                            400: '#818cf8',
                            500: '#6366f1',
                            600: '#4f46e5',
                            700: '#4338ca',
                            800: '#3730a3',
                            900: '#312e81',
                            950: '#1e1b4b'
                        }
                    }
                }
            }
        }
    </script>

    <!-- Flowbite CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.2.1/flowbite.min.css" rel="stylesheet" />

    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.css" rel="stylesheet">

    <!-- HTMX -->
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>

    <style>
        .sidebar-scrollbar::-webkit-scrollbar { width: 6px; }
        .sidebar-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .sidebar-scrollbar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 3px; }
        .sidebar-scrollbar::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.3); }
        .htmx-indicator { display: none; }
        .htmx-request .htmx-indicator { display: inline-block; }
        /* Modal backdrop styling */
        [data-modal-backdrop] { background-color: rgba(0, 0, 0, 0.5); }
        /* Ensure modals have proper backdrop when shown */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            z-index: 40;
            width: 100vw;
            height: 100vh;
            background-color: rgba(0, 0, 0, 0.5);
        }
    </style>
</head>
<body class="bg-slate-100">
    <!-- Sidebar -->
    <aside id="sidebar" class="fixed top-0 left-0 z-40 w-64 h-screen transition-transform -translate-x-full sm:translate-x-0">
        <div class="h-full overflow-y-auto bg-slate-900 sidebar-scrollbar">
            <!-- Brand -->
            <div class="px-6 py-4 border-b border-slate-800 flex items-center">
                <i class="bi bi-box-seam text-primary-400 text-2xl mr-3"></i>
                <h4 class="text-white font-bold text-lg">Algora ERP</h4>
            </div>

            <!-- Navigation -->
            <nav class="py-4 px-3">
                <!-- Main -->
                <p class="px-3 text-xs font-semibold text-slate-500 uppercase tracking-wider mb-2">Main</p>
                <a href="/Dashboard" class="flex items-center px-3 py-2.5 text-slate-300 rounded-lg hover:bg-slate-800 hover:text-white transition-colors mb-1 @(ViewContext.RouteData.Values["page"]?.ToString() == "/Dashboard/Index" ? "bg-slate-800 text-white border-l-2 border-primary-500" : "")">
                    <i class="bi bi-speedometer2 w-5 mr-3"></i>Dashboard
                </a>

                <!-- Finance -->
                <p class="px-3 text-xs font-semibold text-slate-500 uppercase tracking-wider mt-6 mb-2">Finance</p>
                <a href="/Finance/Accounts" class="flex items-center px-3 py-2.5 text-slate-300 rounded-lg hover:bg-slate-800 hover:text-white transition-colors mb-1">
                    <i class="bi bi-journal-text w-5 mr-3"></i>Chart of Accounts
                </a>
                <a href="/Finance/JournalEntries" class="flex items-center px-3 py-2.5 text-slate-300 rounded-lg hover:bg-slate-800 hover:text-white transition-colors mb-1">
                    <i class="bi bi-receipt w-5 mr-3"></i>Journal Entries
                </a>
                <a href="/Finance/Invoices" class="flex items-center px-3 py-2.5 text-slate-300 rounded-lg hover:bg-slate-800 hover:text-white transition-colors mb-1">
                    <i class="bi bi-file-earmark-text w-5 mr-3"></i>Invoices
                </a>
                <a href="/Finance/Payments" class="flex items-center px-3 py-2.5 text-slate-300 rounded-lg hover:bg-slate-800 hover:text-white transition-colors mb-1">
                    <i class="bi bi-cash-stack w-5 mr-3"></i>Payments
                </a>
                <a href="/Finance/Reports" class="flex items-center px-3 py-2.5 text-slate-300 rounded-lg hover:bg-slate-800 hover:text-white transition-colors mb-1">
                    <i class="bi bi-graph-up w-5 mr-3"></i>Financial Reports
                </a>

                <!-- HR & Payroll -->
                <p class="px-3 text-xs font-semibold text-slate-500 uppercase tracking-wider mt-6 mb-2">HR & Payroll</p>
                <a href="/HR/Employees" class="flex items-center px-3 py-2.5 text-slate-300 rounded-lg hover:bg-slate-800 hover:text-white transition-colors mb-1">
                    <i class="bi bi-people w-5 mr-3"></i>Employees
                </a>
                <a href="/HR/Departments" class="flex items-center px-3 py-2.5 text-slate-300 rounded-lg hover:bg-slate-800 hover:text-white transition-colors mb-1">
                    <i class="bi bi-diagram-3 w-5 mr-3"></i>Departments
                </a>
                <a href="/HR/Positions" class="flex items-center px-3 py-2.5 text-slate-300 rounded-lg hover:bg-slate-800 hover:text-white transition-colors mb-1">
                    <i class="bi bi-person-badge w-5 mr-3"></i>Positions
                </a>
                <a href="/HR/Attendance" class="flex items-center px-3 py-2.5 text-slate-300 rounded-lg hover:bg-slate-800 hover:text-white transition-colors mb-1">
                    <i class="bi bi-calendar-check w-5 mr-3"></i>Attendance
                </a>
                <a href="/HR/Leave" class="flex items-center px-3 py-2.5 text-slate-300 rounded-lg hover:bg-slate-800 hover:text-white transition-colors mb-1">
                    <i class="bi bi-calendar-x w-5 mr-3"></i>Leave Requests
                </a>
                <a href="/Payroll/Components" class="flex items-center px-3 py-2.5 text-slate-300 rounded-lg hover:bg-slate-800 hover:text-white transition-colors mb-1">
                    <i class="bi bi-list-ul w-5 mr-3"></i>Salary Components
                </a>
                <a href="/Payroll/Runs" class="flex items-center px-3 py-2.5 text-slate-300 rounded-lg hover:bg-slate-800 hover:text-white transition-colors mb-1">
                    <i class="bi bi-cash-stack w-5 mr-3"></i>Payroll Runs
                </a>

                <!-- Inventory -->
                <p class="px-3 text-xs font-semibold text-slate-500 uppercase tracking-wider mt-6 mb-2">Inventory</p>
                <a href="/Inventory/Products" class="flex items-center px-3 py-2.5 text-slate-300 rounded-lg hover:bg-slate-800 hover:text-white transition-colors mb-1">
                    <i class="bi bi-box w-5 mr-3"></i>Products
                </a>
                <a href="/Inventory/Warehouses" class="flex items-center px-3 py-2.5 text-slate-300 rounded-lg hover:bg-slate-800 hover:text-white transition-colors mb-1">
                    <i class="bi bi-building w-5 mr-3"></i>Warehouses
                </a>
                <a href="/Inventory/Stock" class="flex items-center px-3 py-2.5 text-slate-300 rounded-lg hover:bg-slate-800 hover:text-white transition-colors mb-1">
                    <i class="bi bi-clipboard-data w-5 mr-3"></i>Stock Levels
                </a>

                <!-- Ecommerce -->
                <p class="px-3 text-xs font-semibold text-slate-500 uppercase tracking-wider mt-6 mb-2">Ecommerce</p>
                <a href="/Ecommerce/Products" class="flex items-center px-3 py-2.5 text-slate-300 rounded-lg hover:bg-slate-800 hover:text-white transition-colors mb-1">
                    <i class="bi bi-shop w-5 mr-3"></i>Products
                </a>
                <a href="/Ecommerce/Categories" class="flex items-center px-3 py-2.5 text-slate-300 rounded-lg hover:bg-slate-800 hover:text-white transition-colors mb-1">
                    <i class="bi bi-tags w-5 mr-3"></i>Categories
                </a>
                <a href="/Ecommerce/Orders" class="flex items-center px-3 py-2.5 text-slate-300 rounded-lg hover:bg-slate-800 hover:text-white transition-colors mb-1">
                    <i class="bi bi-cart3 w-5 mr-3"></i>Web Orders
                </a>
                <a href="/Ecommerce/Customers" class="flex items-center px-3 py-2.5 text-slate-300 rounded-lg hover:bg-slate-800 hover:text-white transition-colors mb-1">
                    <i class="bi bi-people w-5 mr-3"></i>Web Customers
                </a>
                <a href="/Ecommerce/Coupons" class="flex items-center px-3 py-2.5 text-slate-300 rounded-lg hover:bg-slate-800 hover:text-white transition-colors mb-1">
                    <i class="bi bi-ticket-perforated w-5 mr-3"></i>Coupons
                </a>
                <a href="/Ecommerce/Settings" class="flex items-center px-3 py-2.5 text-slate-300 rounded-lg hover:bg-slate-800 hover:text-white transition-colors mb-1">
                    <i class="bi bi-gear w-5 mr-3"></i>Store Settings
                </a>

                <!-- Procurement -->
                <p class="px-3 text-xs font-semibold text-slate-500 uppercase tracking-wider mt-6 mb-2">Procurement</p>
                <a href="/Procurement/Suppliers" class="flex items-center px-3 py-2.5 text-slate-300 rounded-lg hover:bg-slate-800 hover:text-white transition-colors mb-1">
                    <i class="bi bi-truck w-5 mr-3"></i>Suppliers
                </a>
                <a href="/Procurement/PurchaseOrders" class="flex items-center px-3 py-2.5 text-slate-300 rounded-lg hover:bg-slate-800 hover:text-white transition-colors mb-1">
                    <i class="bi bi-cart-check w-5 mr-3"></i>Purchase Orders
                </a>
                <a href="/Procurement/GoodsReceipt" class="flex items-center px-3 py-2.5 text-slate-300 rounded-lg hover:bg-slate-800 hover:text-white transition-colors mb-1">
                    <i class="bi bi-box-arrow-in-down w-5 mr-3"></i>Goods Receipt
                </a>
                <a href="/Procurement/PurchaseInvoices" class="flex items-center px-3 py-2.5 text-slate-300 rounded-lg hover:bg-slate-800 hover:text-white transition-colors mb-1">
                    <i class="bi bi-receipt w-5 mr-3"></i>Purchase Invoices
                </a>

                <!-- Dispatch -->
                <p class="px-3 text-xs font-semibold text-slate-500 uppercase tracking-wider mt-6 mb-2">Dispatch</p>
                <a href="/Dispatch/DeliveryChallans" class="flex items-center px-3 py-2.5 text-slate-300 rounded-lg hover:bg-slate-800 hover:text-white transition-colors mb-1">
                    <i class="bi bi-truck w-5 mr-3"></i>Delivery Challans
                </a>

                <!-- Quality -->
                <p class="px-3 text-xs font-semibold text-slate-500 uppercase tracking-wider mt-6 mb-2">Quality</p>
                <a href="/Quality/Inspections" class="flex items-center px-3 py-2.5 text-slate-300 rounded-lg hover:bg-slate-800 hover:text-white transition-colors mb-1">
                    <i class="bi bi-clipboard-check w-5 mr-3"></i>Inspections
                </a>
                <a href="/Quality/Rejections" class="flex items-center px-3 py-2.5 text-slate-300 rounded-lg hover:bg-slate-800 hover:text-white transition-colors mb-1">
                    <i class="bi bi-x-circle w-5 mr-3"></i>Rejections
                </a>

                <!-- Sales & CRM -->
                <p class="px-3 text-xs font-semibold text-slate-500 uppercase tracking-wider mt-6 mb-2">Sales & CRM</p>
                <a href="/Sales/Customers" class="flex items-center px-3 py-2.5 text-slate-300 rounded-lg hover:bg-slate-800 hover:text-white transition-colors mb-1">
                    <i class="bi bi-person-badge w-5 mr-3"></i>Customers
                </a>
                <a href="/Sales/Leads" class="flex items-center px-3 py-2.5 text-slate-300 rounded-lg hover:bg-slate-800 hover:text-white transition-colors mb-1">
                    <i class="bi bi-funnel w-5 mr-3"></i>Leads
                </a>
                <a href="/Sales/Quotations" class="flex items-center px-3 py-2.5 text-slate-300 rounded-lg hover:bg-slate-800 hover:text-white transition-colors mb-1">
                    <i class="bi bi-file-earmark-text w-5 mr-3"></i>Quotations
                </a>
                <a href="/Sales/Orders" class="flex items-center px-3 py-2.5 text-slate-300 rounded-lg hover:bg-slate-800 hover:text-white transition-colors mb-1">
                    <i class="bi bi-bag-check w-5 mr-3"></i>Sales Orders
                </a>

                <!-- Manufacturing -->
                <p class="px-3 text-xs font-semibold text-slate-500 uppercase tracking-wider mt-6 mb-2">Manufacturing</p>
                <a href="/Manufacturing/BOM" class="flex items-center px-3 py-2.5 text-slate-300 rounded-lg hover:bg-slate-800 hover:text-white transition-colors mb-1">
                    <i class="bi bi-list-nested w-5 mr-3"></i>Bill of Materials
                </a>
                <a href="/Manufacturing/WorkOrders" class="flex items-center px-3 py-2.5 text-slate-300 rounded-lg hover:bg-slate-800 hover:text-white transition-colors mb-1">
                    <i class="bi bi-gear w-5 mr-3"></i>Work Orders
                </a>

                <!-- Projects -->
                <p class="px-3 text-xs font-semibold text-slate-500 uppercase tracking-wider mt-6 mb-2">Projects</p>
                <a href="/Projects" class="flex items-center px-3 py-2.5 text-slate-300 rounded-lg hover:bg-slate-800 hover:text-white transition-colors mb-1">
                    <i class="bi bi-kanban w-5 mr-3"></i>Projects
                </a>
                <a href="/Projects/TimeTracking" class="flex items-center px-3 py-2.5 text-slate-300 rounded-lg hover:bg-slate-800 hover:text-white transition-colors mb-1">
                    <i class="bi bi-stopwatch w-5 mr-3"></i>Time Tracking
                </a>

                <!-- Reports -->
                <p class="px-3 text-xs font-semibold text-slate-500 uppercase tracking-wider mt-6 mb-2">Reports</p>
                <a href="/Reports/Cancellations" class="flex items-center px-3 py-2.5 text-slate-300 rounded-lg hover:bg-slate-800 hover:text-white transition-colors mb-1">
                    <i class="bi bi-x-octagon w-5 mr-3"></i>Cancellations
                </a>

                <!-- Settings -->
                <p class="px-3 text-xs font-semibold text-slate-500 uppercase tracking-wider mt-6 mb-2">Settings</p>
                <a href="/Settings/Currencies" class="flex items-center px-3 py-2.5 text-slate-300 rounded-lg hover:bg-slate-800 hover:text-white transition-colors mb-1">
                    <i class="bi bi-currency-exchange w-5 mr-3"></i>Currencies
                </a>
                <a href="/Settings/Locations" class="flex items-center px-3 py-2.5 text-slate-300 rounded-lg hover:bg-slate-800 hover:text-white transition-colors mb-1">
                    <i class="bi bi-geo-alt w-5 mr-3"></i>Office Locations
                </a>
                <a href="/Settings/GstSlabs" class="flex items-center px-3 py-2.5 text-slate-300 rounded-lg hover:bg-slate-800 hover:text-white transition-colors mb-1">
                    <i class="bi bi-percent w-5 mr-3"></i>GST Slabs
                </a>

                <!-- Administration -->
                <p class="px-3 text-xs font-semibold text-slate-500 uppercase tracking-wider mt-6 mb-2">Administration</p>
                <a href="/Admin/Users" class="flex items-center px-3 py-2.5 text-slate-300 rounded-lg hover:bg-slate-800 hover:text-white transition-colors mb-1">
                    <i class="bi bi-person-gear w-5 mr-3"></i>Users
                </a>
                <a href="/Admin/Roles" class="flex items-center px-3 py-2.5 text-slate-300 rounded-lg hover:bg-slate-800 hover:text-white transition-colors mb-1">
                    <i class="bi bi-shield-lock w-5 mr-3"></i>Roles & Permissions
                </a>
                <a href="/Admin/Settings" class="flex items-center px-3 py-2.5 text-slate-300 rounded-lg hover:bg-slate-800 hover:text-white transition-colors mb-1">
                    <i class="bi bi-sliders w-5 mr-3"></i>Settings
                </a>
                <a href="/Admin/Integrations" class="flex items-center px-3 py-2.5 text-slate-300 rounded-lg hover:bg-slate-800 hover:text-white transition-colors mb-1">
                    <i class="bi bi-plug w-5 mr-3"></i>Integrations
                </a>
            </nav>
        </div>
    </aside>

    <!-- Main Content -->
    <div class="sm:ml-64">
        <!-- Top Header -->
        <header class="sticky top-0 z-30 bg-white border-b border-gray-200">
            <div class="flex items-center justify-between px-6 py-3">
                <div class="flex items-center">
                    <!-- Mobile menu button -->
                    <button type="button" onclick="document.getElementById('sidebar').classList.toggle('-translate-x-full')"
                            class="inline-flex items-center p-2 text-gray-500 rounded-lg sm:hidden hover:bg-gray-100">
                        <i class="bi bi-list text-xl"></i>
                    </button>
                    <!-- Search -->
                    <div class="relative hidden md:block ml-4">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <i class="bi bi-search text-gray-400"></i>
                        </div>
                        <input type="search" placeholder="Search..."
                               class="pl-10 pr-4 py-2 bg-gray-50 border border-gray-300 rounded-lg text-sm focus:ring-primary-500 focus:border-primary-500 w-72" />
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <!-- Notifications -->
                    <button class="relative p-2 text-gray-500 hover:bg-gray-100 rounded-lg">
                        <i class="bi bi-bell text-xl"></i>
                        <span class="absolute top-0 right-0 w-5 h-5 bg-red-500 text-white text-xs rounded-full flex items-center justify-center">3</span>
                    </button>
                    <!-- User dropdown -->
                    <div>
                        <button id="userDropdownButton" data-dropdown-toggle="userDropdown"
                                class="flex items-center gap-2 px-3 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded-lg">
                            <div class="w-8 h-8 bg-primary-600 text-white rounded-full flex items-center justify-center">
                                <i class="bi bi-person"></i>
                            </div>
                            <span class="hidden md:inline font-medium">Admin User</span>
                            <i class="bi bi-chevron-down text-xs"></i>
                        </button>
                        <div id="userDropdown" class="z-50 hidden bg-white divide-y divide-gray-100 rounded-lg shadow-lg w-48 border border-gray-200">
                            <ul class="py-2 text-sm text-gray-700">
                                <li><a href="/Account/Profile" class="flex items-center px-4 py-2 hover:bg-gray-100"><i class="bi bi-person mr-3"></i>Profile</a></li>
                                <li><a href="/Admin/Settings" class="flex items-center px-4 py-2 hover:bg-gray-100"><i class="bi bi-gear mr-3"></i>Settings</a></li>
                            </ul>
                            <div class="py-2">
                                <a href="/Account/Logout" class="flex items-center px-4 py-2 text-sm text-red-600 hover:bg-red-50">
                                    <i class="bi bi-box-arrow-right mr-3"></i>Logout
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Page Content -->
        <main class="p-6">
            @RenderBody()
        </main>
    </div>

    <!-- Flowbite JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.2.1/flowbite.min.js"></script>

    <!-- Modal backdrop and Flowbite re-initialization -->
    <script>
        // Re-initialize Flowbite after HTMX content swaps
        document.body.addEventListener('htmx:afterSwap', function(evt) {
            if (typeof initFlowbite === 'function') {
                initFlowbite();
            }
        });
        document.body.addEventListener('htmx:afterSettle', function(evt) {
            if (typeof initFlowbite === 'function') {
                initFlowbite();
            }
        });

        // Create backdrop element
        function createBackdrop() {
            let backdrop = document.getElementById('modal-backdrop');
            if (!backdrop) {
                backdrop = document.createElement('div');
                backdrop.id = 'modal-backdrop';
                backdrop.className = 'fixed inset-0 z-40 bg-gray-900 bg-opacity-50 hidden';
                document.body.appendChild(backdrop);
            }
            return backdrop;
        }

        // Show backdrop when any modal opens
        document.addEventListener('click', function(e) {
            const target = e.target.closest('[data-modal-toggle]');
            if (target) {
                const backdrop = createBackdrop();
                backdrop.classList.remove('hidden');
            }
        });

        // Hide backdrop when modal closes
        document.addEventListener('click', function(e) {
            const target = e.target.closest('[data-modal-hide]');
            if (target) {
                const backdrop = document.getElementById('modal-backdrop');
                if (backdrop) backdrop.classList.add('hidden');
            }
        });

        // Also handle escape key to hide backdrop
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const backdrop = document.getElementById('modal-backdrop');
                if (backdrop) backdrop.classList.add('hidden');
            }
        });

        // Handle Flowbite modal show/hide events
        document.addEventListener('DOMContentLoaded', function() {
            // Watch for modal visibility changes
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                        const target = mutation.target;
                        if (target.hasAttribute('tabindex') && target.id) {
                            const backdrop = createBackdrop();
                            if (target.classList.contains('hidden')) {
                                backdrop.classList.add('hidden');
                            } else {
                                backdrop.classList.remove('hidden');
                            }
                        }
                    }
                });
            });

            // Observe all modals
            document.querySelectorAll('[tabindex="-1"][id]').forEach(function(modal) {
                observer.observe(modal, { attributes: true });
            });

            // Re-observe after HTMX updates
            document.body.addEventListener('htmx:afterSettle', function() {
                document.querySelectorAll('[tabindex="-1"][id]').forEach(function(modal) {
                    observer.observe(modal, { attributes: true });
                });
            });
        });
    </script>
    @await RenderSectionAsync("Scripts", required: false)
</body>
</html>
