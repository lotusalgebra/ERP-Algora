@model Algora.Erp.Web.Pages.Procurement.PurchaseOrders.PurchaseOrderFormViewModel
@using Algora.Erp.Domain.Entities.Procurement

<form hx-post=""
      hx-target="#ordersTableBody"
      hx-on::after-request="if(event.detail.successful) document.body.dispatchEvent(new Event('formSubmitSuccess'))">

    @if (Model.IsEdit && Model.PurchaseOrder != null)
    {
        <input type="hidden" name="Id" value="@Model.PurchaseOrder.Id" />
    }

    <div class="grid grid-cols-12 gap-3">
        <!-- Order Information -->
        <div class="col-span-12">
            <h6 class="text-gray-500 uppercase text-xs mb-3">Order Information</h6>
        </div>

        <div class="col-span-12 md:col-span-6">
            <label class="block mb-2 text-sm font-medium text-gray-900">Supplier <span class="text-red-500">*</span></label>
            <select class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5" name="SupplierId" required>
                <option value="">-- Select Supplier --</option>
                @foreach (var supplier in Model.Suppliers)
                {
                    <option value="@supplier.Id" selected="@(Model.PurchaseOrder?.SupplierId == supplier.Id)">
                        @supplier.Name (@supplier.Code)
                    </option>
                }
            </select>
        </div>

        <div class="col-span-12 md:col-span-6">
            <label class="block mb-2 text-sm font-medium text-gray-900">Warehouse</label>
            <select class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5" name="WarehouseId">
                <option value="">-- Select Warehouse --</option>
                @foreach (var warehouse in Model.Warehouses)
                {
                    <option value="@warehouse.Id" selected="@(Model.PurchaseOrder?.WarehouseId == warehouse.Id)">
                        @warehouse.Name (@warehouse.Code)
                    </option>
                }
            </select>
        </div>

        <div class="col-span-12 md:col-span-4">
            <label class="block mb-2 text-sm font-medium text-gray-900">Order Date</label>
            <input type="date" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5" name="OrderDate"
                   value="@(Model.PurchaseOrder?.OrderDate.ToString("yyyy-MM-dd") ?? DateTime.Today.ToString("yyyy-MM-dd"))">
        </div>

        <div class="col-span-12 md:col-span-4">
            <label class="block mb-2 text-sm font-medium text-gray-900">Due Date</label>
            <input type="date" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5" name="DueDate"
                   value="@Model.PurchaseOrder?.DueDate?.ToString("yyyy-MM-dd")">
        </div>

        <div class="col-span-12 md:col-span-4">
            <label class="block mb-2 text-sm font-medium text-gray-900">Expected Delivery</label>
            <input type="date" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5" name="ExpectedDeliveryDate"
                   value="@Model.PurchaseOrder?.ExpectedDeliveryDate?.ToString("yyyy-MM-dd")">
        </div>

        <div class="col-span-12 md:col-span-6">
            <label class="block mb-2 text-sm font-medium text-gray-900">Reference</label>
            <input type="text" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5" name="Reference"
                   value="@Model.PurchaseOrder?.Reference" placeholder="e.g., Quote #, Contract #">
        </div>

        <div class="col-span-12 md:col-span-6">
            <label class="block mb-2 text-sm font-medium text-gray-900">Currency</label>
            <select class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5" name="Currency">
                <option value="USD" selected="@(Model.PurchaseOrder?.Currency == "USD")">USD</option>
                <option value="EUR" selected="@(Model.PurchaseOrder?.Currency == "EUR")">EUR</option>
                <option value="GBP" selected="@(Model.PurchaseOrder?.Currency == "GBP")">GBP</option>
            </select>
        </div>

        <!-- Order Lines -->
        <div class="col-span-12 mt-4">
            <div class="flex justify-between items-center mb-3">
                <h6 class="text-gray-500 uppercase text-xs">Order Items</h6>
                <button type="button" class="text-primary-700 hover:text-white border border-primary-700 hover:bg-primary-800 focus:ring-4 focus:outline-none focus:ring-primary-300 font-medium rounded-lg text-xs px-3 py-2" onclick="addLine()">
                    <i class="bi bi-plus-lg mr-1"></i>Add Item
                </button>
            </div>
        </div>

        <div class="col-span-12">
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left" id="linesTable">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                        <tr>
                            <th class="px-3 py-2" style="width: 35%">Product</th>
                            <th class="px-3 py-2" style="width: 10%">Qty</th>
                            <th class="px-3 py-2" style="width: 15%">Unit Price</th>
                            <th class="px-3 py-2" style="width: 10%">Disc %</th>
                            <th class="px-3 py-2" style="width: 10%">Tax %</th>
                            <th class="px-3 py-2" style="width: 15%">Total</th>
                            <th class="px-3 py-2" style="width: 5%"></th>
                        </tr>
                    </thead>
                    <tbody id="linesBody">
                        @if (Model.PurchaseOrder?.Lines != null && Model.PurchaseOrder.Lines.Any())
                        {
                            var idx = 0;
                            foreach (var line in Model.PurchaseOrder.Lines.OrderBy(l => l.LineNumber))
                            {
                                <tr class="line-row border-b">
                                    <td class="px-3 py-2">
                                        <select class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2" name="Lines[@idx].ProductId" onchange="updateLineTotal(this)" required>
                                            <option value="">Select...</option>
                                            @foreach (var product in Model.Products)
                                            {
                                                <option value="@product.Id"
                                                        data-price="@product.CostPrice"
                                                        data-tax="@product.TaxRate"
                                                        selected="@(line.ProductId == product.Id)">
                                                    @product.Name (@product.Sku)
                                                </option>
                                            }
                                        </select>
                                    </td>
                                    <td class="px-3 py-2"><input type="number" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2" name="Lines[@idx].Quantity" value="@line.Quantity" min="0.01" step="0.01" onchange="updateLineTotal(this)"></td>
                                    <td class="px-3 py-2"><input type="number" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2" name="Lines[@idx].UnitPrice" value="@line.UnitPrice" min="0" step="0.01" onchange="updateLineTotal(this)"></td>
                                    <td class="px-3 py-2"><input type="number" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2" name="Lines[@idx].DiscountPercent" value="@line.DiscountPercent" min="0" max="100" step="0.01" onchange="updateLineTotal(this)"></td>
                                    <td class="px-3 py-2"><input type="number" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2" name="Lines[@idx].TaxPercent" value="@line.TaxPercent" min="0" max="100" step="0.01" onchange="updateLineTotal(this)"></td>
                                    <td class="px-3 py-2 line-total font-medium">@line.LineTotal.ToString("C2")</td>
                                    <td class="px-3 py-2"><button type="button" class="text-red-700 hover:text-white border border-red-700 hover:bg-red-800 focus:ring-4 focus:outline-none focus:ring-red-300 font-medium rounded-lg text-xs px-2 py-1" onclick="removeLine(this)"><i class="bi bi-trash"></i></button></td>
                                </tr>
                                idx++;
                            }
                        }
                        else
                        {
                            <tr class="line-row border-b">
                                <td class="px-3 py-2">
                                    <select class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2" name="Lines[0].ProductId" onchange="updateLineTotal(this)" required>
                                        <option value="">Select...</option>
                                        @foreach (var product in Model.Products)
                                        {
                                            <option value="@product.Id" data-price="@product.CostPrice" data-tax="@product.TaxRate">
                                                @product.Name (@product.Sku)
                                            </option>
                                        }
                                    </select>
                                </td>
                                <td class="px-3 py-2"><input type="number" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2" name="Lines[0].Quantity" value="1" min="0.01" step="0.01" onchange="updateLineTotal(this)"></td>
                                <td class="px-3 py-2"><input type="number" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2" name="Lines[0].UnitPrice" value="0" min="0" step="0.01" onchange="updateLineTotal(this)"></td>
                                <td class="px-3 py-2"><input type="number" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2" name="Lines[0].DiscountPercent" value="0" min="0" max="100" step="0.01" onchange="updateLineTotal(this)"></td>
                                <td class="px-3 py-2"><input type="number" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2" name="Lines[0].TaxPercent" value="0" min="0" max="100" step="0.01" onchange="updateLineTotal(this)"></td>
                                <td class="px-3 py-2 line-total font-medium">$0.00</td>
                                <td class="px-3 py-2"><button type="button" class="text-red-700 hover:text-white border border-red-700 hover:bg-red-800 focus:ring-4 focus:outline-none focus:ring-red-300 font-medium rounded-lg text-xs px-2 py-1" onclick="removeLine(this)"><i class="bi bi-trash"></i></button></td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Totals -->
        <div class="col-span-12 md:col-span-6">
            <label class="block mb-2 text-sm font-medium text-gray-900">Notes</label>
            <textarea class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5" name="Notes" rows="3">@Model.PurchaseOrder?.Notes</textarea>
        </div>

        <div class="col-span-12 md:col-span-6">
            <div class="bg-gray-50 p-4 rounded-lg">
                <div class="flex justify-between mb-2">
                    <span class="text-gray-700">Subtotal:</span>
                    <span id="subtotal">$0.00</span>
                </div>
                <div class="flex justify-between mb-2">
                    <span class="text-gray-700">Tax:</span>
                    <span id="taxTotal">$0.00</span>
                </div>
                <div class="flex justify-between mb-2 items-center">
                    <span class="text-gray-700">Shipping:</span>
                    <input type="number" class="bg-white border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 w-1/2 p-2" name="ShippingAmount"
                           value="@(Model.PurchaseOrder?.ShippingAmount ?? 0)" min="0" step="0.01" onchange="updateTotals()">
                </div>
                <div class="flex justify-between mb-2 items-center">
                    <span class="text-gray-700">Discount:</span>
                    <input type="number" class="bg-white border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 w-1/2 p-2" name="DiscountAmount"
                           value="@(Model.PurchaseOrder?.DiscountAmount ?? 0)" min="0" step="0.01" onchange="updateTotals()">
                </div>
                <hr class="my-2 border-gray-300">
                <div class="flex justify-between font-bold text-lg">
                    <span>Total:</span>
                    <span id="grandTotal">$0.00</span>
                </div>
            </div>
        </div>
    </div>

    <div class="flex items-center p-4 border-t border-gray-200 rounded-b gap-2 mt-4 px-0 pb-0">
        <button type="button" class="text-gray-900 bg-white border border-gray-300 hover:bg-gray-100 focus:ring-4 focus:ring-gray-200 font-medium rounded-lg text-sm px-5 py-2.5" onclick="closeModal('formModal')">Cancel</button>
        <button type="submit" class="text-white bg-primary-600 hover:bg-primary-700 focus:ring-4 focus:ring-primary-300 font-medium rounded-lg text-sm px-5 py-2.5">
            @(Model.IsEdit ? "Update Order" : "Create Order")
        </button>
    </div>
</form>

<script>
    let lineIndex = document.querySelectorAll('.line-row').length;

    function addLine() {
        const tbody = document.getElementById('linesBody');
        const productOptions = document.querySelector('select[name="Lines[0].ProductId"]').innerHTML;

        const row = document.createElement('tr');
        row.className = 'line-row border-b';
        row.innerHTML = `
            <td class="px-3 py-2"><select class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2" name="Lines[${lineIndex}].ProductId" onchange="updateLineTotal(this)" required>${productOptions}</select></td>
            <td class="px-3 py-2"><input type="number" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2" name="Lines[${lineIndex}].Quantity" value="1" min="0.01" step="0.01" onchange="updateLineTotal(this)"></td>
            <td class="px-3 py-2"><input type="number" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2" name="Lines[${lineIndex}].UnitPrice" value="0" min="0" step="0.01" onchange="updateLineTotal(this)"></td>
            <td class="px-3 py-2"><input type="number" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2" name="Lines[${lineIndex}].DiscountPercent" value="0" min="0" max="100" step="0.01" onchange="updateLineTotal(this)"></td>
            <td class="px-3 py-2"><input type="number" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2" name="Lines[${lineIndex}].TaxPercent" value="0" min="0" max="100" step="0.01" onchange="updateLineTotal(this)"></td>
            <td class="px-3 py-2 line-total font-medium">$0.00</td>
            <td class="px-3 py-2"><button type="button" class="text-red-700 hover:text-white border border-red-700 hover:bg-red-800 focus:ring-4 focus:outline-none focus:ring-red-300 font-medium rounded-lg text-xs px-2 py-1" onclick="removeLine(this)"><i class="bi bi-trash"></i></button></td>
        `;
        tbody.appendChild(row);
        lineIndex++;
    }

    function removeLine(btn) {
        const row = btn.closest('tr');
        if (document.querySelectorAll('.line-row').length > 1) {
            row.remove();
            updateTotals();
        }
    }

    function updateLineTotal(input) {
        const row = input.closest('tr');
        const productSelect = row.querySelector('select');
        const qtyInput = row.querySelectorAll('input')[0];
        const priceInput = row.querySelectorAll('input')[1];
        const discInput = row.querySelectorAll('input')[2];
        const taxInput = row.querySelectorAll('input')[3];

        // Auto-fill price and tax from product selection
        if (input === productSelect) {
            const option = productSelect.selectedOptions[0];
            if (option && option.dataset.price) {
                priceInput.value = option.dataset.price;
            }
            if (option && option.dataset.tax) {
                taxInput.value = option.dataset.tax;
            }
        }

        const qty = parseFloat(qtyInput.value) || 0;
        const price = parseFloat(priceInput.value) || 0;
        const disc = parseFloat(discInput.value) || 0;
        const tax = parseFloat(taxInput.value) || 0;

        const subtotal = qty * price * (1 - disc / 100);
        const taxAmount = subtotal * tax / 100;
        const total = subtotal + taxAmount;

        row.querySelector('.line-total').textContent = '$' + total.toFixed(2);
        updateTotals();
    }

    function updateTotals() {
        let subtotal = 0;
        let taxTotal = 0;

        document.querySelectorAll('.line-row').forEach(row => {
            const qtyInput = row.querySelectorAll('input')[0];
            const priceInput = row.querySelectorAll('input')[1];
            const discInput = row.querySelectorAll('input')[2];
            const taxInput = row.querySelectorAll('input')[3];

            const qty = parseFloat(qtyInput.value) || 0;
            const price = parseFloat(priceInput.value) || 0;
            const disc = parseFloat(discInput.value) || 0;
            const tax = parseFloat(taxInput.value) || 0;

            const lineSubtotal = qty * price * (1 - disc / 100);
            subtotal += lineSubtotal;
            taxTotal += lineSubtotal * tax / 100;
        });

        const shipping = parseFloat(document.querySelector('input[name="ShippingAmount"]').value) || 0;
        const discount = parseFloat(document.querySelector('input[name="DiscountAmount"]').value) || 0;
        const grandTotal = subtotal + taxTotal + shipping - discount;

        document.getElementById('subtotal').textContent = '$' + subtotal.toFixed(2);
        document.getElementById('taxTotal').textContent = '$' + taxTotal.toFixed(2);
        document.getElementById('grandTotal').textContent = '$' + grandTotal.toFixed(2);
    }

    // Initialize totals on load
    updateTotals();
</script>
