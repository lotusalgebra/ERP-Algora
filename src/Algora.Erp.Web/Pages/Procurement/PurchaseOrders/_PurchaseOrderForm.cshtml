@model Algora.Erp.Web.Pages.Procurement.PurchaseOrders.PurchaseOrderFormViewModel
@using Algora.Erp.Domain.Entities.Procurement

<form hx-post=""
      hx-target="#ordersTableBody"
      hx-on::after-request="if(event.detail.successful) document.body.dispatchEvent(new Event('formSubmitSuccess'))">

    @if (Model.IsEdit && Model.PurchaseOrder != null)
    {
        <input type="hidden" name="Id" value="@Model.PurchaseOrder.Id" />
    }

    <div class="row g-3">
        <!-- Order Information -->
        <div class="col-12">
            <h6 class="text-muted text-uppercase small mb-3">Order Information</h6>
        </div>

        <div class="col-md-6">
            <label class="form-label">Supplier <span class="text-danger">*</span></label>
            <select class="form-select" name="SupplierId" required>
                <option value="">-- Select Supplier --</option>
                @foreach (var supplier in Model.Suppliers)
                {
                    <option value="@supplier.Id" selected="@(Model.PurchaseOrder?.SupplierId == supplier.Id)">
                        @supplier.Name (@supplier.Code)
                    </option>
                }
            </select>
        </div>

        <div class="col-md-6">
            <label class="form-label">Warehouse</label>
            <select class="form-select" name="WarehouseId">
                <option value="">-- Select Warehouse --</option>
                @foreach (var warehouse in Model.Warehouses)
                {
                    <option value="@warehouse.Id" selected="@(Model.PurchaseOrder?.WarehouseId == warehouse.Id)">
                        @warehouse.Name (@warehouse.Code)
                    </option>
                }
            </select>
        </div>

        <div class="col-md-4">
            <label class="form-label">Order Date</label>
            <input type="date" class="form-control" name="OrderDate"
                   value="@(Model.PurchaseOrder?.OrderDate.ToString("yyyy-MM-dd") ?? DateTime.Today.ToString("yyyy-MM-dd"))">
        </div>

        <div class="col-md-4">
            <label class="form-label">Due Date</label>
            <input type="date" class="form-control" name="DueDate"
                   value="@Model.PurchaseOrder?.DueDate?.ToString("yyyy-MM-dd")">
        </div>

        <div class="col-md-4">
            <label class="form-label">Expected Delivery</label>
            <input type="date" class="form-control" name="ExpectedDeliveryDate"
                   value="@Model.PurchaseOrder?.ExpectedDeliveryDate?.ToString("yyyy-MM-dd")">
        </div>

        <div class="col-md-6">
            <label class="form-label">Reference</label>
            <input type="text" class="form-control" name="Reference"
                   value="@Model.PurchaseOrder?.Reference" placeholder="e.g., Quote #, Contract #">
        </div>

        <div class="col-md-6">
            <label class="form-label">Currency</label>
            <select class="form-select" name="Currency">
                <option value="USD" selected="@(Model.PurchaseOrder?.Currency == "USD")">USD</option>
                <option value="EUR" selected="@(Model.PurchaseOrder?.Currency == "EUR")">EUR</option>
                <option value="GBP" selected="@(Model.PurchaseOrder?.Currency == "GBP")">GBP</option>
            </select>
        </div>

        <!-- Order Lines -->
        <div class="col-12 mt-4">
            <h6 class="text-muted text-uppercase small mb-3">
                Order Items
                <button type="button" class="btn btn-sm btn-outline-primary float-end" onclick="addLine()">
                    <i class="bi bi-plus-lg me-1"></i>Add Item
                </button>
            </h6>
        </div>

        <div class="col-12">
            <div class="table-responsive">
                <table class="table table-sm" id="linesTable">
                    <thead class="bg-light">
                        <tr>
                            <th style="width: 35%">Product</th>
                            <th style="width: 10%">Qty</th>
                            <th style="width: 15%">Unit Price</th>
                            <th style="width: 10%">Disc %</th>
                            <th style="width: 10%">Tax %</th>
                            <th style="width: 15%">Total</th>
                            <th style="width: 5%"></th>
                        </tr>
                    </thead>
                    <tbody id="linesBody">
                        @if (Model.PurchaseOrder?.Lines != null && Model.PurchaseOrder.Lines.Any())
                        {
                            var idx = 0;
                            foreach (var line in Model.PurchaseOrder.Lines.OrderBy(l => l.LineNumber))
                            {
                                <tr class="line-row">
                                    <td>
                                        <select class="form-select form-select-sm" name="Lines[@idx].ProductId" onchange="updateLineTotal(this)" required>
                                            <option value="">Select...</option>
                                            @foreach (var product in Model.Products)
                                            {
                                                <option value="@product.Id"
                                                        data-price="@product.CostPrice"
                                                        data-tax="@product.TaxRate"
                                                        selected="@(line.ProductId == product.Id)">
                                                    @product.Name (@product.Sku)
                                                </option>
                                            }
                                        </select>
                                    </td>
                                    <td><input type="number" class="form-control form-control-sm" name="Lines[@idx].Quantity" value="@line.Quantity" min="0.01" step="0.01" onchange="updateLineTotal(this)"></td>
                                    <td><input type="number" class="form-control form-control-sm" name="Lines[@idx].UnitPrice" value="@line.UnitPrice" min="0" step="0.01" onchange="updateLineTotal(this)"></td>
                                    <td><input type="number" class="form-control form-control-sm" name="Lines[@idx].DiscountPercent" value="@line.DiscountPercent" min="0" max="100" step="0.01" onchange="updateLineTotal(this)"></td>
                                    <td><input type="number" class="form-control form-control-sm" name="Lines[@idx].TaxPercent" value="@line.TaxPercent" min="0" max="100" step="0.01" onchange="updateLineTotal(this)"></td>
                                    <td class="line-total fw-medium">@line.LineTotal.ToString("C2")</td>
                                    <td><button type="button" class="btn btn-sm btn-outline-danger" onclick="removeLine(this)"><i class="bi bi-trash"></i></button></td>
                                </tr>
                                idx++;
                            }
                        }
                        else
                        {
                            <tr class="line-row">
                                <td>
                                    <select class="form-select form-select-sm" name="Lines[0].ProductId" onchange="updateLineTotal(this)" required>
                                        <option value="">Select...</option>
                                        @foreach (var product in Model.Products)
                                        {
                                            <option value="@product.Id" data-price="@product.CostPrice" data-tax="@product.TaxRate">
                                                @product.Name (@product.Sku)
                                            </option>
                                        }
                                    </select>
                                </td>
                                <td><input type="number" class="form-control form-control-sm" name="Lines[0].Quantity" value="1" min="0.01" step="0.01" onchange="updateLineTotal(this)"></td>
                                <td><input type="number" class="form-control form-control-sm" name="Lines[0].UnitPrice" value="0" min="0" step="0.01" onchange="updateLineTotal(this)"></td>
                                <td><input type="number" class="form-control form-control-sm" name="Lines[0].DiscountPercent" value="0" min="0" max="100" step="0.01" onchange="updateLineTotal(this)"></td>
                                <td><input type="number" class="form-control form-control-sm" name="Lines[0].TaxPercent" value="0" min="0" max="100" step="0.01" onchange="updateLineTotal(this)"></td>
                                <td class="line-total fw-medium">$0.00</td>
                                <td><button type="button" class="btn btn-sm btn-outline-danger" onclick="removeLine(this)"><i class="bi bi-trash"></i></button></td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Totals -->
        <div class="col-md-6">
            <label class="form-label">Notes</label>
            <textarea class="form-control" name="Notes" rows="3">@Model.PurchaseOrder?.Notes</textarea>
        </div>

        <div class="col-md-6">
            <div class="bg-light p-3 rounded">
                <div class="d-flex justify-content-between mb-2">
                    <span>Subtotal:</span>
                    <span id="subtotal">$0.00</span>
                </div>
                <div class="d-flex justify-content-between mb-2">
                    <span>Tax:</span>
                    <span id="taxTotal">$0.00</span>
                </div>
                <div class="d-flex justify-content-between mb-2">
                    <span>Shipping:</span>
                    <input type="number" class="form-control form-control-sm w-50" name="ShippingAmount"
                           value="@(Model.PurchaseOrder?.ShippingAmount ?? 0)" min="0" step="0.01" onchange="updateTotals()">
                </div>
                <div class="d-flex justify-content-between mb-2">
                    <span>Discount:</span>
                    <input type="number" class="form-control form-control-sm w-50" name="DiscountAmount"
                           value="@(Model.PurchaseOrder?.DiscountAmount ?? 0)" min="0" step="0.01" onchange="updateTotals()">
                </div>
                <hr>
                <div class="d-flex justify-content-between fw-bold">
                    <span>Total:</span>
                    <span id="grandTotal">$0.00</span>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-footer px-0 pb-0 mt-4">
        <button type="button" class="btn btn-secondary" data-modal-hide="orderModal">Cancel</button>
        <button type="submit" class="btn btn-primary">
            @(Model.IsEdit ? "Update Order" : "Create Order")
        </button>
    </div>
</form>

<script>
    let lineIndex = document.querySelectorAll('.line-row').length;

    function addLine() {
        const tbody = document.getElementById('linesBody');
        const productOptions = document.querySelector('select[name="Lines[0].ProductId"]').innerHTML;

        const row = document.createElement('tr');
        row.className = 'line-row';
        row.innerHTML = `
            <td><select class="form-select form-select-sm" name="Lines[${lineIndex}].ProductId" onchange="updateLineTotal(this)" required>${productOptions}</select></td>
            <td><input type="number" class="form-control form-control-sm" name="Lines[${lineIndex}].Quantity" value="1" min="0.01" step="0.01" onchange="updateLineTotal(this)"></td>
            <td><input type="number" class="form-control form-control-sm" name="Lines[${lineIndex}].UnitPrice" value="0" min="0" step="0.01" onchange="updateLineTotal(this)"></td>
            <td><input type="number" class="form-control form-control-sm" name="Lines[${lineIndex}].DiscountPercent" value="0" min="0" max="100" step="0.01" onchange="updateLineTotal(this)"></td>
            <td><input type="number" class="form-control form-control-sm" name="Lines[${lineIndex}].TaxPercent" value="0" min="0" max="100" step="0.01" onchange="updateLineTotal(this)"></td>
            <td class="line-total fw-medium">$0.00</td>
            <td><button type="button" class="btn btn-sm btn-outline-danger" onclick="removeLine(this)"><i class="bi bi-trash"></i></button></td>
        `;
        tbody.appendChild(row);
        lineIndex++;
    }

    function removeLine(btn) {
        const row = btn.closest('tr');
        if (document.querySelectorAll('.line-row').length > 1) {
            row.remove();
            updateTotals();
        }
    }

    function updateLineTotal(input) {
        const row = input.closest('tr');
        const productSelect = row.querySelector('select');
        const qtyInput = row.querySelectorAll('input')[0];
        const priceInput = row.querySelectorAll('input')[1];
        const discInput = row.querySelectorAll('input')[2];
        const taxInput = row.querySelectorAll('input')[3];

        // Auto-fill price and tax from product selection
        if (input === productSelect) {
            const option = productSelect.selectedOptions[0];
            if (option && option.dataset.price) {
                priceInput.value = option.dataset.price;
            }
            if (option && option.dataset.tax) {
                taxInput.value = option.dataset.tax;
            }
        }

        const qty = parseFloat(qtyInput.value) || 0;
        const price = parseFloat(priceInput.value) || 0;
        const disc = parseFloat(discInput.value) || 0;
        const tax = parseFloat(taxInput.value) || 0;

        const subtotal = qty * price * (1 - disc / 100);
        const taxAmount = subtotal * tax / 100;
        const total = subtotal + taxAmount;

        row.querySelector('.line-total').textContent = '$' + total.toFixed(2);
        updateTotals();
    }

    function updateTotals() {
        let subtotal = 0;
        let taxTotal = 0;

        document.querySelectorAll('.line-row').forEach(row => {
            const qtyInput = row.querySelectorAll('input')[0];
            const priceInput = row.querySelectorAll('input')[1];
            const discInput = row.querySelectorAll('input')[2];
            const taxInput = row.querySelectorAll('input')[3];

            const qty = parseFloat(qtyInput.value) || 0;
            const price = parseFloat(priceInput.value) || 0;
            const disc = parseFloat(discInput.value) || 0;
            const tax = parseFloat(taxInput.value) || 0;

            const lineSubtotal = qty * price * (1 - disc / 100);
            subtotal += lineSubtotal;
            taxTotal += lineSubtotal * tax / 100;
        });

        const shipping = parseFloat(document.querySelector('input[name="ShippingAmount"]').value) || 0;
        const discount = parseFloat(document.querySelector('input[name="DiscountAmount"]').value) || 0;
        const grandTotal = subtotal + taxTotal + shipping - discount;

        document.getElementById('subtotal').textContent = '$' + subtotal.toFixed(2);
        document.getElementById('taxTotal').textContent = '$' + taxTotal.toFixed(2);
        document.getElementById('grandTotal').textContent = '$' + grandTotal.toFixed(2);
    }

    // Initialize totals on load
    updateTotals();
</script>
