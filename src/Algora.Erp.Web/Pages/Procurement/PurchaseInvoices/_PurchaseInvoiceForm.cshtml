@model Algora.Erp.Web.Pages.Procurement.PurchaseInvoices.PurchaseInvoiceFormViewModel

<form hx-post="?handler=" hx-target="#invoicesTableBody" hx-swap="innerHTML">
    @if (Model.IsEdit && Model.Invoice != null)
    {
        <input type="hidden" name="Id" value="@Model.Invoice.Id" />
    }

    <div class="row g-3">
        <!-- Left Column -->
        <div class="col-md-6">
            <div class="card mb-3">
                <div class="card-header bg-light">
                    <h6 class="mb-0">Invoice Information</h6>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">Supplier <span class="text-danger">*</span></label>
                        <select class="form-select" name="SupplierId" id="supplierSelect" required>
                            <option value="">-- Select Supplier --</option>
                            @foreach (var supplier in Model.Suppliers)
                            {
                                var isSelected = Model.Invoice?.SupplierId == supplier.Id ||
                                                 Model.SelectedGrn?.SupplierId == supplier.Id ||
                                                 Model.SelectedPurchaseOrder?.SupplierId == supplier.Id;
                                if (isSelected)
                                {
                                    <option value="@supplier.Id" selected>@supplier.Name</option>
                                }
                                else
                                {
                                    <option value="@supplier.Id">@supplier.Name</option>
                                }
                            }
                        </select>
                    </div>

                    @if (Model.PurchaseOrders.Any())
                    {
                        <div class="mb-3">
                            <label class="form-label">Purchase Order (Optional)</label>
                            <select class="form-select" name="PurchaseOrderId" id="poSelect" onchange="loadPoDetails(this.value)">
                                <option value="">-- No PO --</option>
                                @foreach (var po in Model.PurchaseOrders)
                                {
                                    var isSelected = Model.Invoice?.PurchaseOrderId == po.Id || Model.SelectedPurchaseOrder?.Id == po.Id;
                                    if (isSelected)
                                    {
                                        <option value="@po.Id" data-supplier="@po.SupplierId" data-total="@po.TotalAmount" selected>
                                            @po.OrderNumber - @po.Supplier?.Name (@po.TotalAmount.ToString("C2"))
                                        </option>
                                    }
                                    else
                                    {
                                        <option value="@po.Id" data-supplier="@po.SupplierId" data-total="@po.TotalAmount">
                                            @po.OrderNumber - @po.Supplier?.Name (@po.TotalAmount.ToString("C2"))
                                        </option>
                                    }
                                }
                            </select>
                        </div>
                    }

                    @if (Model.GoodsReceiptNotes.Any())
                    {
                        <div class="mb-3">
                            <label class="form-label">Goods Receipt (Optional)</label>
                            <select class="form-select" name="GrnId" id="grnSelect" onchange="loadGrnDetails(this.value)">
                                <option value="">-- No GRN --</option>
                                @foreach (var grn in Model.GoodsReceiptNotes)
                                {
                                    var isSelected = Model.SelectedGrn?.Id == grn.Id;
                                    if (isSelected)
                                    {
                                        <option value="@grn.Id" data-supplier="@grn.SupplierId" selected>
                                            @grn.GrnNumber - @grn.Supplier?.Name (@grn.GrnDate.ToString("dd MMM"))
                                        </option>
                                    }
                                    else
                                    {
                                        <option value="@grn.Id" data-supplier="@grn.SupplierId">
                                            @grn.GrnNumber - @grn.Supplier?.Name (@grn.GrnDate.ToString("dd MMM"))
                                        </option>
                                    }
                                }
                            </select>
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- Right Column -->
        <div class="col-md-6">
            <div class="card mb-3">
                <div class="card-header bg-light">
                    <h6 class="mb-0">Dates & Reference</h6>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Invoice Date <span class="text-danger">*</span></label>
                            <input type="date" class="form-control" name="InvoiceDate"
                                   value="@(Model.Invoice?.InvoiceDate.ToString("yyyy-MM-dd") ?? DateTime.Today.ToString("yyyy-MM-dd"))" required />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Due Date <span class="text-danger">*</span></label>
                            <input type="date" class="form-control" name="DueDate"
                                   value="@(Model.Invoice?.DueDate.ToString("yyyy-MM-dd") ?? DateTime.Today.AddDays(30).ToString("yyyy-MM-dd"))" required />
                        </div>
                        <div class="col-12">
                            <label class="form-label">Supplier Invoice Reference</label>
                            <input type="text" class="form-control" name="Reference"
                                   value="@Model.Invoice?.Reference"
                                   placeholder="Supplier's invoice number" />
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Line Items -->
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">Line Items</h6>
                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="addLine()">
                        <i class="bi bi-plus-lg me-1"></i>Add Line
                    </button>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-sm align-middle mb-0" id="linesTable">
                            <thead class="bg-light">
                                <tr>
                                    <th style="width: 30%;">Description</th>
                                    <th class="text-end" style="width: 12%;">Qty</th>
                                    <th style="width: 10%;">UOM</th>
                                    <th class="text-end" style="width: 15%;">Unit Price</th>
                                    <th class="text-end" style="width: 10%;">Disc %</th>
                                    <th class="text-end" style="width: 10%;">Tax %</th>
                                    <th class="text-end" style="width: 15%;">Total</th>
                                    <th style="width: 5%;"></th>
                                </tr>
                            </thead>
                            <tbody id="linesBody">
                                @if (Model.Invoice?.Lines?.Any() == true)
                                {
                                    var idx = 0;
                                    foreach (var line in Model.Invoice.Lines.Where(l => !l.IsDeleted).OrderBy(l => l.LineNumber))
                                    {
                                        <tr class="line-row">
                                            <td>
                                                <input type="hidden" name="Lines[@idx].ProductId" value="@line.ProductId" />
                                                <input type="text" class="form-control form-control-sm" name="Lines[@idx].Description"
                                                       value="@line.Description" required />
                                            </td>
                                            <td>
                                                <input type="number" class="form-control form-control-sm text-end qty-input" name="Lines[@idx].Quantity"
                                                       value="@line.Quantity" required step="0.01" min="0.01" onchange="calculateLineTotal(this)" />
                                            </td>
                                            <td>
                                                <input type="text" class="form-control form-control-sm" name="Lines[@idx].UnitOfMeasure"
                                                       value="@line.UnitOfMeasure" />
                                            </td>
                                            <td>
                                                <input type="number" class="form-control form-control-sm text-end price-input" name="Lines[@idx].UnitPrice"
                                                       value="@line.UnitPrice" required step="0.01" min="0" onchange="calculateLineTotal(this)" />
                                            </td>
                                            <td>
                                                <input type="number" class="form-control form-control-sm text-end disc-input" name="Lines[@idx].DiscountPercent"
                                                       value="@line.DiscountPercent" step="0.01" min="0" max="100" onchange="calculateLineTotal(this)" />
                                            </td>
                                            <td>
                                                <input type="number" class="form-control form-control-sm text-end tax-input" name="Lines[@idx].TaxPercent"
                                                       value="@line.TaxPercent" step="0.01" min="0" onchange="calculateLineTotal(this)" />
                                            </td>
                                            <td>
                                                <span class="line-total fw-medium">@line.LineTotal.ToString("N2")</span>
                                            </td>
                                            <td>
                                                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeLine(this)">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </td>
                                        </tr>
                                        idx++;
                                    }
                                }
                                else if (Model.SelectedGrn?.Lines?.Any() == true)
                                {
                                    var idx = 0;
                                    foreach (var line in Model.SelectedGrn.Lines.Where(l => l.AcceptedQuantity > 0).OrderBy(l => l.LineNumber))
                                    {
                                        var lineTotal = line.AcceptedQuantity * line.UnitPrice;
                                        <tr class="line-row">
                                            <td>
                                                <input type="hidden" name="Lines[@idx].ProductId" value="@line.ProductId" />
                                                <input type="text" class="form-control form-control-sm" name="Lines[@idx].Description"
                                                       value="@line.ProductName" required />
                                            </td>
                                            <td>
                                                <input type="number" class="form-control form-control-sm text-end qty-input" name="Lines[@idx].Quantity"
                                                       value="@line.AcceptedQuantity" required step="0.01" min="0.01" onchange="calculateLineTotal(this)" />
                                            </td>
                                            <td>
                                                <input type="text" class="form-control form-control-sm" name="Lines[@idx].UnitOfMeasure"
                                                       value="@line.UnitOfMeasure" />
                                            </td>
                                            <td>
                                                <input type="number" class="form-control form-control-sm text-end price-input" name="Lines[@idx].UnitPrice"
                                                       value="@line.UnitPrice" required step="0.01" min="0" onchange="calculateLineTotal(this)" />
                                            </td>
                                            <td>
                                                <input type="number" class="form-control form-control-sm text-end disc-input" name="Lines[@idx].DiscountPercent"
                                                       value="0" step="0.01" min="0" max="100" onchange="calculateLineTotal(this)" />
                                            </td>
                                            <td>
                                                <input type="number" class="form-control form-control-sm text-end tax-input" name="Lines[@idx].TaxPercent"
                                                       value="0" step="0.01" min="0" onchange="calculateLineTotal(this)" />
                                            </td>
                                            <td>
                                                <span class="line-total fw-medium">@lineTotal.ToString("N2")</span>
                                            </td>
                                            <td>
                                                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeLine(this)">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </td>
                                        </tr>
                                        idx++;
                                    }
                                }
                                else if (Model.SelectedPurchaseOrder?.Lines?.Any() == true)
                                {
                                    var idx = 0;
                                    foreach (var line in Model.SelectedPurchaseOrder.Lines.OrderBy(l => l.LineNumber))
                                    {
                                        var invoiceQty = line.QuantityReceived > 0 ? line.QuantityReceived : line.Quantity;
                                        var lineTotal = invoiceQty * line.UnitPrice;
                                        <tr class="line-row">
                                            <td>
                                                <input type="hidden" name="Lines[@idx].ProductId" value="@line.ProductId" />
                                                <input type="text" class="form-control form-control-sm" name="Lines[@idx].Description"
                                                       value="@line.ProductName" required />
                                            </td>
                                            <td>
                                                <input type="number" class="form-control form-control-sm text-end qty-input" name="Lines[@idx].Quantity"
                                                       value="@invoiceQty" required step="0.01" min="0.01" onchange="calculateLineTotal(this)" />
                                            </td>
                                            <td>
                                                <input type="text" class="form-control form-control-sm" name="Lines[@idx].UnitOfMeasure"
                                                       value="@line.UnitOfMeasure" />
                                            </td>
                                            <td>
                                                <input type="number" class="form-control form-control-sm text-end price-input" name="Lines[@idx].UnitPrice"
                                                       value="@line.UnitPrice" required step="0.01" min="0" onchange="calculateLineTotal(this)" />
                                            </td>
                                            <td>
                                                <input type="number" class="form-control form-control-sm text-end disc-input" name="Lines[@idx].DiscountPercent"
                                                       value="@line.DiscountPercent" step="0.01" min="0" max="100" onchange="calculateLineTotal(this)" />
                                            </td>
                                            <td>
                                                <input type="number" class="form-control form-control-sm text-end tax-input" name="Lines[@idx].TaxPercent"
                                                       value="@line.TaxPercent" step="0.01" min="0" onchange="calculateLineTotal(this)" />
                                            </td>
                                            <td>
                                                <span class="line-total fw-medium">@lineTotal.ToString("N2")</span>
                                            </td>
                                            <td>
                                                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeLine(this)">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </td>
                                        </tr>
                                        idx++;
                                    }
                                }
                            </tbody>
                            <tfoot class="bg-light">
                                <tr>
                                    <td colspan="6" class="text-end fw-medium">Subtotal:</td>
                                    <td class="text-end fw-medium" id="subtotal">0.00</td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td colspan="6" class="text-end">Tax:</td>
                                    <td class="text-end" id="taxTotal">0.00</td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td colspan="6" class="text-end fw-bold">Total:</td>
                                    <td class="text-end fw-bold fs-5" id="grandTotal">0.00</td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Notes -->
        <div class="col-12">
            <label class="form-label">Notes</label>
            <textarea class="form-control" name="Notes" rows="2">@Model.Invoice?.Notes</textarea>
        </div>
    </div>

    <div class="modal-footer px-0 pb-0 mt-3">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" class="btn btn-primary">
            <i class="bi bi-check-lg me-2"></i>@(Model.IsEdit ? "Update" : "Create") Invoice
        </button>
    </div>
</form>

<script>
    let lineIndex = @(Model.Invoice?.Lines?.Count(l => !l.IsDeleted) ?? Model.SelectedGrn?.Lines?.Count(l => l.AcceptedQuantity > 0) ?? Model.SelectedPurchaseOrder?.Lines?.Count ?? 0);

    function loadPoDetails(poId) {
        const select = document.getElementById('poSelect');
        const option = select.options[select.selectedIndex];
        if (option && option.value) {
            document.getElementById('supplierSelect').value = option.dataset.supplier || '';
        }
    }

    function loadGrnDetails(grnId) {
        const select = document.getElementById('grnSelect');
        const option = select.options[select.selectedIndex];
        if (option && option.value) {
            document.getElementById('supplierSelect').value = option.dataset.supplier || '';
        }
    }

    function addLine() {
        const html = `
            <tr class="line-row">
                <td>
                    <input type="hidden" name="Lines[${lineIndex}].ProductId" value="" />
                    <input type="text" class="form-control form-control-sm" name="Lines[${lineIndex}].Description" required placeholder="Description" />
                </td>
                <td>
                    <input type="number" class="form-control form-control-sm text-end qty-input" name="Lines[${lineIndex}].Quantity"
                           required step="0.01" min="0.01" value="1" onchange="calculateLineTotal(this)" />
                </td>
                <td>
                    <input type="text" class="form-control form-control-sm" name="Lines[${lineIndex}].UnitOfMeasure" value="EA" />
                </td>
                <td>
                    <input type="number" class="form-control form-control-sm text-end price-input" name="Lines[${lineIndex}].UnitPrice"
                           required step="0.01" min="0" value="0" onchange="calculateLineTotal(this)" />
                </td>
                <td>
                    <input type="number" class="form-control form-control-sm text-end disc-input" name="Lines[${lineIndex}].DiscountPercent"
                           step="0.01" min="0" max="100" value="0" onchange="calculateLineTotal(this)" />
                </td>
                <td>
                    <input type="number" class="form-control form-control-sm text-end tax-input" name="Lines[${lineIndex}].TaxPercent"
                           step="0.01" min="0" value="0" onchange="calculateLineTotal(this)" />
                </td>
                <td>
                    <span class="line-total fw-medium">0.00</span>
                </td>
                <td>
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeLine(this)">
                        <i class="bi bi-trash"></i>
                    </button>
                </td>
            </tr>
        `;
        document.getElementById('linesBody').insertAdjacentHTML('beforeend', html);
        lineIndex++;
    }

    function removeLine(btn) {
        btn.closest('tr').remove();
        reindexLines();
        calculateTotals();
    }

    function reindexLines() {
        const rows = document.querySelectorAll('#linesBody .line-row');
        rows.forEach((row, idx) => {
            row.querySelectorAll('input[name], select[name]').forEach(input => {
                const name = input.name.replace(/\[\d+\]/, `[${idx}]`);
                input.name = name;
            });
        });
        lineIndex = rows.length;
    }

    function calculateLineTotal(input) {
        const row = input.closest('tr');
        const qty = parseFloat(row.querySelector('.qty-input').value) || 0;
        const price = parseFloat(row.querySelector('.price-input').value) || 0;
        const disc = parseFloat(row.querySelector('.disc-input').value) || 0;
        const tax = parseFloat(row.querySelector('.tax-input').value) || 0;

        const lineSubtotal = qty * price;
        const discountAmt = lineSubtotal * (disc / 100);
        const taxableAmt = lineSubtotal - discountAmt;
        const taxAmt = taxableAmt * (tax / 100);
        const lineTotal = taxableAmt + taxAmt;

        row.querySelector('.line-total').textContent = lineTotal.toFixed(2);
        calculateTotals();
    }

    function calculateTotals() {
        let subtotal = 0;
        let taxTotal = 0;

        document.querySelectorAll('#linesBody .line-row').forEach(row => {
            const qty = parseFloat(row.querySelector('.qty-input').value) || 0;
            const price = parseFloat(row.querySelector('.price-input').value) || 0;
            const disc = parseFloat(row.querySelector('.disc-input').value) || 0;
            const tax = parseFloat(row.querySelector('.tax-input').value) || 0;

            const lineSubtotal = qty * price;
            const discountAmt = lineSubtotal * (disc / 100);
            const taxableAmt = lineSubtotal - discountAmt;
            const taxAmt = taxableAmt * (tax / 100);

            subtotal += taxableAmt;
            taxTotal += taxAmt;
        });

        document.getElementById('subtotal').textContent = subtotal.toFixed(2);
        document.getElementById('taxTotal').textContent = taxTotal.toFixed(2);
        document.getElementById('grandTotal').textContent = (subtotal + taxTotal).toFixed(2);
    }

    // Calculate initial totals
    document.addEventListener('DOMContentLoaded', calculateTotals);
    calculateTotals();

    // Handle form submission success
    document.querySelector('form').addEventListener('htmx:afterRequest', function(e) {
        if (e.detail.successful) {
            document.body.dispatchEvent(new CustomEvent('formSubmitSuccess'));
        }
    });
</script>
