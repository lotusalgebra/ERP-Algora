@model Algora.Erp.Web.Pages.Procurement.GoodsReceipt.GrnFormViewModel
@using Algora.Erp.Domain.Entities.Procurement

<form hx-post="?handler=" hx-target="#grnTableBody" hx-swap="innerHTML">
    @if (Model.IsEdit && Model.GoodsReceiptNote != null)
    {
        <input type="hidden" name="Id" value="@Model.GoodsReceiptNote.Id" />
    }

    <div class="row g-3">
        <!-- Left Column -->
        <div class="col-md-6">
            <div class="card mb-3">
                <div class="card-header bg-light">
                    <h6 class="mb-0">Receipt Information</h6>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">GRN Date <span class="text-danger">*</span></label>
                        <input type="date" class="form-control" name="GrnDate"
                               value="@(Model.GoodsReceiptNote?.GrnDate.ToString("yyyy-MM-dd") ?? DateTime.Today.ToString("yyyy-MM-dd"))" required />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Purchase Order</label>
                        <select class="form-select" name="PurchaseOrderId" id="purchaseOrderSelect"
                                onchange="loadPurchaseOrderLines(this.value)">
                            <option value="">-- Select PO (Optional) --</option>
                            @foreach (var po in Model.PurchaseOrders)
                            {
                                var isSelected = Model.GoodsReceiptNote?.PurchaseOrderId == po.Id || Model.SelectedPurchaseOrder?.Id == po.Id;
                                if (isSelected)
                                {
                                    <option value="@po.Id" data-supplier="@po.SupplierId" data-warehouse="@po.WarehouseId" selected>
                                        @po.OrderNumber - @po.Supplier?.Name (@po.OrderDate.ToString("dd MMM"))
                                    </option>
                                }
                                else
                                {
                                    <option value="@po.Id" data-supplier="@po.SupplierId" data-warehouse="@po.WarehouseId">
                                        @po.OrderNumber - @po.Supplier?.Name (@po.OrderDate.ToString("dd MMM"))
                                    </option>
                                }
                            }
                        </select>
                        <input type="hidden" name="PurchaseOrderNumber" id="purchaseOrderNumber"
                               value="@Model.GoodsReceiptNote?.PurchaseOrderNumber" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Supplier <span class="text-danger">*</span></label>
                        <select class="form-select" name="SupplierId" id="supplierSelect" required>
                            <option value="">-- Select Supplier --</option>
                            @foreach (var supplier in Model.Suppliers)
                            {
                                var isSelected = Model.GoodsReceiptNote?.SupplierId == supplier.Id || Model.SelectedPurchaseOrder?.SupplierId == supplier.Id;
                                if (isSelected)
                                {
                                    <option value="@supplier.Id" selected>@supplier.Name</option>
                                }
                                else
                                {
                                    <option value="@supplier.Id">@supplier.Name</option>
                                }
                            }
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Warehouse <span class="text-danger">*</span></label>
                        <select class="form-select" name="WarehouseId" id="warehouseSelect" required>
                            <option value="">-- Select Warehouse --</option>
                            @foreach (var warehouse in Model.Warehouses)
                            {
                                var isSelected = Model.GoodsReceiptNote?.WarehouseId == warehouse.Id || Model.SelectedPurchaseOrder?.WarehouseId == warehouse.Id;
                                if (isSelected)
                                {
                                    <option value="@warehouse.Id" selected>@warehouse.Name</option>
                                }
                                else
                                {
                                    <option value="@warehouse.Id">@warehouse.Name</option>
                                }
                            }
                        </select>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header bg-light">
                    <h6 class="mb-0">Supplier Invoice Details</h6>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">Supplier Invoice Number</label>
                        <input type="text" class="form-control" name="SupplierInvoiceNumber"
                               value="@Model.GoodsReceiptNote?.SupplierInvoiceNumber" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Supplier Invoice Date</label>
                        <input type="date" class="form-control" name="SupplierInvoiceDate"
                               value="@Model.GoodsReceiptNote?.SupplierInvoiceDate?.ToString("yyyy-MM-dd")" />
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column -->
        <div class="col-md-6">
            <div class="card mb-3">
                <div class="card-header bg-light">
                    <h6 class="mb-0">Transport Details</h6>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Vehicle Number</label>
                            <input type="text" class="form-control" name="VehicleNumber"
                                   value="@Model.GoodsReceiptNote?.VehicleNumber" />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Driver Name</label>
                            <input type="text" class="form-control" name="DriverName"
                                   value="@Model.GoodsReceiptNote?.DriverName" />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Transporter Name</label>
                            <input type="text" class="form-control" name="TransporterName"
                                   value="@Model.GoodsReceiptNote?.TransporterName" />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Way Bill Number</label>
                            <input type="text" class="form-control" name="WayBillNumber"
                                   value="@Model.GoodsReceiptNote?.WayBillNumber" />
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header bg-light">
                    <h6 class="mb-0">Quality Control</h6>
                </div>
                <div class="card-body">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" name="QCRequired" value="true"
                               id="qcRequiredCheck" @(Model.GoodsReceiptNote?.QCRequired == true ? "checked" : "") />
                        <label class="form-check-label" for="qcRequiredCheck">
                            QC Inspection Required
                        </label>
                    </div>
                    <small class="text-muted">
                        When enabled, GRN will be sent to Quality Control for inspection before stock is updated.
                    </small>
                </div>
            </div>
        </div>

        <!-- Line Items -->
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">Line Items</h6>
                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="addLine()">
                        <i class="bi bi-plus-lg me-1"></i>Add Line
                    </button>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-sm align-middle mb-0" id="linesTable">
                            <thead class="bg-light">
                                <tr>
                                    <th style="width: 30%;">Product</th>
                                    <th class="text-end" style="width: 12%;">Ordered</th>
                                    <th class="text-end" style="width: 12%;">Received</th>
                                    <th style="width: 8%;">UOM</th>
                                    <th class="text-end" style="width: 12%;">Unit Price</th>
                                    <th class="text-end" style="width: 12%;">Total</th>
                                    <th style="width: 5%;"></th>
                                </tr>
                            </thead>
                            <tbody id="linesBody">
                                @if (Model.GoodsReceiptNote?.Lines?.Any() == true)
                                {
                                    var idx = 0;
                                    foreach (var line in Model.GoodsReceiptNote.Lines.OrderBy(l => l.LineNumber))
                                    {
                                        <tr class="line-row">
                                            <td>
                                                <input type="hidden" name="Lines[@idx].PurchaseOrderLineId" value="@line.PurchaseOrderLineId" />
                                                <input type="hidden" name="Lines[@idx].ProductId" value="@line.ProductId" />
                                                <input type="hidden" name="Lines[@idx].ProductName" value="@line.ProductName" />
                                                <input type="hidden" name="Lines[@idx].ProductSku" value="@line.ProductSku" />
                                                <div class="fw-medium">@line.ProductName</div>
                                                <small class="text-muted">@line.ProductSku</small>
                                            </td>
                                            <td class="text-end">
                                                <input type="number" class="form-control form-control-sm text-end" name="Lines[@idx].OrderedQuantity"
                                                       value="@line.OrderedQuantity" readonly step="0.01" />
                                            </td>
                                            <td class="text-end">
                                                <input type="number" class="form-control form-control-sm text-end received-qty" name="Lines[@idx].ReceivedQuantity"
                                                       value="@line.ReceivedQuantity" required step="0.01" min="0" onchange="updateLineTotal(this)" />
                                            </td>
                                            <td>
                                                <input type="text" class="form-control form-control-sm" name="Lines[@idx].UnitOfMeasure"
                                                       value="@line.UnitOfMeasure" readonly />
                                            </td>
                                            <td class="text-end">
                                                <input type="number" class="form-control form-control-sm text-end unit-price" name="Lines[@idx].UnitPrice"
                                                       value="@line.UnitPrice" required step="0.01" min="0" onchange="updateLineTotal(this)" />
                                            </td>
                                            <td class="text-end">
                                                <span class="line-total fw-medium">@((line.ReceivedQuantity * line.UnitPrice).ToString("N2"))</span>
                                            </td>
                                            <td>
                                                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeLine(this)">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </td>
                                        </tr>
                                        idx++;
                                    }
                                }
                                else if (Model.SelectedPurchaseOrder?.Lines?.Any() == true)
                                {
                                    var idx = 0;
                                    foreach (var line in Model.SelectedPurchaseOrder.Lines.OrderBy(l => l.LineNumber))
                                    {
                                        <tr class="line-row">
                                            <td>
                                                <input type="hidden" name="Lines[@idx].PurchaseOrderLineId" value="@line.Id" />
                                                <input type="hidden" name="Lines[@idx].ProductId" value="@line.ProductId" />
                                                <input type="hidden" name="Lines[@idx].ProductName" value="@line.ProductName" />
                                                <input type="hidden" name="Lines[@idx].ProductSku" value="@line.ProductSku" />
                                                <div class="fw-medium">@line.ProductName</div>
                                                <small class="text-muted">@line.ProductSku</small>
                                            </td>
                                            <td class="text-end">
                                                <input type="number" class="form-control form-control-sm text-end" name="Lines[@idx].OrderedQuantity"
                                                       value="@line.Quantity" readonly step="0.01" />
                                            </td>
                                            <td class="text-end">
                                                <input type="number" class="form-control form-control-sm text-end received-qty" name="Lines[@idx].ReceivedQuantity"
                                                       value="@line.Quantity" required step="0.01" min="0" onchange="updateLineTotal(this)" />
                                            </td>
                                            <td>
                                                <input type="text" class="form-control form-control-sm" name="Lines[@idx].UnitOfMeasure"
                                                       value="@line.UnitOfMeasure" readonly />
                                            </td>
                                            <td class="text-end">
                                                <input type="number" class="form-control form-control-sm text-end unit-price" name="Lines[@idx].UnitPrice"
                                                       value="@line.UnitPrice" required step="0.01" min="0" onchange="updateLineTotal(this)" />
                                            </td>
                                            <td class="text-end">
                                                <span class="line-total fw-medium">@((line.Quantity * line.UnitPrice).ToString("N2"))</span>
                                            </td>
                                            <td>
                                                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeLine(this)">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </td>
                                        </tr>
                                        idx++;
                                    }
                                }
                            </tbody>
                            <tfoot class="bg-light">
                                <tr>
                                    <td colspan="5" class="text-end fw-bold">Grand Total:</td>
                                    <td class="text-end fw-bold" id="grandTotal">0.00</td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Notes -->
        <div class="col-12">
            <div class="mb-3">
                <label class="form-label">Notes</label>
                <textarea class="form-control" name="Notes" rows="2">@Model.GoodsReceiptNote?.Notes</textarea>
            </div>
        </div>
    </div>

    <div class="modal-footer px-0 pb-0">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" class="btn btn-primary">
            <i class="bi bi-check-lg me-2"></i>@(Model.IsEdit ? "Update" : "Create") GRN
        </button>
    </div>
</form>

<script>
    let lineIndex = @(Model.GoodsReceiptNote?.Lines?.Count ?? Model.SelectedPurchaseOrder?.Lines?.Count ?? 0);

    function loadPurchaseOrderLines(poId) {
        if (!poId) {
            document.getElementById('linesBody').innerHTML = '';
            document.getElementById('purchaseOrderNumber').value = '';
            calculateGrandTotal();
            return;
        }

        fetch(`?handler=PurchaseOrderLines&purchaseOrderId=${poId}`)
            .then(response => response.json())
            .then(data => {
                document.getElementById('supplierSelect').value = data.purchaseOrder.supplierId;
                if (data.purchaseOrder.warehouseId) {
                    document.getElementById('warehouseSelect').value = data.purchaseOrder.warehouseId;
                }
                document.getElementById('purchaseOrderNumber').value = data.purchaseOrder.orderNumber;

                let html = '';
                lineIndex = 0;
                data.lines.forEach((line, idx) => {
                    html += createLineRow(line, idx);
                    lineIndex++;
                });
                document.getElementById('linesBody').innerHTML = html;
                calculateGrandTotal();
            });
    }

    function createLineRow(line, idx) {
        const receivedQty = line.remainingQuantity || line.orderedQuantity || 0;
        const unitPrice = line.unitPrice || 0;
        const total = (receivedQty * unitPrice).toFixed(2);

        return `
            <tr class="line-row">
                <td>
                    <input type="hidden" name="Lines[${idx}].PurchaseOrderLineId" value="${line.purchaseOrderLineId || ''}" />
                    <input type="hidden" name="Lines[${idx}].ProductId" value="${line.productId}" />
                    <input type="hidden" name="Lines[${idx}].ProductName" value="${line.productName}" />
                    <input type="hidden" name="Lines[${idx}].ProductSku" value="${line.productSku}" />
                    <div class="fw-medium">${line.productName}</div>
                    <small class="text-muted">${line.productSku}</small>
                </td>
                <td class="text-end">
                    <input type="number" class="form-control form-control-sm text-end" name="Lines[${idx}].OrderedQuantity"
                           value="${line.orderedQuantity || 0}" readonly step="0.01" />
                </td>
                <td class="text-end">
                    <input type="number" class="form-control form-control-sm text-end received-qty" name="Lines[${idx}].ReceivedQuantity"
                           value="${receivedQty}" required step="0.01" min="0" onchange="updateLineTotal(this)" />
                </td>
                <td>
                    <input type="text" class="form-control form-control-sm" name="Lines[${idx}].UnitOfMeasure"
                           value="${line.unitOfMeasure || 'EA'}" readonly />
                </td>
                <td class="text-end">
                    <input type="number" class="form-control form-control-sm text-end unit-price" name="Lines[${idx}].UnitPrice"
                           value="${unitPrice}" required step="0.01" min="0" onchange="updateLineTotal(this)" />
                </td>
                <td class="text-end">
                    <span class="line-total fw-medium">${total}</span>
                </td>
                <td>
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeLine(this)">
                        <i class="bi bi-trash"></i>
                    </button>
                </td>
            </tr>
        `;
    }

    function addLine() {
        const html = createLineRow({
            productId: '',
            productName: '',
            productSku: '',
            orderedQuantity: 0,
            unitOfMeasure: 'EA',
            unitPrice: 0
        }, lineIndex);
        document.getElementById('linesBody').insertAdjacentHTML('beforeend', html);
        lineIndex++;
    }

    function removeLine(btn) {
        btn.closest('tr').remove();
        reindexLines();
        calculateGrandTotal();
    }

    function reindexLines() {
        const rows = document.querySelectorAll('#linesBody .line-row');
        rows.forEach((row, idx) => {
            row.querySelectorAll('input[name]').forEach(input => {
                const name = input.name.replace(/\[\d+\]/, `[${idx}]`);
                input.name = name;
            });
        });
        lineIndex = rows.length;
    }

    function updateLineTotal(input) {
        const row = input.closest('tr');
        const qty = parseFloat(row.querySelector('.received-qty').value) || 0;
        const price = parseFloat(row.querySelector('.unit-price').value) || 0;
        const total = qty * price;
        row.querySelector('.line-total').textContent = total.toFixed(2);
        calculateGrandTotal();
    }

    function calculateGrandTotal() {
        let total = 0;
        document.querySelectorAll('.line-total').forEach(el => {
            total += parseFloat(el.textContent) || 0;
        });
        document.getElementById('grandTotal').textContent = total.toFixed(2);
    }

    // Initial calculation
    calculateGrandTotal();

    // Handle form submission success
    document.querySelector('form').addEventListener('htmx:afterRequest', function(e) {
        if (e.detail.successful) {
            document.body.dispatchEvent(new CustomEvent('formSubmitSuccess'));
        }
    });
</script>
